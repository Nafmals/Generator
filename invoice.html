<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Nafithat Al-Amal - Invoice System (Local)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{margin:0;background:linear-gradient(135deg,#0f172a 0,#111827 35%,#020617 100%);padding:14px;color:#111827;}
    a{text-decoration:none;color:inherit}
    .btn{border-radius:999px;border:1px solid #e5e7eb;padding:6px 12px;font-size:11px;background:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:4px;transition:background .15s,transform .12s,box-shadow .12s;}
    .btn:hover{background:#f9fafb;transform:translateY(-1px);box-shadow:0 4px 10px rgba(15,23,42,.15);}
    .btn-primary{background:#111827;color:#fff;border-color:#111827;}
    .btn-primary:hover{background:#020617;}
    .btn-danger{background:#fef2f2;border-color:#fecaca;color:#b91c1c;}
    .btn-sm{padding:3px 8px;font-size:10px;}

    .topbar-main{max-width:1180px;margin:0 auto 14px auto;padding:8px 12px;border-radius:16px;background:rgba(248,250,252,0.98);border:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(15,23,42,.25);backdrop-filter:blur(12px);}
    .brand{display:flex;align-items:center;gap:8px;font-size:11px;}
    .brand img{height:30px;border-radius:999px;}
    .brand-info{display:flex;flex-direction:column;gap:2px;}
    .brand-name{font-weight:bold;color:#f97316;font-size:15px;}
    .brand-sub{font-size:10px;color:#6b7280;}
    .top-actions{display:flex;gap:6px;flex-wrap:wrap;}

    #app{max-width:1180px;margin:0 auto;}
    section{background:#f3f4f6;border-radius:18px;padding:10px 12px 12px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(15,23,42,.25);}

    #dashboard{margin-top:8px;}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px;}
    .dashboard-title{font-size:16px;font-weight:bold;display:flex;align-items:center;gap:6px;}
    .dashboard-title span{font-size:11px;font-weight:normal;color:#6b7280;}
    .search-box{display:flex;align-items:center;gap:6px;background:#fff;border-radius:999px;border:1px solid #e5e7eb;padding:4px 10px;min-width:240px;}
    .search-box input{border:none;outline:none;font-size:11px;width:100%;background:transparent;}

    .filters-row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;}
    .status-filters{display:flex;gap:6px;flex-wrap:wrap;}
    .status-pill{padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;font-size:10px;cursor:pointer;background:#fff;}
    .status-pill.active{background:#111827;color:#fff;border-color:#111827;}
    .filters-right{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
    .po-filter{font-size:10px;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;}

    .summary-cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-bottom:10px;}
    .card{background:#fff;border-radius:12px;border:1px solid #e5e7eb;padding:8px 10px;font-size:11px;position:relative;overflow:hidden;cursor:pointer;transition:box-shadow .12s,border-color .12s,transform .12s;}
    .card::after{content:"";position:absolute;inset:auto -40px -40px auto;width:80px;height:80px;border-radius:999px;background:radial-gradient(circle,#e5e7eb 0,transparent 60%);opacity:.8;}
    .card:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(15,23,42,.2);}
    .card.card-active{border-color:#111827;box-shadow:0 0 0 1px #111827,0 8px 18px rgba(15,23,42,.18);}
    .card-label{color:#6b7280;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;gap:4px;}
    .card-label span{font-size:9px;color:#9ca3af;}
    .card-value{font-size:14px;font-weight:bold;}
    .card-sub{font-size:10px;color:#6b7280;}

    .table-wrap{background:#fff;border-radius:12px;border:1px solid #e5e7eb;overflow:auto;max-height:460px;}
    table{width:100%;border-collapse:collapse;font-size:11px;}
    thead{background:#f9fafb;position:sticky;top:0;z-index:1;}
    th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb;white-space:nowrap;text-align:left;}
    tr:hover td{background:#eef2ff;}

    .badge{display:inline-flex;align-items:center;padding:2px 6px;border-radius:999px;font-size:10px;border:1px solid transparent;}
    .badge-paid{background:#ecfdf5;color:#166534;border-color:#bbf7d0;}
    .badge-unpaid{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe;}
    .badge-overdue{background:#fef2f2;color:#b91c1c;border-color:#fecaca;}
    .badge-draft{background:#f9fafb;color:#6b7280;border-color:#e5e7eb;}

    #editor{margin-top:8px;display:none;}

    .editor-topbar{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;}
    .editor-title{font-size:14px;font-weight:bold;}
    .editor-actions{display:flex;gap:6px;flex-wrap:wrap;}

    .invoice-page{width:800px;min-height:1120px;background:#ffffff;border-radius:6px;border:1px solid #d1d5db;padding:24px 28px;position:relative;overflow:hidden;margin:0 auto 20px auto;}
    .watermark{position:absolute;right:120px;bottom:120px;width:260px;opacity:0.06;filter:grayscale(1);pointer-events:none;z-index:0;}
    .invoice-inner{position:relative;z-index:1;font-size:11px;}

    .inv-header{display:flex;justify-content:space-between;align-items:flex-start;}
    .inv-company{max-width:320px;line-height:1.35;font-size:11px;}
    .inv-company-name{font-size:14px;font-weight:bold;color:#f97316;margin-bottom:2px;}
    .inv-company p{margin:0;font-size:10px;}
    .inv-right{text-align:right;font-size:10px;}
    .inv-logo-top img{height:60px;display:block;margin-left:auto;}
    .inv-logo-title{margin-top:4px;font-size:14px;color:#f97316;text-align:center;}
    .meta{margin-top:8px;font-size:10px;}
    .meta-row{display:flex;justify-content:flex-end;align-items:center;margin-bottom:2px;gap:4px;}
    .meta-row .label{font-weight:bold;min-width:90px;text-align:right;}
    .meta-row input{border:1px solid #000;padding:2px 4px;font-size:10px;min-width:170px;border-radius:0;}

    .bill-title-row{margin-top:12px;display:flex;justify-content:space-between;align-items:flex-end;font-size:11px;}
    .bill-to-label{font-weight:bold;margin-bottom:2px;}
    .bill-to-box{margin-top:4px;border-top:1px solid #000;padding-top:4px;font-size:10px;}
    .bill-to-textarea{width:100%;min-height:90px;border:none;padding:0;margin:0;resize:vertical;white-space:pre-wrap;font-size:10px;}
    .center-invoice-title{font-size:16px;color:#4b5563;margin-right:40px;}

    table.inv-table{border-collapse:collapse;width:100%;margin-top:10px;}
    table.inv-table th,table.inv-table td{border:1px solid #000;padding:3px 4px;font-size:10px;vertical-align:top;}
    table.inv-table thead tr:first-child th{border-bottom:none;background:#ffffff;}
    table.inv-table thead tr:nth-child(2) th{border-top:none;background:#f5f5f5;}
    .cell-input,.cell-textarea{width:100%;border:none;padding:0;margin:0;font-size:10px;background:transparent;}
    .cell-textarea{resize:vertical;min-height:26px;}
    .cell-input:focus,.cell-textarea:focus{outline:none;}

    .add-row-bar{margin-top:4px;font-size:10px;}
    .thankyou{font-size:9px;margin-top:6px;margin-bottom:6px;}

    .totals-wrap{display:flex;justify-content:flex-end;}
    .totals{width:260px;border-collapse:collapse;font-size:9px;}
    .totals td{padding:2px 4px;border:1px solid #000;}
    .totals td:first-child{width:60%;text-align:right;font-weight:bold;}
    .totals td:last-child{width:40%;text-align:right;min-width:100px;}
    .totals input{width:100%;border:none;background:transparent;font-size:9px;text-align:right;padding:0;margin:0;}
    .totals input:focus{outline:none;}
    .balance{font-weight:bold;}

    .bottom-row{margin-top:18px;display:flex;justify-content:space-between;gap:20px;font-size:9px;}
    .scope-col{width:55%;}
    .scope-label{font-weight:bold;margin-bottom:4px;}
    .scope-textarea{width:100%;min-height:70px;border:none;padding:0;margin:0;white-space:pre-wrap;font-size:9px;resize:vertical;}
    .bank-col{width:38%;}
    .bank-label{font-weight:bold;margin-bottom:4px;}
    .bank-table{width:100%;border-collapse:collapse;font-size:9px;}
    .bank-table td{border:none;padding:1px 0;vertical-align:top;}
    .bank-table td:first-child{width:40%;font-weight:bold;}

    .note-block{margin-top:12px;font-size:9px;}
    .note-block textarea{width:100%;min-height:60px;border:1px solid #d1d5db;border-radius:4px;padding:4px;font-size:9px;resize:vertical;}

    .sign-row{margin-top:32px;display:flex;justify-content:flex-start;font-size:9px;}
    .sign-name{border-top:1px solid #000;padding-top:3px;width:200px;}
    .sign-name span:first-child{font-weight:bold;}

    .status-select{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb;}

    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.3);display:none;align-items:center;justify-content:center;z-index:50;}
    .modal{background:#fff;border-radius:12px;border:1px solid #e5e7eb;padding:10px 12px 12px;width:720px;max-width:95vw;max-height:80vh;display:flex;flex-direction:column;font-size:11px;box-shadow:0 20px 45px rgba(15,23,42,.35);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
    .modal-header h3{margin:0;font-size:13px;}
    .modal-body{flex:1;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;}
    .report-table{width:100%;border-collapse:collapse;}
    .report-table th,.report-table td{padding:4px 6px;border-bottom:1px solid #e5e7eb;font-size:11px;white-space:nowrap;text-align:left;}
    .report-table th{background:#f9fafb;position:sticky;top:0;z-index:1;}
    .modal-footer{margin-top:4px;font-size:10px;color:#6b7280;text-align:right;}

    /* sortable headers */
    .th-sortable{
      cursor:pointer;
      user-select:none;
    }
    .th-sortable .sort-indicator{
      font-size:9px;
      color:#9ca3af;
      margin-left:4px;
      visibility:hidden;
    }

    @media print{
      body{background:#fff;padding:0;}
      .topbar-main,#dashboard,.modal-backdrop,.editor-topbar{display:none !important;}
      #editor{display:block !important;}
      .invoice-page{width:210mm;min-height:297mm;border:none;border-radius:0;padding:15mm 15mm 18mm 15mm;margin:0;}
      .watermark{opacity:0.06;}
      @page{size:A4;margin:0;}
    }
    @media(max-width:900px){
      .summary-cards{grid-template-columns:repeat(2,minmax(0,1fr));}
      .invoice-page{width:100%;padding:18px 12px;}
    }
  </style>
</head>
<body>

  <div class="topbar-main">
    <div class="brand">
      <img src="logo-main.png" alt="Logo">
      <div class="brand-info">
        <div class="brand-name">Nafithat Al-Amal Co.</div>
        <div class="brand-sub">Advanced Invoice Management (Local)</div>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn btn-primary" id="btn-dashboard">üìä Invoices Dashboard</button>
      <button class="btn" id="btn-report">üìÑ Invoices Report</button>
      <button class="btn" id="btn-new" onclick="createNewInvoice()">+ New Invoice</button>
      <button class="btn" id="btn-export">‚¨á Excel Report (CSV)</button>
      <button class="btn" id="btn-save-json">üíæ Save JSON</button>
      <button class="btn" id="btn-load-json">üìÇ Load JSON</button>
      <button class="btn btn-danger" id="btn-reset">üßπ Reset</button>
      <input type="file" id="json-file-input" accept="application/json" style="display:none">
    </div>
  </div>

  <div id="app">
    <section id="dashboard">
      <div class="dashboard-header">
        <div class="dashboard-title">
          Invoices
          <span>Manage by status</span>
        </div>
        <div class="search-box">
          <span>üîç</span>
          <input id="search-input" placeholder="Search invoices (customer, number, contract, description)...">
        </div>
      </div>

      <div class="filters-row">
        <div class="status-filters">
          <button class="status-pill active" data-filter="all">All</button>
          <button class="status-pill" data-filter="paid">Paid</button>
          <button class="status-pill" data-filter="unpaid">Unpaid</button>
          <button class="status-pill" data-filter="draft">Draft</button>
        </div>
        <div class="filters-right">
          <select id="po-filter" class="po-filter">
            <option value="all">All Contracts</option>
          </select>
          <div style="font-size:10px;color:#6b7280;">
            Click any row or the <b>Edit</b> button to open an invoice
          </div>
        </div>
      </div>

      <div class="summary-cards">
        <div class="card" id="card-total" data-type="total">
          <div class="card-label">
            Total Invoices
            <span>Based on current filters</span>
          </div>
          <div class="card-value" id="card-total-amount">IQD 0</div>
          <div class="card-sub" id="card-total-count">0 invoice(s)</div>
        </div>
        <div class="card" id="card-soon" data-type="soon">
          <div class="card-label">
            Due within 30 days
            <span>Early warning</span>
          </div>
          <div class="card-value" id="card-soon-amount">IQD 0</div>
          <div class="card-sub" id="card-soon-count">0 invoice(s)</div>
        </div>
        <div class="card" id="card-paid" data-type="paid">
          <div class="card-label">
            Paid
            <span>Already settled</span>
          </div>
          <div class="card-value" id="card-paid-amount">IQD 0</div>
          <div class="card-sub" id="card-paid-count">0 invoice(s)</div>
        </div>
        <div class="card" id="card-unpaid" data-type="unpaid">
          <div class="card-label">
            Unpaid
            <span>Includes all unpaid invoices</span>
          </div>
          <div class="card-value" id="card-unpaid-amount">IQD 0</div>
          <div class="card-sub" id="card-unpaid-count">0 invoice(s)</div>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="th-sortable" data-sort="issueDate">
                Date <span class="sort-indicator">‚ñ≤</span>
              </th>
              <th class="th-sortable" data-sort="dueDate">
                Due Date <span class="sort-indicator">‚ñ≤</span>
              </th>
              <th class="th-sortable" data-sort="number">
                Invoice No <span class="sort-indicator">‚ñ≤</span>
              </th>
              <th class="th-sortable" data-sort="contract">
                Contract (PO) <span class="sort-indicator">‚ñ≤</span>
              </th>
              <th class="th-sortable" data-sort="customerName">
                Customer <span class="sort-indicator">‚ñ≤</span>
              </th>
              <th class="th-sortable" data-sort="shortDesc">
                Short Description <span class="sort-indicator">‚ñ≤</span>
              </th>
              <th>Details</th>
              <th class="th-sortable" data-sort="status">
                Status <span class="sort-indicator">‚ñ≤</span>
              </th>
              <th class="th-sortable" data-sort="balance">
                Amount (Balance) <span class="sort-indicator">‚ñ≤</span>
              </th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="invoice-table-body"></tbody>
        </table>
      </div>
    </section>

    <section id="editor">
      <div class="editor-topbar">
        <div class="editor-title">
          üîß Edit Invoice
          <span id="editor-subtitle" style="font-size:11px;color:#6b7280;margin-inline-start:4px;"></span>
        </div>
        <div class="editor-actions">
          <select id="status-select" class="status-select">
            <option value="draft">Draft</option>
            <option value="unpaid">Unpaid</option>
            <option value="paid">Paid</option>
          </select>
          <button class="btn" id="btn-back">‚¨Ö Back to Dashboard</button>
          <button class="btn" id="btn-duplicate">üìÑ Duplicate Invoice</button>
          <button class="btn btn-danger" id="btn-delete">üóë Delete Invoice</button>
          <button class="btn btn-primary" id="btn-save">üíæ Save Invoice</button>
          <button class="btn" id="btn-print">üñ® Print / PDF</button>
        </div>
      </div>

      <div class="invoice-page">
        <img src="logo-watermark.png" class="watermark" alt="">
        <div class="invoice-inner">
          <div class="inv-header">
            <div class="inv-company">
              <div class="inv-company-name">Nafithat Al-Amal Co.</div>
              <p>Address: Baghdad - Al-Wahda District - Street 52</p>
              <p>&nbsp;</p>
              <p>Email: sales@nafmals.com</p>
              <p>www.nafmals.com</p>
              <p>Phone Number: 07723571779</p>
            </div>
            <div class="inv-right">
              <div class="inv-logo-top">
                <img src="logo-main.png" alt="Logo">
              </div>
              <div class="inv-logo-title">Invoice</div>
              <div class="meta">
                <div class="meta-row">
                  <span class="label">Invoice No:</span>
                  <input id="f-number">
                </div>
                <div class="meta-row">
                  <span class="label">Invoice Date:</span>
                  <input id="f-date">
                </div>
                <div class="meta-row">
                  <span class="label">Due Date:</span>
                  <input id="f-due">
                </div>
                <div class="meta-row">
                  <span class="label">Contract Number:</span>
                  <input id="f-contract">
                </div>
              </div>
            </div>
          </div>

          <div class="bill-title-row">
            <div style="flex:1;">
              <div class="bill-to-label">Bill To:</div>
              <div class="bill-to-box">
                <textarea id="f-billto" class="bill-to-textarea"></textarea>
              </div>
            </div>
            <div class="center-invoice-title">Invoice</div>
          </div>

          <table class="inv-table">
            <thead>
              <tr>
                <th colspan="7">Description of Services</th>
              </tr>
              <tr>
                <th style="width:24px;">No.</th>
                <th>DESCRIPTION</th>
                <th style="width:90px;">Location</th>
                <th style="width:80px;">DATE</th>
                <th style="width:55px;">UNIT</th>
                <th style="width:50px;">QTY</th>
                <th style="width:110px;">UNIT PRICE / TOTAL PRICE</th>
              </tr>
            </thead>
            <tbody id="items-body"></tbody>
          </table>

          <div class="add-row-bar">
            <button type="button" class="btn-sm" id="add-row-btn">+ Add Line</button>
          </div>

          <div class="thankyou">Thank you for your business!</div>

          <div class="totals-wrap">
            <table class="totals">
              <tr>
                <td>SUBTOTAL</td>
                <td><input id="f-subtotal" readonly></td>
              </tr>
              <tr>
                <td>DISCOUNT</td>
                <td><input id="f-discount" type="number" value="0"></td>
              </tr>
              <tr>
                <td>SUBTOTAL LESS DISCOUNT</td>
                <td><input id="f-sub-less" readonly></td>
              </tr>
              <tr>
                <td>TAX (%)</td>
                <td><input id="f-tax" type="number" value="0"></td>
              </tr>
              <tr>
                <td>SHIPPING/HANDLING</td>
                <td><input id="f-shipping" type="number" value="0"></td>
              </tr>
              <tr>
                <td class="balance">Balance Due</td>
                <td><input id="f-balance" class="balance" readonly></td>
              </tr>
            </table>
          </div>

          <div class="bottom-row">
            <div class="scope-col">
              <div class="scope-label">Scope of Work:</div>
              <textarea id="f-scope" class="scope-textarea"></textarea>
            </div>
            <div class="bank-col">
              <div class="bank-label">Bank Account details</div>
              <table class="bank-table">
                <tr><td>Account Name</td><td>Nafithat Al-Amal</td></tr>
                <tr><td>IBAN Code</td><td>IQ07NISB002000000314765</td></tr>
                <tr><td>Account Number</td><td>314765</td></tr>
                <tr><td>Bank</td><td>National Islamic Bank</td></tr>
                <tr><td>Currency</td><td>Iraqi Dinar</td></tr>
                <tr><td>Branch</td><td>Al-Kadhimiya Branch</td></tr>
              </table>
            </div>
          </div>

          <div class="note-block">
            <div style="font-weight:bold;margin-bottom:3px;">Invoice Notes (Internal):</div>
            <textarea id="f-note" placeholder="Internal notes, extra details, payment reference, cheque number ..."></textarea>
          </div>

          <div class="sign-row">
            <div class="sign-name">
              <span>Ayad Kazem</span><br>
              <span>Signature</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3>Invoices List</h3>
        <button class="btn btn-sm" id="close-modal-btn">Close</button>
      </div>
      <div class="modal-body">
        <table class="report-table">
          <thead>
            <tr>
              <th>Invoice No</th>
              <th>Date</th>
              <th>Contract</th>
              <th>Status</th>
              <th>Balance (IQD)</th>
            </tr>
          </thead>
          <tbody id="report-body"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        Click any row to open the invoice.
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "naf_invoice_system_advanced_main";

    let invoices = [];
    let currentId = null;
    let currentFilter = "all";
    let currentPoFilter = "all";
    let specialFilter = "none";

    // default seed: ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ±ŸÉŸá ŸÅÿßÿ±ÿ∫ÿßŸã Ÿàÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Load JSON
    const seedInvoices = [];

    const $ = id => document.getElementById(id);

    let currentSortField = "issueDate"; // default sort
    let currentSortDir   = "desc";      // desc = newest first

    function todayStr(){ return new Date().toISOString().slice(0,10); }
    function formatIQD(n){ n = Number(n)||0; return "IQD " + n.toLocaleString("en-US"); }
    function parseNumber(v){ if(typeof v!=="string") v=String(v||""); return Number(v.replace(/[^\d.-]/g,"")) || 0; }

    function createItemRow(data={}){
      const tr = document.createElement("tr");
      tr.className = "item-row";
      tr.innerHTML = `
        <td class="no-cell"></td>
        <td><textarea class="cell-textarea cell-desc">${data.desc || ""}</textarea></td>
        <td><input class="cell-input cell-loc" value="${data.location || ""}"></td>
        <td><input class="cell-input cell-date" value="${data.date || ""}"></td>
        <td><input class="cell-input cell-unit" value="${data.unit || ""}"></td>
        <td><input class="cell-input cell-qty" type="number" min="0" value="${data.qty != null ? data.qty : 1}"></td>
        <td>
          <input class="cell-input cell-price" type="number" min="0" value="${data.price != null ? data.price : 0}">
          <br>
          <input class="cell-input cell-total" type="text" readonly>
        </td>`;
      tr.querySelectorAll(".cell-qty,.cell-price").forEach(inp=>{
        inp.addEventListener("input", recalcTotals);
      });
      return tr;
    }

    function updateRowNumbers(){
      document.querySelectorAll(".item-row .no-cell").forEach((td,i)=>{ td.textContent = i+1; });
    }

    function recalcRow(tr){
      const qty = parseNumber(tr.querySelector(".cell-qty").value);
      const price = parseNumber(tr.querySelector(".cell-price").value);
      const total = qty * price;
      tr.querySelector(".cell-total").value = formatIQD(total);
      return total;
    }

    function recalcTotals(){
      const rows = document.querySelectorAll("#items-body .item-row");
      let subtotal = 0;
      rows.forEach(tr => subtotal += recalcRow(tr));
      const discount = parseNumber($("f-discount").value);
      const taxPerc  = parseNumber($("f-tax").value);
      const shipping = parseNumber($("f-shipping").value);
      const subLess = subtotal - discount;
      const taxVal  = subLess * (taxPerc/100);
      const balance = subLess + taxVal + shipping;
      $("f-subtotal").value = formatIQD(subtotal);
      $("f-sub-less").value = formatIQD(subLess);
      $("f-balance").value  = formatIQD(balance);
    }

    function readForm(inv){
      inv.number      = $("f-number").value.trim();
      inv.issueDate   = $("f-date").value.trim();
      inv.dueDate     = $("f-due").value.trim();
      inv.contract    = $("f-contract").value.trim();
      inv.billTo      = $("f-billto").value.trim();
      inv.scope       = $("f-scope").value.trim();
      inv.status      = $("status-select").value;
      inv.note        = $("f-note").value.trim();
      const firstLine = inv.billTo.split("\n")[0] || "";
      inv.customerName = firstLine;

      const rows = document.querySelectorAll("#items-body .item-row");
      inv.items = Array.from(rows).map(tr=>({
        desc:     tr.querySelector(".cell-desc").value.trim(),
        location: tr.querySelector(".cell-loc").value.trim(),
        date:     tr.querySelector(".cell-date").value.trim(),
        unit:     tr.querySelector(".cell-unit").value.trim(),
        qty:      parseNumber(tr.querySelector(".cell-qty").value),
        price:    parseNumber(tr.querySelector(".cell-price").value),
      }));

      inv.subtotal = parseNumber($("f-subtotal").value);
      inv.discount = parseNumber($("f-discount").value);
      inv.taxPerc  = parseNumber($("f-tax").value);
      inv.shipping = parseNumber($("f-shipping").value);
      inv.balance  = parseNumber($("f-balance").value);
      inv.updatedAt = new Date().toISOString();
    }

    function fillForm(inv){
      $("f-number").value   = inv.number      || "";
      $("f-date").value     = inv.issueDate   || todayStr();
      $("f-due").value      = inv.dueDate     || "";
      $("f-contract").value = inv.contract    || "";
      $("f-billto").value   = inv.billTo      || "";
      $("f-scope").value    = inv.scope       || "";
      $("f-note").value     = inv.note        || "";
      $("status-select").value = inv.status || "draft";

      $("items-body").innerHTML = "";
      const items = inv.items && inv.items.length ? inv.items : [{},{},{},{}];
      items.forEach(it => $("items-body").appendChild(createItemRow(it)));
      updateRowNumbers();

      $("f-discount").value = inv.discount != null ? inv.discount : 0;
      $("f-tax").value      = inv.taxPerc  != null ? inv.taxPerc  : 0;
      $("f-shipping").value = inv.shipping != null ? inv.shipping : 0;

      recalcTotals();
      $("editor-subtitle").textContent = inv.number ? `(${inv.number})` : "";
    }

    function loadInvoices(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const arr = JSON.parse(raw);
          if(Array.isArray(arr) && arr.length){
            invoices = arr;
            return;
          }
        }
      }catch(e){
        console.error("Error loading invoices:", e);
      }

      if (Array.isArray(seedInvoices) && seedInvoices.length){
        invoices = seedInvoices.slice();
        saveInvoices();
      }
    }

    function saveInvoices(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
      renderPoFilterOptions();
      renderDashboard();
      renderReport();
    }

    function showDashboard(){
      $("dashboard").style.display = "";
      $("editor").style.display = "none";
    }
    function showEditor(){
      $("dashboard").style.display = "none";
      $("editor").style.display = "";
    }

    function openEditor(id){
      const inv = invoices.find(i=>i.id===id);
      if(!inv) return;
      currentId = id;
      fillForm(inv);
      showEditor();
    }

    function isOverdue(inv){
      if(inv.status==="paid") return false;
      if(!inv.dueDate) return false;
      const d = new Date(inv.dueDate);
      const today = new Date(todayStr());
      return d < today;
    }

    function isDueSoon(inv){
      if(inv.status==="paid") return false;
      if(!inv.dueDate) return false;
      const d = new Date(inv.dueDate);
      const today = new Date(todayStr());
      const diff = (d - today)/(1000*60*60*24);
      return diff>=0 && diff<=30;
    }

    function getStatusBadge(status,inv){
      let cls="badge-draft",txt="Draft";
      if(status==="paid"){cls="badge-paid";txt="Paid";}
      else if(status==="unpaid"){
        cls = isOverdue(inv)?"badge-overdue":"badge-unpaid";
        txt = isOverdue(inv)?"Overdue":"Unpaid";
      }
      return `<span class="badge ${cls}">${txt}</span>`;
    }

    function renderPoFilterOptions(){
      const select = $("po-filter");
      if(!select) return;
      const current = select.value || "all";
      const contracts = Array.from(new Set(invoices
        .map(inv=>inv.contract)
        .filter(c=>c && c.trim().length)))
        .sort();
      select.innerHTML = `<option value="all">All Contracts</option>` +
        contracts.map(c=>`<option value="${c}">${c}</option>`).join("");
      if(contracts.includes(current)) select.value = current; else select.value = "all";
      currentPoFilter = select.value;
    }

    function matchesFilters(inv, searchText){
      if(currentPoFilter!=="all" && (inv.contract||"") !== currentPoFilter) return false;
      if(searchText){
        const hay = [inv.number,inv.customerName,inv.contract,inv.billTo,inv.scope,inv.note].join(" ").toLowerCase();
        if(!hay.includes(searchText)) return false;
      }
      if(specialFilter === "soon"){
        return isDueSoon(inv);
      }
      if(currentFilter==="paid")   return inv.status==="paid";
      if(currentFilter==="draft")  return inv.status==="draft";
      if(currentFilter==="unpaid") return inv.status==="unpaid";
      return true;
    }

    function sortInvoices(list){
      const field = currentSortField;
      const dir   = currentSortDir === "asc" ? 1 : -1;

      const statusOrder = { unpaid:0, paid:1, draft:2 };

      return list.slice().sort((a,b)=>{
        let va, vb;

        switch(field){
          case "issueDate":
            va = a.issueDate || "";
            vb = b.issueDate || "";
            return va.localeCompare(vb) * dir;

          case "dueDate":
            va = a.dueDate || "";
            vb = b.dueDate || "";
            return va.localeCompare(vb) * dir;

          case "number":
            va = (a.number || "").toLowerCase();
            vb = (b.number || "").toLowerCase();
            return va.localeCompare(vb) * dir;

          case "contract":
            va = (a.contract || "").toLowerCase();
            vb = (b.contract || "").toLowerCase();
            return va.localeCompare(vb) * dir;

          case "customerName":
            va = (a.customerName || "").toLowerCase();
            vb = (b.customerName || "").toLowerCase();
            return va.localeCompare(vb) * dir;

          case "shortDesc": {
            const ad = (a.scope || (a.items && a.items[0] && a.items[0].desc) || "").toLowerCase();
            const bd = (b.scope || (b.items && b.items[0] && b.items[0].desc) || "").toLowerCase();
            return ad.localeCompare(bd) * dir;
          }

          case "status": {
            const sa = a.status || "draft";
            const sb = b.status || "draft";
            const oa = statusOrder[sa] ?? 9;
            const ob = statusOrder[sb] ?? 9;
            if (oa === ob) return 0;
            return (oa - ob) * dir;
          }

          case "balance":
            va = Number(a.balance || 0);
            vb = Number(b.balance || 0);
            if (va === vb) return 0;
            return (va - vb) * dir;

          default:
            return 0;
        }
      });
    }

    function editInvoice(id){ openEditor(id); }

    function deleteInvoiceById(id, ask){
      if(ask && !confirm("Are you sure you want to delete this invoice? This cannot be undone.")) return;
      invoices = invoices.filter(inv => inv.id !== id);
      if(currentId === id) currentId = null;
      saveInvoices();
      showDashboard();
    }

    function renderDashboard(){
      const tbody = $("invoice-table-body");
      if(!tbody) return;
      tbody.innerHTML = "";
      const searchText = ($("search-input")?.value || "").trim().toLowerCase();
      const filtered = invoices.filter(inv => matchesFilters(inv, searchText));

      let total=0,paid=0,unpaid=0,soonAmt=0;
      let countTotal=0,countPaid=0,countUnpaid=0,countSoon=0;

      filtered.forEach(inv=>{
        total += inv.balance || 0; countTotal++;
        if(inv.status==="paid"){paid+=inv.balance||0;countPaid++;}
        else if(inv.status==="unpaid"){unpaid+=inv.balance||0;countUnpaid++;}
      });

      invoices.forEach(inv=>{
        if(isDueSoon(inv)){soonAmt+=inv.balance||0;countSoon++;}
      });

      if($("card-total-amount")){
        $("card-total-amount").textContent   = formatIQD(total);
        $("card-total-count").textContent    = countTotal + " invoice(s)";
        $("card-paid-amount").textContent    = formatIQD(paid);
        $("card-paid-count").textContent     = countPaid + " invoice(s)";
        $("card-unpaid-amount").textContent  = formatIQD(unpaid);
        $("card-unpaid-count").textContent   = countUnpaid + " invoice(s)";
        $("card-soon-amount").textContent    = formatIQD(soonAmt);
        $("card-soon-count").textContent     = countSoon + " invoice(s)";
      }

      const sorted = sortInvoices(filtered);
      if(!sorted.length){
        tbody.innerHTML = `<tr><td colspan="10" style="font-size:11px;color:#6b7280;">No invoices yet. Click "New Invoice" or Load JSON.</td></tr>`;
        return;
      }

      sorted.forEach(inv=>{
        const descSource = inv.scope || (inv.items && inv.items[0] && inv.items[0].desc) || "";
        const shortDesc  = descSource.slice(0,48) + (descSource.length>48?"...":"");
        const noteSnippet = (inv.note||"").slice(0,32) + ((inv.note||"").length>32?"...":"");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${inv.issueDate || ""}</td>
          <td>${inv.dueDate || ""}</td>
          <td>${inv.number || ""}</td>
          <td>${inv.contract || ""}</td>
          <td>${inv.customerName || ""}</td>
          <td>${shortDesc}</td>
          <td>${noteSnippet || "-"}</td>
          <td>${getStatusBadge(inv.status,inv)}</td>
          <td style="text-align:right;">${formatIQD(inv.balance || 0)}</td>
          <td>
            <button class="btn btn-sm" onclick="event.stopPropagation(); editInvoice('${inv.id}')">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteInvoiceById('${inv.id}', true)">Delete</button>
          </td>`;
        tr.addEventListener("click", ()=>openEditor(inv.id));
        tbody.appendChild(tr);
      });
    }

    function renderReport(){
      const tbody = $("report-body");
      if(!tbody) return;
      tbody.innerHTML = "";
      if(!invoices.length){
        tbody.innerHTML = `<tr><td colspan="5" style="font-size:11px;color:#6b7280;">No invoices yet.</td></tr>`;
        return;
      }
      invoices.slice().sort((a,b)=>(b.issueDate||"").localeCompare(a.issueDate||""))
        .forEach(inv=>{
          const statusTxt = inv.status==="paid" ? "Paid" :
                            inv.status==="unpaid" ? (isOverdue(inv)?"Overdue":"Unpaid") :
                            "Draft";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${inv.number || ""}</td>
            <td>${inv.issueDate || ""}</td>
            <td>${inv.contract || ""}</td>
            <td>${statusTxt}</td>
            <td style="text-align:right;">${inv.balance != null ? inv.balance.toLocaleString("en-US") : ""}</td>`;
          tr.addEventListener("click", ()=>{
            if($("modal-backdrop")) $("modal-backdrop").style.display = "none";
            openEditor(inv.id);
          });
          tbody.appendChild(tr);
        });
    }

    function generateId(){
      if(window.crypto && crypto.randomUUID) return crypto.randomUUID();
      return String(Date.now()) + "-" + String(Math.random()).slice(2);
    }

    function createNewInvoice(){
      const today = todayStr();
      const id = generateId();
      const inv = {
        id,
        number:"INV-"+today.replace(/-/g,""),
        issueDate:today,
        dueDate:today,
        contract: currentPoFilter !== "all" ? currentPoFilter : "",
        billTo:"",
        customerName:"",
        scope:"",
        note:"",
        items:[],
        subtotal:0,
        discount:0,
        taxPerc:0,
        shipping:0,
        balance:0,
        status:"draft",
        createdAt:new Date().toISOString(),
        updatedAt:new Date().toISOString()
      };
      invoices.push(inv);
      currentId = id;
      fillForm(inv);
      saveInvoices();
      showEditor();
    }

    function saveCurrentInvoice(){
      if(!currentId){
        createNewInvoice();
        return;
      }
      const inv = invoices.find(i=>i.id===currentId);
      if(!inv) return;
      recalcTotals();
      readForm(inv);
      saveInvoices();
      alert("Invoice saved ‚úÖ");
    }

    function deleteCurrentInvoice(){
      if(!currentId){ alert("No invoice selected to delete."); return; }
      deleteInvoiceById(currentId, true);
      alert("Invoice deleted ‚úÖ");
    }

    function duplicateCurrentInvoice(){
      if(!currentId){ alert("No open invoice to duplicate."); return; }
      const original = invoices.find(i=>i.id===currentId);
      if(!original) return;
      const id = generateId();
      const copy = JSON.parse(JSON.stringify(original));
      const today = todayStr();
      copy.id = id;
      copy.number = original.number ? original.number + "-COPY" : "INV-"+today.replace(/-/g,"");
      copy.issueDate = today;
      copy.dueDate = today;
      copy.status = "draft";
      copy.createdAt = new Date().toISOString();
      copy.updatedAt = new Date().toISOString();
      invoices.push(copy);
      currentId = id;
      fillForm(copy);
      saveInvoices();
      showEditor();
      alert("Invoice duplicated ‚úÖ");
    }

    function exportCsv(){
      if(!invoices.length){ alert("No invoices to export."); return; }
      const header = ["Invoice No","Issue Date","Due Date","Customer","Contract","Status","Balance (IQD)","Note"];
      const lines = [header.join(",")];
      invoices.forEach(inv=>{
        const statusTxt = inv.status==="paid" ? "PAID" :
                          inv.status==="unpaid" ? (isOverdue(inv)?"OVERDUE":"UNPAID") :
                          "DRAFT";
        const row = [
          `"${(inv.number||"").replace(/"/g,'""')}"`,
          `"${(inv.issueDate||"").replace(/"/g,'""')}"`,
          `"${(inv.dueDate||"").replace(/"/g,'""')}"`,
          `"${(inv.customerName||"").replace(/"/g,'""')}"`,
          `"${(inv.contract||"").replace(/"/g,'""')}"`,
          `"${statusTxt}"`,
          inv.balance != null ? inv.balance : 0,
          `"${(inv.note||"").replace(/"/g,'""')}"`
        ];
        lines.push(row.join(","));
      });
      const blob = new Blob(["\ufeff"+lines.join("\n")],{type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "invoices-report.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportJson(){
      const data = JSON.stringify(invoices,null,2);
      const blob = new Blob([data],{type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "invoices-backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importJsonFromFile(file){
      const reader = new FileReader();
      reader.onload = e=>{
        try{
          const data = JSON.parse(e.target.result);
          if(!Array.isArray(data)){ alert("Invalid JSON file."); return; }
          if(!confirm("All current invoices will be replaced with data from this file. Are you sure?")) return;
          data.forEach(inv=>{ if(!inv.id) inv.id = generateId(); });
          invoices = data;
          currentId = null;
          saveInvoices();
          showDashboard();
          alert("JSON data restored successfully ‚úÖ");
        }catch(err){
          console.error(err);
          alert("Could not read JSON file. Please check that it is valid.");
        }
      };
      reader.readAsText(file,"utf-8");
    }

    function resetSystem(){
      if(!confirm("All locally stored invoices will be deleted. Are you sure?")) return;
      localStorage.removeItem(STORAGE_KEY);
      invoices = [];
      currentId = null;
      saveInvoices();
      showDashboard();
      alert("System reset ‚úÖ");
    }

    function highlightCard(type){
      document.querySelectorAll(".card[data-type]").forEach(c=>{
        c.classList.toggle("card-active", c.dataset.type === type);
      });
    }

    function updateActiveStatusPills(){
      document.querySelectorAll(".status-pill").forEach(b=>{
        b.classList.remove("active");
        if(currentFilter === b.dataset.filter){
          b.classList.add("active");
        }
        if(currentFilter==="all" && b.dataset.filter==="all"){
          b.classList.add("active");
        }
      });
    }

    function setFilterFromCard(type){
      specialFilter = "none";
      if(type === "total"){
        currentFilter = "all";
      }else if(type === "soon"){
        currentFilter = "all";
        specialFilter = "soon";
      }else if(type === "paid"){
        currentFilter = "paid";
      }else if(type === "unpaid"){
        currentFilter = "unpaid";
      }
      highlightCard(type);
      updateActiveStatusPills();
      renderDashboard();
    }

    function updateSortIndicators(){
      document.querySelectorAll("th.th-sortable").forEach(th=>{
        const span  = th.querySelector(".sort-indicator");
        if(!span) return;
        const field = th.dataset.sort;
        if(field === currentSortField){
          span.textContent = currentSortDir === "asc" ? "‚ñ≤" : "‚ñº";
          span.style.visibility = "visible";
        }else{
          span.style.visibility = "hidden";
        }
      });
    }

    function setupEvents(){
      const bDash = $("btn-dashboard"); if(bDash) bDash.addEventListener("click", ()=>{showDashboard();highlightCard("total");});
      const bRep  = $("btn-report");    if(bRep)  bRep.addEventListener("click", ()=>{const mb=$("modal-backdrop");if(mb)mb.style.display="flex";renderReport();});
      const bBack = $("btn-back");      if(bBack) bBack.addEventListener("click", showDashboard);
      const bPr   = $("btn-print");     if(bPr)   bPr.addEventListener("click", ()=>window.print());
      const bSave = $("btn-save");      if(bSave) bSave.addEventListener("click", saveCurrentInvoice);
      const bDel  = $("btn-delete");    if(bDel)  bDel.addEventListener("click", deleteCurrentInvoice);
      const bDup  = $("btn-duplicate"); if(bDup)  bDup.addEventListener("click", duplicateCurrentInvoice);
      const bExp  = $("btn-export");    if(bExp)  bExp.addEventListener("click", exportCsv);
      const bSJ   = $("btn-save-json"); if(bSJ)   bSJ.addEventListener("click", exportJson);
      const bLJ   = $("btn-load-json"); if(bLJ)   bLJ.addEventListener("click", ()=>$("json-file-input")?.click());
      const bRes  = $("btn-reset");     if(bRes)  bRes.addEventListener("click", resetSystem);

      const fileInput = $("json-file-input");
      if(fileInput) fileInput.addEventListener("change", e=>{
        const file = e.target.files[0];
        if(file) importJsonFromFile(file);
        e.target.value = "";
      });

      const cModal = $("close-modal-btn");
      if(cModal) cModal.addEventListener("click", ()=>{const mb=$("modal-backdrop");if(mb)mb.style.display="none";});
      document.addEventListener("keydown", e=>{ if(e.key==="Escape"){const mb=$("modal-backdrop");if(mb)mb.style.display="none";} });

      document.querySelectorAll(".status-pill").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          document.querySelectorAll(".status-pill").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          currentFilter = btn.dataset.filter;
          specialFilter = "none";
          highlightCard("total");
          renderDashboard();
        });
      });

      const sInput = $("search-input"); if(sInput) sInput.addEventListener("input", renderDashboard);
      const sSel   = $("status-select"); if(sSel) sSel.addEventListener("change", ()=>{
        if(!currentId) return;
        const inv = invoices.find(i=>i.id===currentId);
        if(!inv) return;
        inv.status = sSel.value;
        saveInvoices();
      });

      ["f-discount","f-tax","f-shipping"].forEach(id=>{
        const el = $(id); if(el) el.addEventListener("input", recalcTotals);
      });

      const addRowBtn = $("add-row-btn");
      if(addRowBtn) addRowBtn.addEventListener("click", ()=>{
        $("items-body").appendChild(createItemRow({qty:1,price:0}));
        updateRowNumbers();
        recalcTotals();
      });

      const poFilter = $("po-filter");
      if(poFilter) poFilter.addEventListener("change", ()=>{ currentPoFilter = poFilter.value; renderDashboard(); });

      [["card-total","total"],["card-soon","soon"],["card-paid","paid"],["card-unpaid","unpaid"]]
        .forEach(([id,type])=>{
          const el = $(id);
          if(el) el.addEventListener("click", ()=>setFilterFromCard(type));
        });

      // click-to-sort headers
      document.querySelectorAll("th.th-sortable").forEach(th=>{
        th.addEventListener("click", ()=>{
          const field = th.dataset.sort;
          if(currentSortField === field){
            currentSortDir = currentSortDir === "asc" ? "desc" : "asc";
          }else{
            currentSortField = field;
            currentSortDir   = "asc";
          }
          updateSortIndicators();
          renderDashboard();
        });
      });
    }

    window.createNewInvoice = createNewInvoice;
    window.editInvoice      = editInvoice;
    window.deleteInvoiceById= deleteInvoiceById;

    (function init(){
      setupEvents();
      loadInvoices();
      renderPoFilterOptions();
      showDashboard();
      highlightCard("total");
      renderDashboard();
      renderReport();
      updateSortIndicators();
    })();
  </script>
</body>
</html>
