<script>
    const STORAGE_KEY = "naf_invoice_system_advanced_main";
    let invoices = [];
    let currentId = null;
    let currentFilter = "all";
    let currentPoFilter = "all";
    let specialFilter = "none";

    function normalizeInvoice(inv){
      if(!inv) return inv;
      // Ensure ID
      if(!inv.id){
        inv.id = generateId ? generateId() : (Date.now().toString());
      }
      // Normalize status to expected enum
      const raw = (inv.status == null ? "draft" : String(inv.status)).toLowerCase().trim();
      if(raw === "paid" || raw === "unpaid" || raw === "overdue" || raw === "draft"){
        inv.status = raw;
      } else if(raw === "partially_paid" || raw === "partial"){
        inv.status = "unpaid";
      } else {
        inv.status = "draft";
      }
      return inv;
    }

    // Invoices seeded from Excel (Book1.xlsx)
    const seedInvoices = [
      {
        "id": "CP-INV00001",
        "number": "CP-INV00001",
        "issueDate": "2024-03-01",
        "dueDate": "2024-04-30",
        "contract": "PO00023",
        "billTo": "",
        "customerName": "",
        "scope": "",
        "note": "",
        "items": [
          {
            "desc": "Generator rental: 200KVA, including operators available 24/7 and a 3000-liter fuel tank.",
            "location": "",
            "date": "2024-03-01",
            "unit": "Lot",
            "qty": 1,
            "price": 5500000
          }
        ],
        "subtotal": 5500000,
        "discount": 0,
        "taxPerc": 0,
        "shipping": 0,
        "balance": 5500000,
        "status": "paid",
        "createdAt": "2024-03-01T00:00:00.000Z",
        "updatedAt": "2024-03-01T00:00:00.000Z"
      },
      {
        "id": "CP-INV00001-APR",
        "number": "CP-INV00001",
        "issueDate": "2024-04-01",
        "dueDate": "2024-04-30",
        "contract": "PO00023",
        "billTo": "",
        "customerName": "",
        "scope": "",
        "note": "",
        "items": [
          {
            "desc": "Generator rental: 200KVA, including operators available 24/7 and a 3000-liter fuel tank.",
            "location": "",
            "date": "2024-04-01",
            "unit": "Lot",
            "qty": 1,
            "price": 5500000
          }
        ],
        "subtotal": 5500000,
        "discount": 0,
        "taxPerc": 0,
        "shipping": 0,
        "balance": 5500000,
        "status": "paid",
        "createdAt": "2024-04-01T00:00:00.000Z",
        "updatedAt": "2024-04-01T00:00:00.000Z"
      },
      {
        "id": "CP-INV00002-1",
        "number": "CP-INV00002",
        "issueDate": "2024-03-01",
        "dueDate": "2024-03-31",
        "contract": "PO00023",
        "billTo": "",
        "customerName": "",
        "scope": "",
        "note": "",
        "items": [
          {
            "desc": "Diesel Fuel for Generators POD 4",
            "location": "",
            "date": "2024-03-01",
            "unit": "Liters",
            "qty": 2890,
            "price": 750
          }
        ],
        "subtotal": 2167500,
        "discount": 0,
        "taxPerc": 0,
        "shipping": 0,
        "balance": 2167500,
        "status": "paid",
        "createdAt": "2024-03-01T00:00:00.000Z",
        "updatedAt": "2024-03-01T00:00:00.000Z"
      },
      {
        "id": "CP-INV00002-2",
        "number": "CP-INV00002",
        "issueDate": "2024-04-01",
        "dueDate": "2024-04-30",
        "contract": "PO00023",
        "billTo": "",
        "customerName": "",
        "scope": "",
        "note": "",
        "items": [
          {
            "desc": "Diesel Fuel for Generators POD 6",
            "location": "",
            "date": "2024-04-01",
            "unit": "Liters",
            "qty": 1100,
            "price": 750
          }
        ],
        "subtotal": 825000,
        "discount": 0,
        "taxPerc": 0,
        "shipping": 0,
        "balance": 825000,
        "status": "paid",
        "createdAt": "2024-04-01T00:00:00.000Z",
        "updatedAt": "2024-04-01T00:00:00.000Z"
      },
      {
        "id": "CP-INV00002-3",
        "number": "CP-INV00002",
        "issueDate": "2024-06-01",
        "dueDate": "2024-06-15",
        "contract": "PO00023",
        "billTo": "",
        "customerName": "",
        "scope": "",
        "note": "",
        "items": [
          {
            "desc": "Diesel Fuel for Generators POD 7",
            "location": "",
            "date": "2024-06-01",
            "unit": "Liters",
            "qty": 1000,
            "price": 750
          }
        ],
        "subtotal": 750000,
        "discount": 0,
        "taxPerc": 0,
        "shipping": 0,
        "balance": 750000,
        "status": "paid",
        "createdAt": "2024-06-01T00:00:00.000Z",
        "updatedAt": "2024-06-01T00:00:00.000Z"
      },
      {
        "id": "CP-INV00002-4",
        "number": "CP-INV00002",
        "issueDate": "2024-06-15",
        "dueDate": "2024-06-30",
        "contract": "PO00023",
        "billTo": "",
        "customerName": "",
        "scope": "",
        "note": "",
        "items": [
          {
            "desc": "Diesel Fuel for Generators POD 8",
            "location": "",
            "date": "2024-06-15",
            "unit": "Liters",
            "qty": 2000,
            "price": 750
          }
        ],
        "subtotal": 1500000,
        "discount": 0,
        "taxPerc": 0,
        "shipping": 0,
        "balance": 1500000,
        "status": "paid",
        "createdAt": "2024-06-15T00:00:00.000Z",
        "updatedAt": "2024-06-15T00:00:00.000Z"
      },
      {
        "id": "CP-INV00002-5",
        "number": "CP-INV00002",
        "issueDate": "2024-07-01",
        "dueDate": "2024-07-18",
        "contract": "PO00023",
        "billTo": "",
        "customerName": "",
        "scope": "",
        "note": "",
        "items": [
          {
            "desc": "Diesel Fuel for Generators POD 9",
            "location": "",
            "date": "2024-07-01",
            "unit": "Liters",
            "qty": 2100,
            "price": 750
          }
        ],
        "subtotal": 1575000,
        "discount": 0,
        "taxPerc": 0,
        "shipping": 0,
        "balance": 1575000,
        "status": "paid",
        "createdAt": "2024-07-01T00:00:00.000Z",
        "updatedAt": "2024-07-01T00:00:00.000Z"
      },
      {
        "id": "CP-INV00003",
        "number": "CP-INV00003",
        "issueDate": "2024-05-01",
        "dueDate": "2024-05-31",
        "contract": "PO00023",
        "billTo": "",
        "customerName": "",
        "scope": "",
        "note": "",
        "items": [
          {
            "desc": "Generator rental: 200KVA, including operators available 24/7 and a 3000-liter fuel tank.",
            "location": "",
            "date": "2024-05-01",
            "unit": "Lot",
            "qty": 1,
            "price": 5500000
          }
        ],
        "subtotal": 5500000,
        "discount": 0,
        "taxPerc": 0,
        "shipping": 0,
        "balance": 5500000,
        "status": "paid",
        "createdAt": "2024-05-01T00:00:00.000Z",
        "updatedAt": "2024-05-01T00:00:00.000Z"
      },
      {
        "id": "CP-INV00004",
        "number": "CP-INV00004",
        "issueDate": "2024-06-01",
        "dueDate": "2024-06-30",
        "contract": "PO00023",
        "billTo": "",
        "customerName": "",
        "scope": "",
        "note": "",
        "items": [
          {
            "desc": "Generator rental: 200KVA, including operators available 24/7 and a 3000-liter fuel tank.",
            "location": "",
            "date": "2024-06-01",
            "unit": "Lot",
            "qty": 1,
            "price": 5500000
          }
        ],
        "subtotal": 5500000,
        "discount": 0,
        "taxPerc": 0,
        "shipping": 0,
        "balance": 5500000,
        "status": "paid",
        "createdAt": "2024-06-01T00:00:00.000Z",
        "updatedAt": "2024-06-01T00:00:00.000Z"
      },
      {
        "id": "CP-INV00005",
        "number": "CP-INV00005",
        "issueDate": "2024-07-01",
        "dueDate": "2024-07-31",
        "contract": "PO00023",
        "billTo": "",
        "customerName": "",
        "scope": "",
        "note": "",
        "items": [
          {
            "desc": "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
            "location": "",
            "date": "2024-07-01",
            "unit": "Lot",
            "qty": 2,
            "price": 3375000
          }
        ],
        "subtotal": 6750000,
        "discount": 0,
        "taxPerc": 0,
        "shipping": 0,
        "balance": 6750000,
        "status": "paid",
        "createdAt": "2024-07-01T00:00:00.000Z",
        "updatedAt": "2024-07-01T00:00:00.000Z"
      },
      {
        "id": "CP-INV00006",
        "number": "CP-INV00006",
        "issueDate": "2024-08-01",
        "dueDate": "2024-08-31",
        "contract": "PO00023",
        "billTo": "",
        "customerName": "",
        "scope": "",
        "note": "",
        "items": [
          {
            "desc": "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
            "location": "",
            "date": "2024-08-01",
            "unit": "Lot",
            "qty": 2,
            "price": 3375000
          }
        ],
        "subtotal": 6750000,
        "discount": 0,
        "taxPerc": 0,
        "shipping": 0,
        "balance": 6750000,
        "status": "paid",
        "createdAt": "2024-08-01T00:00:00.000Z",
        "updatedAt": "2024-08-01T00:00:00.000Z"
      },

      /*  ⚠️ هنا باقي seedInvoices كما كانت في ملفك
          تركتها بدون تغيير لأن حجمها كبير جداً.
          فقط تأكد أن البلوك كامل من أول seedInvoices إلى آخر عنصر كما في ملفك الحالي.
      */

    ];

    function $(id){ return document.getElementById(id); }

    function todayStr(){
      const d = new Date();
      return d.toISOString().slice(0,10);
    }

    function generateId(){
      return "inv-" + Math.random().toString(36).slice(2) + "-" + Date.now().toString(36);
    }

    function formatIQD(num){
      if(isNaN(num)) num = 0;
      return "IQD " + num.toLocaleString("en-US", {maximumFractionDigits:0});
    }

    function parseNumber(v){ if(typeof v!=="string") v=String(v||""); return Number(v.replace(/[^\d.-]/g,"")) || 0; }

    function createItemRow(data={}){
      const tr = document.createElement("tr");
      tr.className = "item-row";
      tr.innerHTML = `
        <td class="no-cell"></td>
        <td><textarea class="cell-textarea cell-desc">${data.desc || ""}</textarea></td>
        <td><input class="cell-input cell-loc" value="${data.location || ""}"></td>
        <td><input class="cell-input cell-date" value="${data.date || ""}"></td>
        <td><input class="cell-input cell-unit" value="${data.unit || ""}"></td>
        <td><input class="cell-input cell-qty" type="number" min="0" step="0.01" value="${data.qty != null ? data.qty : 1}"></td>
        <td><input class="cell-input cell-price" type="number" min="0" step="0.01" value="${data.price != null ? data.price : 0}"></td>
        <td><input class="cell-input cell-total" type="text" value=""></td>
        <td><button type="button" class="btn btn-sm btn-danger btn-remove-row">✕</button></td>
      `;
      tr.querySelector(".cell-qty").addEventListener("input", ()=>recalcRow(tr));
      tr.querySelector(".cell-price").addEventListener("input", ()=>recalcRow(tr));
      tr.querySelector(".btn-remove-row").addEventListener("click", ()=>{
        tr.remove();
        updateRowNumbers();
        recalcTotals();
      });
      recalcRow(tr);
      return tr;
    }

    function updateRowNumbers(){
      const rows = document.querySelectorAll("#items-body .item-row");
      rows.forEach((tr,idx)=>{
        const cell = tr.querySelector(".no-cell");
        if(cell) cell.textContent = idx+1;
      });
    }

    function recalcRow(tr){
      const qty = parseNumber(tr.querySelector(".cell-qty").value);
      const price = parseNumber(tr.querySelector(".cell-price").value);
      const total = qty * price;
      tr.querySelector(".cell-total").value = formatIQD(total);
      return total;
    }

    function recalcTotals(){
      const rows = document.querySelectorAll("#items-body .item-row");
      let subtotal = 0;
      rows.forEach(tr => subtotal += recalcRow(tr));
      const discount = parseNumber($("f-discount").value);
      const taxPerc  = parseNumber($("f-tax").value);
      const shipping = parseNumber($("f-shipping").value);
      const subLess = subtotal - discount;
      const taxVal  = subLess * (taxPerc/100);
      const balance = subLess + taxVal + shipping;
      $("f-subtotal").value = formatIQD(subtotal);
      $("f-sub-less").value = formatIQD(subLess);
      $("f-balance").value  = formatIQD(balance);
    }

    function readForm(inv){
      inv.number      = $("f-number").value.trim();
      inv.issueDate   = $("f-date").value.trim();
      inv.dueDate     = $("f-due").value.trim();
      inv.contract    = $("f-contract").value.trim();
      inv.billTo      = $("f-billto").value.trim();
      inv.scope       = $("f-scope").value.trim();
      inv.status      = $("status-select").value;
      inv.note        = $("f-note").value.trim();
      const firstLine = inv.billTo.split("\n")[0] || "";
      inv.customerName = firstLine;

      const rows = document.querySelectorAll("#items-body .item-row");
      inv.items = Array.from(rows).map(tr=>({
        desc:     tr.querySelector(".cell-desc").value.trim(),
        location: tr.querySelector(".cell-loc").value.trim(),
        date:     tr.querySelector(".cell-date").value.trim(),
        unit:     tr.querySelector(".cell-unit").value.trim(),
        qty:      parseNumber(tr.querySelector(".cell-qty").value),
        price:    parseNumber(tr.querySelector(".cell-price").value)
      }));

      inv.discount = parseNumber($("f-discount").value);
      inv.taxPerc  = parseNumber($("f-tax").value);
      inv.shipping = parseNumber($("f-shipping").value);

      const subtotal = parseNumber($("f-subtotal").value);
      const balance  = parseNumber($("f-balance").value);
      inv.subtotal = subtotal;
      inv.balance  = balance;
      inv.status   = String(inv.status || "draft").toLowerCase();
      inv = normalizeInvoice(inv);
    }

    function fillForm(inv){
      $("f-number").value   = inv.number      || "";
      $("f-date").value     = inv.issueDate   || todayStr();
      $("f-due").value      = inv.dueDate     || "";
      $("f-contract").value = inv.contract    || "";
      $("f-billto").value   = inv.billTo      || "";
      $("f-scope").value    = inv.scope       || "";
      $("f-note").value     = inv.note        || "";
      $("status-select").value = inv.status || "draft";

      $("items-body").innerHTML = "";
      const items = inv.items && inv.items.length ? inv.items : [{},{},{},{}];
      items.forEach(it => $("items-body").appendChild(createItemRow(it)));
      updateRowNumbers();

      $("f-discount").value = inv.discount != null ? inv.discount : 0;
      $("f-tax").value      = inv.taxPerc  != null ? inv.taxPerc  : 0;
      $("f-shipping").value = inv.shipping != null ? inv.shipping : 0;

      recalcTotals();
      $("editor-subtitle").textContent = inv.number ? `(${inv.number})` : "";
    }

    function loadInvoices(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const arr = JSON.parse(raw);
          if(Array.isArray(arr) && arr.length){
            invoices = arr.map(normalizeInvoice);
            return;
          }
        }
      }catch(e){
        console.error("Error loading invoices:", e);
      }

      // If no stored data in browser, load default Excel-seeded data
      if (typeof seedInvoices !== "undefined" && Array.isArray(seedInvoices) && seedInvoices.length){
        invoices = seedInvoices.slice().map(normalizeInvoice);
        saveInvoices();
      }
    }

    function saveInvoices(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
      renderPoFilterOptions();
      renderDashboard();
      renderReport();
    }

function showDashboard() {
  const dash = $("dashboard");
  const editor = $("editor");

  if (dash) dash.style.display = "";
  if (editor) editor.style.display = "none";
}

function showEditor() {
  const dash = $("dashboard");
  const editor = $("editor");

  if (dash) dash.style.display = "none";
  if (editor) editor.style.display = "";
}
function showEditor() {
  const dash = $("dashboard");
  const editor = $("editor");

  if (dash) dash.style.display = "none";
  if (editor) editor.style.display = "";
}

    function createNewInvoice(){
      currentId = null;
      const empty = {
        id: generateId(),
        number: "",
        issueDate: todayStr(),
        dueDate: "",
        contract: "",
        billTo: "",
        customerName: "",
        scope: "",
        note: "",
        items: [],
        subtotal: 0,
        discount: 0,
        taxPerc: 0,
        shipping: 0,
        balance: 0,
        status: "draft",
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      fillForm(empty);
      showEditor();
    }

    function openEditor(id){
      const inv = invoices.find(i=>i.id===id);
      if(!inv) return;
      currentId = id;
      fillForm(inv);
      showEditor();
    }

    function isOverdue(inv){
      if(inv.status==="paid") return false;
      if(!inv.dueDate) return false;
      const d = new Date(inv.dueDate);
      const today = new Date(todayStr());
      return d < today;
    }

    function isDueSoon(inv){
      if(inv.status==="paid") return false;
      if(!inv.dueDate) return false;
      const d = new Date(inv.dueDate);
      const today = new Date(todayStr());
      const diff = (d - today)/(1000*60*60*24);
      return diff>=0 && diff<=30;
    }

    function getStatusBadge(status,inv){
      let cls="badge-draft",txt="Draft";
      if(status==="paid"){cls="badge-paid";txt="Paid";}
      else if(status==="unpaid"){
        cls = isOverdue(inv)?"badge-overdue":"badge-unpaid";
        txt = isOverdue(inv)?"Overdue":"Unpaid";
      }
      return `<span class="badge ${cls}">${txt}</span>`;
    }

    function renderPoFilterOptions(){
      const select = $("po-filter");
      if(!select) return;
      const contracts = Array.from(new Set(invoices.map(inv=>inv.contract).filter(Boolean)));
      select.innerHTML = `<option value="all">All PO Numbers</option>` +
        contracts.map(po=>`<option value="${po}">${po}</option>`).join("");
    }

    function matchesFilters(inv){
      if(currentPoFilter!=="all" && inv.contract!==currentPoFilter) return false;
      if(currentFilter==="paid"   && inv.status!=="paid")   return false;
      if(currentFilter==="unpaid" && inv.status!=="unpaid") return false;
      if(currentFilter==="draft"  && inv.status!=="draft")  return false;
      if(currentFilter==="overdue" && !isOverdue(inv))      return false;

      if(specialFilter==="due-soon" && !isDueSoon(inv)) return false;
      if(specialFilter==="high-value" && inv.balance < 10000000) return false;

      return true;
    }

    function renderDashboard(){
      const tbody = $("invoice-table-body");
      if(!tbody) return;
      tbody.innerHTML = "";
      const filtered = invoices.filter(matchesFilters);

      filtered.forEach(inv=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${inv.issueDate || ""}</td>
          <td>${inv.dueDate || ""}</td>
          <td>${inv.number || ""}</td>
          <td>${inv.contract || ""}</td>
          <td>${getStatusBadge(inv.status,inv)}</td>
          <td>${formatIQD(inv.balance || 0)}</td>
          <td>
            <button class="btn btn-sm" onclick="editInvoice('${inv.id}')">Edit</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      $("dash-total").textContent   = invoices.length;
      $("dash-paid").textContent    = invoices.filter(i=>i.status==="paid").length;
      $("dash-unpaid").textContent  = invoices.filter(i=>i.status==="unpaid").length;
      $("dash-draft").textContent   = invoices.filter(i=>i.status==="draft").length;
      $("dash-overdue").textContent = invoices.filter(i=>isOverdue(i)).length;
    }

    function renderReport(){
      const tbody = $("report-body");
      if(!tbody) return;
      tbody.innerHTML = "";

      let paidTotal=0, unpaidTotal=0, draftTotal=0, overdueTotal=0;

      invoices.forEach(inv=>{
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${inv.number}</td>
          <td>${inv.contract}</td>
          <td>${inv.issueDate}</td>
          <td>${inv.dueDate}</td>
          <td>${inv.status}</td>
          <td>${formatIQD(inv.balance || 0)}</td>
        `;
        tbody.appendChild(row);

        if(inv.status==="paid") paidTotal += inv.balance || 0;
        else if(inv.status==="unpaid") unpaidTotal += inv.balance || 0;
        else if(inv.status==="draft") draftTotal += inv.balance || 0;
        if(isOverdue(inv)) overdueTotal += inv.balance || 0;
      });

      $("rep-paid").textContent    = formatIQD(paidTotal);
      $("rep-unpaid").textContent  = formatIQD(unpaidTotal);
      $("rep-draft").textContent   = formatIQD(draftTotal);
      $("rep-overdue").textContent = formatIQD(overdueTotal);
    }

    function saveCurrentInvoice(){
      let inv = currentId ? invoices.find(i=>i.id===currentId) : null;
      if(!inv){
        inv = {
          id: generateId(),
          createdAt: new Date().toISOString()
        };
        invoices.push(inv);
        currentId = inv.id;
      }
      readForm(inv);
      inv.updatedAt = new Date().toISOString();
      saveInvoices();
      alert("Invoice saved ✅");
    }

    function deleteInvoiceById(id){
      if(!confirm("Are you sure you want to delete this invoice?")) return;
      invoices = invoices.filter(i=>i.id!==id);
      if(currentId===id) currentId = null;
      saveInvoices();
    }

    function editInvoice(id){
      openEditor(id);
    }

    function importJsonFromFile(file){
      const reader = new FileReader();
      reader.onload = e=>{
        try{
          const data = JSON.parse(e.target.result);
          if(!Array.isArray(data)){ alert("Invalid JSON file."); return; }
          if(!confirm("All current invoices will be replaced with data from this file. Are you sure?")) return;
          invoices = data.map(normalizeInvoice);
          currentId = null;
          saveInvoices();
          showDashboard();
          alert("JSON data restored successfully ✅");
        }catch(e){
          console.error(e);
          alert("Failed to import JSON file.");
        }
      };
      reader.readAsText(file);
    }

    function exportJson(){
      const blob = new Blob([JSON.stringify(invoices,null,2)],{type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "invoices-backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportCsv(){
      if(!invoices.length){ alert("No invoices to export."); return; }
      const headers = ["Number","PO","Issue Date","Due Date","Status","Balance"];
      const rows = invoices.map(inv=>[
        inv.number,
        inv.contract,
        inv.issueDate,
        inv.dueDate,
        inv.status,
        inv.balance
      ]);
      const csv = [headers.join(","), ...rows.map(r=>r.join(","))].join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "invoices-report.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function resetSystem(){
      if(!confirm("This will reset all invoices to the default seeded data. Continue?")) return;
      invoices = seedInvoices.slice().map(normalizeInvoice);
      currentId = null;
      saveInvoices();
    }

function setupEvents(){
  const btnNew = $("btn-new");
  if (btnNew) btnNew.addEventListener("click", createNewInvoice);

  const btnSave = $("btn-save");
  if (btnSave) btnSave.addEventListener("click", saveCurrentInvoice);

  const btnBack = $("btn-back");
  if (btnBack) btnBack.addEventListener("click", showDashboard);

  const btnPrint = $("btn-print");
  if (btnPrint) btnPrint.addEventListener("click", () => window.print());

  const bJson = $("btn-save-json");
  if (bJson) bJson.addEventListener("click", exportJson);

  const bExp  = $("btn-export");
  if (bExp)  bExp.addEventListener("click", exportCsv);

  const bLJ   = $("btn-load-json");
  if (bLJ)   bLJ.addEventListener("click", () => $("json-file-input")?.click());

  const bRes  = $("btn-reset");
  if (bRes)  bRes.addEventListener("click", resetSystem);

  const fileInput = $("json-file-input");
  if (fileInput) fileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) importJsonFromFile(file);
    e.target.value = "";
  });

  const poSel = $("po-filter");
  if (poSel) poSel.addEventListener("change", e => {
    currentPoFilter = e.target.value;
    renderDashboard();
  });

  document.querySelectorAll(".status-pill").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".status-pill").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentFilter = btn.dataset.filter;
      specialFilter = "none";
      renderDashboard();
    });
  });
}


    function highlightCard(type){
      document.querySelectorAll(".stat-card").forEach(c=>c.classList.remove("active"));
      const el = document.querySelector(`.stat-card[data-type="${type}"]`);
      if(el) el.classList.add("active");
    }

    // Make functions available for onclick even if something fails
    window.createNewInvoice = createNewInvoice;
    window.editInvoice      = editInvoice;
    window.deleteInvoiceById= deleteInvoiceById;

function init() {
  setupEvents();
  loadInvoices();
  renderPoFilterOptions();
  showDashboard();
  highlightCard("total");
  renderDashboard();
  renderReport();
}

// تأكد أن الـ DOM جاهز قبل استدعاء init
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", init);
} else {
  init();
}
  </script>
