<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>منصة إدارة الفواتير</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap من CDN لسهولة التنسيق -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  />
  <style>
    body {
      background-color: #f5f5f5;
    }
    .status-paid {
      color: #0a7c3b;
      font-weight: bold;
    }
    .status-unpaid {
      color: #c0392b;
      font-weight: bold;
    }
    .card {
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    textarea {
      resize: vertical;
    }
    .table-responsive {
      max-height: 60vh;
      overflow-y: auto;
    }
  </style>
</head>
<body class="p-3">
  <div class="container-fluid">
    <div class="row g-3">
      <!-- العمود الأيسر: الفورم -->
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0" id="form-title">إضافة فاتورة جديدة</h5>
          </div>
          <div class="card-body">
            <form id="invoice-form">
              <!-- id مخفي للتعديل -->
              <input type="hidden" id="invoice-id" />

              <div class="mb-2">
                <label class="form-label">NO.</label>
                <input type="number" class="form-control" id="no" />
              </div>

              <div class="mb-2">
                <label class="form-label">PO</label>
                <input type="text" class="form-control" id="po" required />
              </div>

              <div class="mb-2">
                <label class="form-label">INVOICE NO.</label>
                <input
                  type="text"
                  class="form-control"
                  id="invoice_no"
                  required
                />
              </div>

              <div class="mb-2">
                <label class="form-label">DATE</label>
                <!-- يمكن كتابة Mar-24 أو تاريخ حقيقي -->
                <input
                  type="text"
                  class="form-control"
                  id="date"
                  placeholder="Mar-24 أو 2024-03-01"
                  required
                />
              </div>

              <div class="mb-2">
                <label class="form-label">DESCRIPTION</label>
                <textarea
                  class="form-control"
                  id="description"
                  rows="3"
                  required
                ></textarea>
              </div>

              <div class="row">
                <div class="col-md-6 mb-2">
                  <label class="form-label">DURATION FROM</label>
                  <input
                    type="text"
                    class="form-control"
                    id="duration_from"
                    placeholder="01-Mar-24"
                    required
                  />
                </div>
                <div class="col-md-6 mb-2">
                  <label class="form-label">DURATION TO</label>
                  <input
                    type="text"
                    class="form-control"
                    id="duration_to"
                    placeholder="31-Mar-24"
                    required
                  />
                </div>
              </div>

              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label">UNIT</label>
                  <select class="form-select" id="unit" required>
                    <option value="">اختيار</option>
                    <option value="Lot">Lot</option>
                    <option value="Liters">Liters</option>
                  </select>
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">QTY</label>
                  <input
                    type="number"
                    class="form-control"
                    id="qty"
                    step="0.001"
                    required
                  />
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">INVOICE AMOUNT</label>
                  <input
                    type="number"
                    class="form-control"
                    id="invoice_amount"
                    step="0.01"
                    required
                  />
                </div>
              </div>

              <div class="mb-2">
                <label class="form-label">TOTAL</label>
                <input
                  type="number"
                  class="form-control"
                  id="total"
                  step="0.01"
                  readonly
                />
                <div class="form-text">
                  يُحتسب تلقائيًا = QTY × INVOICE AMOUNT، ويمكن تعديله من
                  الكود إذا أردت.
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">STATUS</label>
                <select class="form-select" id="status" required>
                  <option value="Paid">Paid</option>
                  <option value="Unpaid">Unpaid</option>
                  <option value="Un-Paid">Un-Paid</option>
                </select>
              </div>

              <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-success" id="save-btn">
                  حفظ الفاتورة
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  id="reset-btn"
                >
                  تنظيف النموذج
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- العمود الأيمن: جدول الفواتير -->
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header bg-dark text-white">
            <div class="d-flex flex-wrap align-items-center gap-2">
              <h5 class="mb-0 flex-grow-1">قائمة الفواتير</h5>
              <select id="filter-status" class="form-select form-select-sm w-auto">
                <option value="">كل الحالات</option>
                <option value="Paid">Paid</option>
                <option value="Unpaid">Unpaid</option>
                <option value="Un-Paid">Un-Paid</option>
              </select>
              <input
                type="text"
                id="filter-po"
                class="form-control form-control-sm w-auto"
                placeholder="تصفية حسب PO"
              />
              <button class="btn btn-sm btn-light" id="refresh-btn">
                تحديث
              </button>
            </div>
          </div>
          <div class="card-body table-responsive">
            <table class="table table-striped table-hover table-sm mb-0">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>PO</th>
                  <th>INVOICE NO.</th>
                  <th>DATE</th>
                  <th>DESCRIPTION</th>
                  <th>UNIT</th>
                  <th>QTY</th>
                  <th>TOTAL (IQD)</th>
                  <th>STATUS</th>
                  <th>خيارات</th>
                </tr>
              </thead>
              <tbody id="invoices-body">
                <!-- الصفوف ستُملأ من جافاسكربت -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api/invoices'; // نفس السيرفر

    const invoicesBody = document.getElementById('invoices-body');
    const form = document.getElementById('invoice-form');
    const formTitle = document.getElementById('form-title');
    const saveBtn = document.getElementById('save-btn');
    const resetBtn = document.getElementById('reset-btn');

    const idInput = document.getElementById('invoice-id');
    const noInput = document.getElementById('no');
    const poInput = document.getElementById('po');
    const invoiceNoInput = document.getElementById('invoice_no');
    const dateInput = document.getElementById('date');
    const descInput = document.getElementById('description');
    const durationFromInput = document.getElementById('duration_from');
    const durationToInput = document.getElementById('duration_to');
    const unitInput = document.getElementById('unit');
    const qtyInput = document.getElementById('qty');
    const invoiceAmountInput = document.getElementById('invoice_amount');
    const totalInput = document.getElementById('total');
    const statusInput = document.getElementById('status');

    const filterStatus = document.getElementById('filter-status');
    const filterPo = document.getElementById('filter-po');
    const refreshBtn = document.getElementById('refresh-btn');

    // حساب التوتال تلقائياً
    function updateTotal() {
      const qty = parseFloat(qtyInput.value) || 0;
      const price = parseFloat(invoiceAmountInput.value) || 0;
      totalInput.value = qty * price;
    }

    qtyInput.addEventListener('input', updateTotal);
    invoiceAmountInput.addEventListener('input', updateTotal);

    // تحميل الفواتير من السيرفر
    async function loadInvoices() {
      invoicesBody.innerHTML = '<tr><td colspan="10">جاري التحميل...</td></tr>';

      const params = new URLSearchParams();
      if (filterStatus.value) params.append('status', filterStatus.value);
      if (filterPo.value.trim()) params.append('po', filterPo.value.trim());

      try {
        const res = await fetch(API_URL + (params.toString() ? `?${params}` : ''));
        const data = await res.json();

        if (!Array.isArray(data)) {
          invoicesBody.innerHTML =
            '<tr><td colspan="10" class="text-danger">خطأ في قراءة البيانات</td></tr>';
          return;
        }

        if (data.length === 0) {
          invoicesBody.innerHTML =
            '<tr><td colspan="10" class="text-center">لا توجد فواتير</td></tr>';
          return;
        }

        invoicesBody.innerHTML = '';
        data.forEach((inv, index) => {
          const tr = document.createElement('tr');

          const statusClass =
            inv.status === 'Paid' ? 'status-paid' : 'status-unpaid';

          tr.innerHTML = `
            <td>${inv.no ?? index + 1}</td>
            <td>${inv.po}</td>
            <td>${inv.invoice_no}</td>
            <td>${inv.date}</td>
            <td style="min-width:220px">${inv.description}</td>
            <td>${inv.unit}</td>
            <td>${inv.qty}</td>
            <td>${Number(inv.total).toLocaleString('en-US')}</td>
            <td class="${statusClass}">${inv.status}</td>
            <td>
              <button class="btn btn-sm btn-primary me-1" data-action="edit" data-id="${inv.id}">
                تعديل
              </button>
              <button class="btn btn-sm btn-danger" data-action="delete" data-id="${inv.id}">
                حذف
              </button>
            </td>
          `;
          invoicesBody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        invoicesBody.innerHTML =
          '<tr><td colspan="10" class="text-danger">فشل الاتصال بالسيرفر</td></tr>';
      }
    }

    // تعبئة النموذج عند الضغط على تعديل
    function fillForm(invoice) {
      idInput.value = invoice.id;
      noInput.value = invoice.no ?? '';
      poInput.value = invoice.po;
      invoiceNoInput.value = invoice.invoice_no;
      dateInput.value = invoice.date;
      descInput.value = invoice.description;
      durationFromInput.value = invoice.duration_from;
      durationToInput.value = invoice.duration_to;
      unitInput.value = invoice.unit;
      qtyInput.value = invoice.qty;
      invoiceAmountInput.value = invoice.invoice_amount;
      totalInput.value = invoice.total;
      statusInput.value = invoice.status;

      formTitle.textContent = 'تعديل فاتورة';
      saveBtn.textContent = 'تحديث الفاتورة';
    }

    // تنظيف النموذج
    function resetForm() {
      idInput.value = '';
      form.reset();
      totalInput.value = '';
      formTitle.textContent = 'إضافة فاتورة جديدة';
      saveBtn.textContent = 'حفظ الفاتورة';
    }

    resetBtn.addEventListener('click', resetForm);

    // عند الضغط على تعديل أو حذف من الجدول
    invoicesBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id');
      if (!id) return;

      if (action === 'edit') {
        // جلب الفاتورة ثم تعبئة الفورم
        try {
          const res = await fetch(`${API_URL}/${id}`);
          if (!res.ok) {
            alert('فشل في جلب بيانات الفاتورة');
            return;
          }
          const invoice = await res.json();
          fillForm(invoice);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch (err) {
          console.error(err);
          alert('فشل الاتصال بالسيرفر');
        }
      } else if (action === 'delete') {
        if (!confirm('هل أنت متأكد من حذف هذه الفاتورة؟')) return;

        try {
          const res = await fetch(`${API_URL}/${id}`, {
            method: 'DELETE'
          });
          if (!res.ok) {
            alert('فشل في حذف الفاتورة');
            return;
          }
          await loadInvoices();
          if (idInput.value === id) resetForm();
        } catch (err) {
          console.error(err);
          alert('فشل الاتصال بالسيرفر');
        }
      }
    });

    // حفظ / تحديث الفاتورة
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const payload = {
        no: noInput.value ? Number(noInput.value) : null,
        po: poInput.value.trim(),
        invoice_no: invoiceNoInput.value.trim(),
        date: dateInput.value.trim(),
        description: descInput.value.trim(),
        duration_from: durationFromInput.value.trim(),
        duration_to: durationToInput.value.trim(),
        unit: unitInput.value,
        qty: Number(qtyInput.value),
        invoice_amount: Number(invoiceAmountInput.value),
        total: Number(totalInput.value || 0),
        status: statusInput.value
      };

      const id = idInput.value;
      const isEdit = !!id;

      try {
        const res = await fetch(isEdit ? `${API_URL}/${id}` : API_URL, {
          method: isEdit ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          console.error('Error', errData);
          alert('حدث خطأ في حفظ الفاتورة');
          return;
        }

        await loadInvoices();
        resetForm();
      } catch (err) {
        console.error(err);
        alert('فشل الاتصال بالسيرفر');
      }
    });

    // فلاتر
    filterStatus.addEventListener('change', loadInvoices);
    filterPo.addEventListener('keyup', (e) => {
      // عند الضغط Enter أو مسح النص
      if (e.key === 'Enter' || e.key === 'Backspace' || e.key === 'Delete') {
        loadInvoices();
      }
    });
    refreshBtn.addEventListener('click', loadInvoices);

    // تحميل أولي
    loadInvoices();
  </script>
</body>
</html>
