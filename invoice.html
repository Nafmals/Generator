// ===============================
// INVOICE APP CORE SCRIPT
// Enable: New Invoice + Edit Invoice
// ===============================

// GLOBAL STATE =====================
let invoices = [];
let editMode = false;
let currentInvoiceId = null;

// Load JSON file ==================
document.getElementById("loadJsonBtn").addEventListener("change", function(event){
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e){
        invoices = JSON.parse(e.target.result);
        renderInvoices();
    };
    reader.readAsText(file);
});

// Save JSON file ==================
document.getElementById("saveJsonBtn").addEventListener("click", function(){
    const dataStr = JSON.stringify(invoices, null, 2);
    const blob = new Blob([dataStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "invoices.json";
    a.click();
});

// =============================================================
// SHOW FORM FOR NEW INVOICE
// =============================================================
document.getElementById("btnNewInvoice").addEventListener("click", function(){
    editMode = false;
    currentInvoiceId = null;

    clearForm();
    document.getElementById("invoiceFormModal").style.display = "block";
});

// =============================================================
// EDIT INVOICE
// =============================================================
function editInvoice(id){
    const inv = invoices.find(i => i.id === id);
    if(!inv){ alert("Invoice not found!"); return; }

    editMode = true;
    currentInvoiceId = id;

    // Fill form
    document.getElementById("invNumber").value = inv.number;
    document.getElementById("invIssue").value  = inv.issueDate;
    document.getElementById("invDue").value    = inv.dueDate;
    document.getElementById("invContract").value = inv.contract;
    document.getElementById("invStatus").value = inv.status;

    document.getElementById("invoiceFormModal").style.display = "block";
}

// =============================================================
// SAVE INVOICE (NEW or EDIT)
// =============================================================
document.getElementById("btnSaveInvoice").addEventListener("click", function(){

    const newInv = {
        id: currentInvoiceId || (Date.now()+""),
        number: document.getElementById("invNumber").value,
        issueDate: document.getElementById("invIssue").value,
        dueDate: document.getElementById("invDue").value,
        contract: document.getElementById("invContract").value,
        status: document.getElementById("invStatus").value.toLowerCase()
    };

    if(editMode){
        // update existing invoice
        const i = invoices.findIndex(x => x.id === currentInvoiceId);
        invoices[i] = {...invoices[i], ...newInv};
    } else {
        invoices.push(newInv);
    }

    document.getElementById("invoiceFormModal").style.display = "none";
    renderInvoices();
});

// =============================================================
// DELETE INVOICE
// =============================================================
function deleteInvoice(id){
    if(!confirm("Delete invoice?")) return;
    invoices = invoices.filter(x => x.id !== id);
    renderInvoices();
}

// =============================================================
// RENDER INVOICE LIST
// =============================================================
function renderInvoices(){
    const tbody = document.getElementById("invoiceTableBody");
    tbody.innerHTML = "";

    invoices.forEach(inv => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${inv.issueDate}</td>
            <td>${inv.dueDate}</td>
            <td>${inv.number}</td>
            <td>${inv.contract}</td>
            <td>${inv.status === "paid" ? "✔ Paid" : "❗ Unpaid"}</td>
            <td>
                <button onclick="editInvoice('${inv.id}')" class="btn-edit">Edit</button>
                <button onclick="deleteInvoice('${inv.id}')" class="btn-delete">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// =============================================================
// CLEAR FORM
// =============================================================
function clearForm(){
    document.getElementById("invNumber").value = "";
    document.getElementById("invIssue").value = "";
    document.getElementById("invDue").value = "";
    document.getElementById("invContract").value = "";
    document.getElementById("invStatus").value = "unpaid";
}
