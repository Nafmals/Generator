// app.js
// سكربت واحد كامل:
// - يحتوي بيانات الفواتير (seedInvoices)
// - يحفظها في ملف JSON (invoices_data.json)
// - يحملها عند التشغيل
// - يوفر API: عرض / إضافة / تعديل / حذف / إحصائيات
// - يوفر واجهة ويب بسيطة لإدارة الفواتير من المتصفح

const express = require('express');
const cors = require('cors');
const fs = require('fs');
const path = require('path');

// =======================
// 1) بيانات الفواتير الأولية (من الجدول الذي أرسلته)
// =======================
const seedInvoices = [
  // ====== Generator rental PO00023 ======
  {
    po: "PO00023",
    invoice_no: "CP-INV00001",
    date: "Mar-24",
    description: "Generator rental: 200KVA, including operators available 24/7 and a 3000-liter fuel tank.",
    duration_from: "01-Mar-24",
    duration_to: "31-Mar-24",
    unit: "Lot",
    qty: 1,
    invoice_amount: "IQD 5,500,000",
    total: "IQD 5,500,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00001",
    date: "Mar-24",
    description: "Generator rental: 200KVA, including operators available 24/7 and a 3000-liter fuel tank.",
    duration_from: "01-Apr-24",
    duration_to: "30-Apr-24",
    unit: "Lot",
    qty: 1,
    invoice_amount: "IQD 5,500,000",
    total: "IQD 5,500,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00003",
    date: "May-24",
    description: "Generator rental: 200KVA, including operators available 24/7 and a 3000-liter fuel tank.",
    duration_from: "01-May-24",
    duration_to: "31-May-24",
    unit: "Lot",
    qty: 1,
    invoice_amount: "IQD 5,500,000",
    total: "IQD 5,500,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00004",
    date: "Jun-24",
    description: "Generator rental: 200KVA, including operators available 24/7 and a 3000-liter fuel tank.",
    duration_from: "01-Jun-24",
    duration_to: "30-Jun-24",
    unit: "Lot",
    qty: 1,
    invoice_amount: "IQD 5,500,000",
    total: "IQD 5,500,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00005",
    date: "Jul-24",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Jul-24",
    duration_to: "31-Jul-24",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00006",
    date: "Jul-24",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Aug-24",
    duration_to: "31-Aug-24",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00009",
    date: "Sep-24",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Sep-24",
    duration_to: "30-Sep-24",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00010",
    date: "Oct-24",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Oct-24",
    duration_to: "30-Oct-24",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00012",
    date: "Dec-24",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Nov-24",
    duration_to: "30-Nov-24",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00012",
    date: "Dec-24",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Dec-24",
    duration_to: "31-Dec-24",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00013",
    date: "Jan-25",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Jan-25",
    duration_to: "31-Jan-25",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00015",
    date: "Feb-25",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Feb-25",
    duration_to: "28-Feb-25",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00015",
    date: "Mar-25",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Mar-25",
    duration_to: "31-Mar-25",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00016",
    date: "Apr-25",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Apr-25",
    duration_to: "30-Apr-25",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Unpaid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00016",
    date: "May-25",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-May-25",
    duration_to: "31-May-25",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Unpaid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00018",
    date: "Jun-25",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Jun-25",
    duration_to: "30-Jun-25",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Unpaid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00018",
    date: "Jul-25",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Jul-25",
    duration_to: "31-Jul-25",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 6,750,000",
    total: "IQD 6,750,000",
    status: "Unpaid"
  },

  // ====== Contract 4400013837 ======
  {
    po: "4400013837",
    invoice_no: "NA-2025-INV00024",
    date: "Aug-25",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Aug-25",
    duration_to: "31-Aug-25",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 8,650,000",
    total: "IQD 8,650,000",
    status: "Paid"
  },
  {
    po: "4400013837",
    invoice_no: "NA-2025-INV00026",
    date: "Sep-25",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Sep-25",
    duration_to: "30-Sep-25",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 8,650,000",
    total: "IQD 8,650,000",
    status: "Paid"
  },
  {
    po: "4400013837",
    invoice_no: "NA-2025-INV00031",
    date: "Oct-25",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Oct-25",
    duration_to: "31-Oct-25",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 8,650,000",
    total: "IQD 8,650,000",
    status: "Paid"
  },
  {
    po: "4400013837",
    invoice_no: "NA-2025-INV00036",
    date: "Nov-25",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Nov-25",
    duration_to: "30-Nov-25",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 8,650,000",
    total: "IQD 8,650,000",
    status: "Unpaid"
  },
  {
    po: "4400013837",
    invoice_no: "NA-2025-D-INV00039",
    date: "Dec-25",
    description: "Rental of 2 Electric Power Generation : 200 KVA and 150 KVA, including 24/7 operator availability, 1 ATS, and a 3000-liter fuel tank.",
    duration_from: "01-Dec-25",
    duration_to: "31-Dec-25",
    unit: "Lot",
    qty: 2,
    invoice_amount: "IQD 8,650,000",
    total: "IQD 8,650,000",
    status: "Unpaid"
  },

  // ====== Contract 4400013503 ======
  {
    po: "4400013503",
    invoice_no: "CP-INV-D-00001",
    date: "Mar-24",
    description: "Generators rental: 2x 150KVA, including operators available 24/7 and a 5000-liter fuel tank.",
    duration_from: "01-Feb-25",
    duration_to: "28-Feb-25",
    unit: "Lot",
    qty: 1,
    invoice_amount: "IQD 12,000,000",
    total: "IQD 12,000,000",
    status: "Paid"
  },
  {
    po: "4400013503",
    invoice_no: "CP-INV-D-00002",
    date: "Mar-25",
    description: "Generators rental: 2x 150KVA, including operators available 24/7 and a 5000-liter fuel tank.",
    duration_from: "01-Mar-25",
    duration_to: "31-Mar-25",
    unit: "Lot",
    qty: 1,
    invoice_amount: "IQD 12,000,000",
    total: "IQD 12,000,000",
    status: "Paid"
  },
  {
    po: "4400013503",
    invoice_no: "CP-INV-D-00003",
    date: "Apr-25",
    description: "Generators rental: 2x 150KVA, including operators available 24/7 and a 5000-liter fuel tank.",
    duration_from: "01-Apr-25",
    duration_to: "30-Apr-25",
    unit: "Lot",
    qty: 1,
    invoice_amount: "IQD 12,000,000",
    total: "IQD 12,000,000",
    status: "Paid"
  },
  {
    po: "4400013503",
    invoice_no: "CP-INV-D-00004",
    date: "Aug-25",
    description: "Generators rental: 2x 150KVA, including operators available 24/7 and a 5000-liter fuel tank.",
    duration_from: "01-Aug-25",
    duration_to: "31-Aug-25",
    unit: "Lot",
    qty: 1,
    invoice_amount: "IQD 12,000,000",
    total: "IQD 12,000,000",
    status: "Unpaid"
  },
  {
    po: "4400013503",
    invoice_no: "CP-INV-D-00005",
    date: "Sep-25",
    description: "Generators rental: 2x 150KVA, including operators available 24/7 and a 5000-liter fuel tank.",
    duration_from: "01-Sep-25",
    duration_to: "30-Sep-25",
    unit: "Lot",
    qty: 1,
    invoice_amount: "IQD 12,000,000",
    total: "IQD 12,000,000",
    status: "Unpaid"
  },
  {
    po: "4400013503",
    invoice_no: "CP-INV-D-00006",
    date: "Oct-25",
    description: "Generators rental: 2x 150KVA, including operators available 24/7 and a 5000-liter fuel tank.",
    duration_from: "01-Oct-25",
    duration_to: "31-Oct-25",
    unit: "Lot",
    qty: 1,
    invoice_amount: "IQD 12,000,000",
    total: "IQD 12,000,000",
    status: "Unpaid"
  },
  {
    po: "4400013503",
    invoice_no: "CP-INV-D-00007",
    date: "Nov-25",
    description: "Generators rental: 2x 150KVA, including operators available 24/7 and a 5000-liter fuel tank.",
    duration_from: "01-Oct-25",
    duration_to: "31-Oct-25",
    unit: "Lot",
    qty: 1,
    invoice_amount: "IQD 12,000,000",
    total: "IQD 12,000,000",
    status: "Unpaid"
  },
  {
    po: "4400013503",
    invoice_no: "CP-INV-D-00008",
    date: "Dec-25",
    description: "Generators rental: 2x 150KVA, including operators available 24/7 and a 5000-liter fuel tank.",
    duration_from: "01-Oct-25",
    duration_to: "31-Oct-25",
    unit: "Lot",
    qty: 1,
    invoice_amount: "IQD 12,000,000",
    total: "IQD 12,000,000",
    status: "Unpaid"
  },

  // ====== Diesel fuel ======
  {
    po: "PO00023",
    invoice_no: "CP-INV00002",
    date: "05-Mar-24",
    description: "Diesel Fuel for Generators POD 4",
    duration_from: "05-Mar-24",
    duration_to: "05-Mar-24",
    unit: "Liters",
    qty: 2890,
    invoice_amount: "IQD 750",
    total: "IQD 2,167,500",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00002",
    date: "24-Apr-24",
    description: "Diesel Fuel for Generators POD 6",
    duration_from: "24-Apr-24",
    duration_to: "24-Apr-24",
    unit: "Liters",
    qty: 1100,
    invoice_amount: "IQD 750",
    total: "IQD 825,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00002",
    date: "30-Jun-24",
    description: "Diesel Fuel for Generators POD 7",
    duration_from: "30-Jun-24",
    duration_to: "30-Jun-24",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00002",
    date: "30-Jun-24",
    description: "Diesel Fuel for Generators POD 8",
    duration_from: "30-Jun-24",
    duration_to: "30-Jun-24",
    unit: "Liters",
    qty: 2000,
    invoice_amount: "IQD 750",
    total: "IQD 1,500,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00002",
    date: "18-Jul-24",
    description: "Diesel Fuel for Generators POD 9",
    duration_from: "18-Jul-24",
    duration_to: "18-Jul-24",
    unit: "Liters",
    qty: 2100,
    invoice_amount: "IQD 750",
    total: "IQD 1,575,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00007",
    date: "16-Aug-24",
    description: "Diesel Fuel for Generators POD 10",
    duration_from: "16-Aug-24",
    duration_to: "16-Aug-24",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00007",
    date: "28-Aug-24",
    description: "Diesel Fuel for Generators POD 14",
    duration_from: "28-Aug-24",
    duration_to: "28-Aug-24",
    unit: "Liters",
    qty: 2000,
    invoice_amount: "IQD 750",
    total: "IQD 1,500,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00008",
    date: "17-Sep-24",
    description: "Diesel Fuel for Generators POD 15",
    duration_from: "17-Sep-24",
    duration_to: "17-Sep-24",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00008",
    date: "29-Sep-24",
    description: "Diesel Fuel for Generators POD 17",
    duration_from: "29-Sep-24",
    duration_to: "29-Sep-24",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00008",
    date: "05-Oct-24",
    description: "Diesel Fuel for Generators POD 18",
    duration_from: "05-Oct-24",
    duration_to: "05-Oct-24",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00011",
    date: "20-Oct-24",
    description: "Diesel Fuel for Generators POD 19",
    duration_from: "20-Oct-24",
    duration_to: "20-Oct-24",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00011",
    date: "11-Nov-24",
    description: "Diesel Fuel for Generators POD 20",
    duration_from: "11-Nov-24",
    duration_to: "11-Nov-24",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00011",
    date: "18-Nov-24",
    description: "Diesel Fuel for Generators POD 22",
    duration_from: "18-Nov-24",
    duration_to: "18-Nov-24",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00011",
    date: "12-Dec-24",
    description: "Diesel Fuel for Generators POD 23",
    duration_from: "12-Dec-24",
    duration_to: "12-Dec-24",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00014",
    date: "05-Jan-25",
    description: "Diesel Fuel for Generators POD 24",
    duration_from: "05-Jan-25",
    duration_to: "05-Jan-25",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00014",
    date: "28-Jan-25",
    description: "Diesel Fuel for Generators POD 25",
    duration_from: "28-Jan-25",
    duration_to: "28-Jan-25",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00014",
    date: "01-Feb-25",
    description: "Diesel Fuel for Generators POD 28",
    duration_from: "01-Feb-25",
    duration_to: "01-Feb-25",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00014",
    date: "01-Jan-25",
    description: "Diesel Fuel for Generators POD 29",
    duration_from: "01-Jan-25",
    duration_to: "01-Jan-25",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00014",
    date: "12-Mar-25",
    description: "Diesel Fuel for Generators POD 31",
    duration_from: "12-Mar-25",
    duration_to: "12-Mar-25",
    unit: "Liters",
    qty: 2000,
    invoice_amount: "IQD 750",
    total: "IQD 1,500,000",
    status: "Paid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00017",
    date: "09-Jun-25",
    description: "Diesel Fuel for Generators POD 32",
    duration_from: "09-Jun-25",
    duration_to: "09-Jun-25",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Unpaid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00017",
    date: "13-Jun-25",
    description: "Diesel Fuel for Generators POD 33",
    duration_from: "13-Jun-25",
    duration_to: "13-Jun-25",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Unpaid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00017",
    date: "02-Jun-25",
    description: "Diesel Fuel for Generators POD 34",
    duration_from: "02-Jun-25",
    duration_to: "02-Jun-25",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Unpaid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00019",
    date: "20-Jun-25",
    description: "Diesel Fuel for Generators POD 35",
    duration_from: "20-Jun-25",
    duration_to: "20-Jun-25",
    unit: "Liters",
    qty: 2000,
    invoice_amount: "IQD 750",
    total: "IQD 1,500,000",
    status: "Unpaid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00019",
    date: "09-Jul-25",
    description: "Diesel Fuel for Generators POD 36",
    duration_from: "09-Jul-25",
    duration_to: "09-Jul-25",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Unpaid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00019",
    date: "19-Jul-25",
    description: "Diesel Fuel for Generators POD 37",
    duration_from: "19-Jul-25",
    duration_to: "19-Jul-25",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Unpaid"
  },
  {
    po: "PO00023",
    invoice_no: "CP-INV00019",
    date: "24-Jul-25",
    description: "Diesel Fuel for Generators POD 38",
    duration_from: "24-Jul-25",
    duration_to: "24-Jul-25",
    unit: "Liters",
    qty: 1000,
    invoice_amount: "IQD 750",
    total: "IQD 750,000",
    status: "Unpaid"
  }
];

// =======================
// 2) تخزين/تحميل البيانات من ملف JSON
// =======================

const DATA_FILE = path.join(__dirname, 'invoices_data.json');

function parseMoney(v) {
  if (v == null) return 0;
  if (typeof v === 'number') return v;
  return Number(
    String(v)
      .replace(/IQD/gi, '')
      .replace(/,/g, '')
      .trim()
  ) || 0;
}

let invoices = [];

// تحميل البيانات من الملف أو استخدام seed
function loadInvoices() {
  if (fs.existsSync(DATA_FILE)) {
    const raw = fs.readFileSync(DATA_FILE, 'utf8');
    invoices = JSON.parse(raw);
  } else {
    invoices = seedInvoices.map((inv, idx) => ({ id: idx + 1, ...inv }));
    saveInvoices();
  }
}

// حفظ البيانات إلى الملف
function saveInvoices() {
  fs.writeFileSync(DATA_FILE, JSON.stringify(invoices, null, 2), 'utf8');
}

// حساب الإحصائيات
function calculateStats() {
  let paid = 0;
  let unpaid = 0;
  invoices.forEach(inv => {
    const val = parseMoney(inv.total);
    const isPaid = String(inv.status).toLowerCase().startsWith('paid');
    if (isPaid) paid += val;
    else unpaid += val;
  });
  return { paid, unpaid };
}

// تهيئة البيانات
loadInvoices();

// =======================
// 3) إعداد سيرفر Express
// =======================

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// واجهة ويب بسيطة
app.get('/', (req, res) => {
  res.send(`
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>منصة الفواتير</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  />
  <style>
    body { background:#f5f5f5; }
    .status-paid { color:#0a7c3b; font-weight:bold; }
    .status-unpaid { color:#c0392b; font-weight:bold; }
    .card { box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .table-responsive { max-height:60vh; overflow-y:auto; }
    textarea { font-size:0.85rem; }
  </style>
</head>
<body class="p-3">
<div class="container-fluid">
  <h3 class="mb-3">منصة الفواتير</h3>

  <div class="row g-3 mb-3">
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header bg-dark text-white">الملخص المالي</div>
        <div class="card-body">
          <p class="mb-1">
            <strong>إجمالي المدفوع (Paid):</strong>
            <span id="paid-total">—</span> IQD
          </p>
          <p class="mb-1">
            <strong>إجمالي غير المدفوع (Unpaid):</strong>
            <span id="unpaid-total">—</span> IQD
          </p>
          <button id="reload-btn" class="btn btn-sm btn-secondary mt-2">تحديث البيانات</button>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card">
        <div class="card-header bg-primary text-white">نموذج إضافة / تعديل فاتورة</div>
        <div class="card-body">
          <form id="invoice-form" class="row g-2">
            <input type="hidden" id="id" />
            <div class="col-sm-3">
              <label class="form-label">PO</label>
              <input id="po" class="form-control form-control-sm" required />
            </div>
            <div class="col-sm-3">
              <label class="form-label">Invoice No.</label>
              <input id="invoice_no" class="form-control form-control-sm" required />
            </div>
            <div class="col-sm-3">
              <label class="form-label">Date</label>
              <input id="date" class="form-control form-control-sm" required />
            </div>
            <div class="col-sm-3">
              <label class="form-label">Status</label>
              <select id="status" class="form-select form-select-sm">
                <option value="Paid">Paid</option>
                <option value="Unpaid">Unpaid</option>
                <option value="Un-Paid">Un-Paid</option>
              </select>
            </div>
            <div class="col-sm-6">
              <label class="form-label">Duration From</label>
              <input id="duration_from" class="form-control form-control-sm" />
            </div>
            <div class="col-sm-6">
              <label class="form-label">Duration To</label>
              <input id="duration_to" class="form-control form-control-sm" />
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea id="description" rows="2" class="form-control form-control-sm"></textarea>
            </div>
            <div class="col-sm-2">
              <label class="form-label">Unit</label>
              <input id="unit" class="form-control form-control-sm" />
            </div>
            <div class="col-sm-2">
              <label class="form-label">Qty</label>
              <input id="qty" type="number" step="0.01" class="form-control form-control-sm" />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Invoice Amount (نص)</label>
              <input id="invoice_amount" class="form-control form-control-sm" placeholder="مثال: IQD 6,750,000" />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Total (نص)</label>
              <input id="total" class="form-control form-control-sm" placeholder="مثال: IQD 6,750,000" />
            </div>
            <div class="col-12 d-flex gap-2 mt-2">
              <button type="submit" class="btn btn-sm btn-success">حفظ</button>
              <button type="button" id="reset-btn" class="btn btn-sm btn-outline-secondary">تفريغ النموذج</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header bg-info text-dark d-flex justify-content-between">
      <span>قائمة الفواتير</span>
      <small>انقر على "تعديل" لتحميل الفاتورة في النموذج</small>
    </div>
    <div class="card-body table-responsive">
      <table class="table table-striped table-hover table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>PO</th>
            <th>Invoice</th>
            <th>Date</th>
            <th>Description</th>
            <th>Unit</th>
            <th>Qty</th>
            <th>Total</th>
            <th>Status</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="tbody-invoices">
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const tbody = document.getElementById('tbody-invoices');
const paidSpan = document.getElementById('paid-total');
const unpaidSpan = document.getElementById('unpaid-total');
const reloadBtn = document.getElementById('reload-btn');

const form = document.getElementById('invoice-form');
const resetBtn = document.getElementById('reset-btn');

function formatIQD(val) {
  return Number(val || 0).toLocaleString('en-US');
}

async function loadStats() {
  paidSpan.textContent = '…';
  unpaidSpan.textContent = '…';
  try {
    const res = await fetch('/api/stats');
    const data = await res.json();
    paidSpan.textContent = formatIQD(data.paid);
    unpaidSpan.textContent = formatIQD(data.unpaid);
  } catch (e) {
    console.error(e);
    paidSpan.textContent = 'خطأ';
    unpaidSpan.textContent = 'خطأ';
  }
}

async function loadInvoices() {
  tbody.innerHTML = '<tr><td colspan="10" class="text-center">جاري التحميل...</td></tr>';
  try {
    const res = await fetch('/api/invoices');
    const data = await res.json();
    if (!Array.isArray(data) || !data.length) {
      tbody.innerHTML = '<tr><td colspan="10" class="text-center">لا توجد بيانات</td></tr>';
      return;
    }
    tbody.innerHTML = '';
    data.forEach((inv, idx) => {
      const tr = document.createElement('tr');
      const statusClass = String(inv.status).toLowerCase().startsWith('paid')
        ? 'status-paid'
        : 'status-unpaid';
      tr.innerHTML = \`
        <td>\${idx + 1}</td>
        <td>\${inv.po}</td>
        <td>\${inv.invoice_no}</td>
        <td>\${inv.date}</td>
        <td style="min-width:220px">\${inv.description}</td>
        <td>\${inv.unit}</td>
        <td>\${inv.qty}</td>
        <td>\${formatIQD(inv.totalNumber)}</td>
        <td class="\${statusClass}">\${inv.status}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1" onclick="editInvoice(\${inv.id})">تعديل</button>
          <button class="btn btn-sm btn-danger" onclick="deleteInvoice(\${inv.id})">حذف</button>
        </td>
      \`;
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error(e);
    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">فشل تحميل البيانات</td></tr>';
  }
}

async function deleteInvoice(id) {
  if (!confirm('هل أنت متأكد من حذف الفاتورة؟')) return;
  try {
    const res = await fetch('/api/invoices/' + id, { method: 'DELETE' });
    if (!res.ok) throw new Error('خطأ في الحذف');
    await loadInvoices();
    await loadStats();
  } catch (e) {
    alert('فشل حذف الفاتورة');
  }
}

async function editInvoice(id) {
  try {
    const res = await fetch('/api/invoices/' + id);
    const inv = await res.json();
    document.getElementById('id').value = inv.id;
    document.getElementById('po').value = inv.po;
    document.getElementById('invoice_no').value = inv.invoice_no;
    document.getElementById('date').value = inv.date;
    document.getElementById('status').value = inv.status;
    document.getElementById('duration_from').value = inv.duration_from || '';
    document.getElementById('duration_to').value = inv.duration_to || '';
    document.getElementById('description').value = inv.description || '';
    document.getElementById('unit').value = inv.unit || '';
    document.getElementById('qty').value = inv.qty || '';
    document.getElementById('invoice_amount').value = inv.invoice_amount || '';
    document.getElementById('total').value = inv.total || '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch (e) {
    alert('فشل تحميل الفاتورة للتعديل');
  }
}

resetBtn.addEventListener('click', () => {
  form.reset();
  document.getElementById('id').value = '';
});

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const payload = {
    po: document.getElementById('po').value,
    invoice_no: document.getElementById('invoice_no').value,
    date: document.getElementById('date').value,
    status: document.getElementById('status').value,
    duration_from: document.getElementById('duration_from').value,
    duration_to: document.getElementById('duration_to').value,
    description: document.getElementById('description').value,
    unit: document.getElementById('unit').value,
    qty: Number(document.getElementById('qty').value || 0),
    invoice_amount: document.getElementById('invoice_amount').value,
    total: document.getElementById('total').value
  };
  const id = document.getElementById('id').value;
  try {
    if (id) {
      await fetch('/api/invoices/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } else {
      await fetch('/api/invoices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    }
    form.reset();
    document.getElementById('id').value = '';
    await loadInvoices();
    await loadStats();
  } catch (e) {
    alert('فشل حفظ الفاتورة');
  }
});

reloadBtn.addEventListener('click', async () => {
  await loadInvoices();
  await loadStats();
});

loadInvoices();
loadStats();
</script>
</body>
</html>
  `);
});

// =======================
// 4) REST API للفواتير
// =======================

// كل الفواتير
app.get('/api/invoices', (req, res) => {
  const withNumbers = invoices.map(inv => ({
    ...inv,
    totalNumber: parseMoney(inv.total)
  }));
  res.json(withNumbers);
});

// فاتورة واحدة
app.get('/api/invoices/:id', (req, res) => {
  const id = Number(req.params.id);
  const inv = invoices.find(i => i.id === id);
  if (!inv) return res.status(404).json({ error: 'Not found' });
  res.json(inv);
});

// إضافة فاتورة
app.post('/api/invoices', (req, res) => {
  const body = req.body || {};
  const newId = invoices.length ? Math.max(...invoices.map(i => i.id)) + 1 : 1;
  const inv = {
    id: newId,
    po: body.po || '',
    invoice_no: body.invoice_no || '',
    date: body.date || '',
    description: body.description || '',
    duration_from: body.duration_from || '',
    duration_to: body.duration_to || '',
    unit: body.unit || '',
    qty: Number(body.qty || 0),
    invoice_amount: body.invoice_amount || '',
    total: body.total || '',
    status: body.status || 'Unpaid'
  };
  invoices.push(inv);
  saveInvoices();
  res.status(201).json(inv);
});

// تعديل فاتورة
app.put('/api/invoices/:id', (req, res) => {
  const id = Number(req.params.id);
  const idx = invoices.findIndex(i => i.id === id);
  if (idx === -1) return res.status(404).json({ error: 'Not found' });

  const body = req.body || {};
  invoices[idx] = {
    ...invoices[idx],
    po: body.po ?? invoices[idx].po,
    invoice_no: body.invoice_no ?? invoices[idx].invoice_no,
    date: body.date ?? invoices[idx].date,
    description: body.description ?? invoices[idx].description,
    duration_from: body.duration_from ?? invoices[idx].duration_from,
    duration_to: body.duration_to ?? invoices[idx].duration_to,
    unit: body.unit ?? invoices[idx].unit,
    qty: body.qty != null ? Number(body.qty) : invoices[idx].qty,
    invoice_amount: body.invoice_amount ?? invoices[idx].invoice_amount,
    total: body.total ?? invoices[idx].total,
    status: body.status ?? invoices[idx].status
  };
  saveInvoices();
  res.json(invoices[idx]);
});

// حذف فاتورة
app.delete('/api/invoices/:id', (req, res) => {
  const id = Number(req.params.id);
  const idx = invoices.findIndex(i => i.id === id);
  if (idx === -1) return res.status(404).json({ error: 'Not found' });
  const removed = invoices.splice(idx, 1)[0];
  saveInvoices();
  res.json(removed);
});

// إحصائيات
app.get('/api/stats', (req, res) => {
  res.json(calculateStats());
});

// =======================
// 5) تشغيل السيرفر
// =======================
app.listen(PORT, () => {
  console.log(`✅ السيرفر يعمل على: http://localhost:${PORT}`);
  console.log('- واجهة الويب: GET /');
  console.log('- كل الفواتير: GET /api/invoices');
  console.log('- فاتورة واحدة: GET /api/invoices/:id');
  console.log('- إضافة فاتورة: POST /api/invoices');
  console.log('- تعديل فاتورة: PUT /api/invoices/:id');
  console.log('- حذف فاتورة: DELETE /api/invoices/:id');
  console.log('- الإحصائيات: GET /api/stats');
});
