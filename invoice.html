const express = require("express");
const cors = require("cors");
const sqlite3 = require("sqlite3").verbose();
const path = require("path");

const app = express();
const PORT = 3000;

// ميدل وير
app.use(cors());
app.use(express.json());

// إنشاء/فتح قاعدة بيانات SQLite في ملف
const dbPath = path.join(__dirname, "invoices.db");
const db = new sqlite3.Database(dbPath);

// إنشاء جدول الفواتير إذا غير موجود
db.serialize(() => {
  db.run(`
    CREATE TABLE IF NOT EXISTS invoices (
      id TEXT PRIMARY KEY,
      number TEXT,
      issueDate TEXT,
      dueDate TEXT,
      contract TEXT,
      billTo TEXT,
      customerName TEXT,
      scope TEXT,
      note TEXT,
      items TEXT,        -- JSON string
      subtotal REAL,
      discount REAL,
      taxPerc REAL,
      shipping REAL,
      balance REAL,
      status TEXT,
      createdAt TEXT,
      updatedAt TEXT
    )
  `);
});

// توليد ID بسيط
function generateId(){
  return Date.now().toString(36) + "-" + Math.random().toString(36).slice(2);
}

// تحويل صف الداتابيس إلى كائن
function rowToInvoice(row){
  if(!row) return null;
  return {
    id: row.id,
    number: row.number,
    issueDate: row.issueDate,
    dueDate: row.dueDate,
    contract: row.contract,
    billTo: row.billTo,
    customerName: row.customerName,
    scope: row.scope,
    note: row.note,
    items: row.items ? JSON.parse(row.items) : [],
    subtotal: row.subtotal || 0,
    discount: row.discount || 0,
    taxPerc: row.taxPerc || 0,
    shipping: row.shipping || 0,
    balance: row.balance || 0,
    status: row.status || "draft",
    createdAt: row.createdAt,
    updatedAt: row.updatedAt
  };
}

// GET /api/invoices → كل الفواتير
app.get("/api/invoices", (req, res) => {
  db.all("SELECT * FROM invoices ORDER BY issueDate DESC", [], (err, rows) => {
    if(err){
      console.error(err);
      return res.status(500).json({error:"DB error"});
    }
    res.json(rows.map(rowToInvoice));
  });
});

// POST /api/invoices → إنشاء فاتورة
app.post("/api/invoices", (req, res) => {
  const inv = req.body || {};
  const id = generateId();
  const now = new Date().toISOString();
  const customerName = (inv.billTo || "").split("\n")[0] || "";

  const stmt = db.prepare(`
    INSERT INTO invoices
    (id, number, issueDate, dueDate, contract, billTo, customerName, scope, note,
     items, subtotal, discount, taxPerc, shipping, balance, status, createdAt, updatedAt)
    VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)
  `);

  stmt.run(
    id,
    inv.number || "",
    inv.issueDate || "",
    inv.dueDate || "",
    inv.contract || "",
    inv.billTo || "",
    customerName,
    inv.scope || "",
    inv.note || "",
    JSON.stringify(inv.items || []),
    inv.subtotal || 0,
    inv.discount || 0,
    inv.taxPerc || 0,
    inv.shipping || 0,
    inv.balance || 0,
    inv.status || "draft",
    now,
    now,
    function(err){
      if(err){
        console.error(err);
        return res.status(500).json({error:"DB error"});
      }
      db.get("SELECT * FROM invoices WHERE id=?", [id], (err2, row) => {
        if(err2){
          console.error(err2);
          return res.status(500).json({error:"DB error"});
        }
        res.json(rowToInvoice(row));
      });
    }
  );
});

// PUT /api/invoices/:id → تحديث فاتورة
app.put("/api/invoices/:id", (req, res) => {
  const id = req.params.id;
  const inv = req.body || {};
  const now = new Date().toISOString();
  const customerName = (inv.billTo || "").split("\n")[0] || "";

  const stmt = db.prepare(`
    UPDATE invoices SET
      number = ?,
      issueDate = ?,
      dueDate = ?,
      contract = ?,
      billTo = ?,
      customerName = ?,
      scope = ?,
      note = ?,
      items = ?,
      subtotal = ?,
      discount = ?,
      taxPerc = ?,
      shipping = ?,
      balance = ?,
      status = ?,
      updatedAt = ?
    WHERE id = ?
  `);

  stmt.run(
    inv.number || "",
    inv.issueDate || "",
    inv.dueDate || "",
    inv.contract || "",
    inv.billTo || "",
    customerName,
    inv.scope || "",
    inv.note || "",
    JSON.stringify(inv.items || []),
    inv.subtotal || 0,
    inv.discount || 0,
    inv.taxPerc || 0,
    inv.shipping || 0,
    inv.balance || 0,
    inv.status || "draft",
    now,
    id,
    function(err){
      if(err){
        console.error(err);
        return res.status(500).json({error:"DB error"});
      }
      db.get("SELECT * FROM invoices WHERE id=?", [id], (err2, row) => {
        if(err2){
          console.error(err2);
          return res.status(500).json({error:"DB error"});
        }
        res.json(rowToInvoice(row));
      });
    }
  );
});

// DELETE /api/invoices/:id → حذف فاتورة
app.delete("/api/invoices/:id", (req, res) => {
  const id = req.params.id;
  db.run("DELETE FROM invoices WHERE id = ?", [id], function(err){
    if(err){
      console.error(err);
      return res.status(500).json({error:"DB error"});
    }
    res.json({ok:true});
  });
});

// POST /api/invoices/reset → حذف الكل
app.post("/api/invoices/reset", (req, res) => {
  db.run("DELETE FROM invoices", [], function(err){
    if(err){
      console.error(err);
      return res.status(500).json({error:"DB error"});
    }
    res.json({ok:true});
  });
});

app.listen(PORT, () => {
  console.log("Invoice API server running on http://localhost:" + PORT);
});
