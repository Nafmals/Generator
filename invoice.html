<!DOCTYPE html>
<html lang="en" dir="ltr" data-theme="navy-dark">
<head>
<meta charset="UTF-8">
<title>Nafithat â€“ Advanced Invoice Manager (Local)</title>

<style>
/* ====== (CSS ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„) ====== */
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);}
.hidden{display:none;}
/* âš ï¸ ØªÙ… Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ ÙƒÙ„ CSS Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù */
</style>
</head>

<body>

<!-- ===== TOP BAR (ÙƒÙ…Ø§ Ù‡Ùˆ) ===== -->
<div class="topbar">
  <div class="brand">
    <div class="brand-title">Nafithat Al-Amal Co.</div>
    <div class="brand-sub">Advanced Invoice Management (Local)</div>
  </div>

  <div class="topbar-middle">
    <button class="pill-btn active" id="tab-dashboard">Invoices Dashboard</button>
    <button class="pill-btn" id="tab-report">Invoices Report</button>
  </div>

  <div class="topbar-right">
    <select id="theme-select">
      <option value="navy-dark">Navy Dark</option>
      <option value="midnight-teal">Midnight Teal</option>
      <option value="soft-light">Soft Light</option>
      <option value="warm-sand">Warm Sand</option>
      <option value="graphite">Graphite</option>
      <option value="forest">Forest</option>
    </select>

    <button class="pill-btn ghost" id="btn-new">+ New Invoice</button>
    <button class="pill-btn ghost" id="btn-export">â¬‡ CSV</button>
    <button class="pill-btn ghost" id="btn-save-json">ğŸ’¾ Save JSON</button>
    <button class="pill-btn ghost" id="btn-load-json">ğŸ“‚ Load JSON</button>
    <button class="pill-btn danger" id="btn-reset">âŸ³ Reset</button>
  </div>
</div>

<main>

<!-- ===== DASHBOARD ===== -->
<section id="dashboard" class="card">
  <div class="filters-row">
    <div class="status-group">
      <span class="status-pill active" data-filter="all">All</span>
      <span class="status-pill" data-filter="paid">Paid</span>
      <span class="status-pill" data-filter="unpaid">Unpaid</span>
      <span class="status-pill" data-filter="draft">Draft</span>
    </div>

    <div class="right-filters">
      <select id="po-filter"><option value="all">All Contracts</option></select>

      <!-- âœ… NEW FILTERS -->
      <input type="date" id="date-from" title="From date">
      <input type="date" id="date-to" title="To date">
      <input type="number" id="amount-min" placeholder="Min IQD" style="width:90px">
      <input type="number" id="amount-max" placeholder="Max IQD" style="width:90px">

      <div class="search-input">
        ğŸ” <input id="search-input" type="text" placeholder="Search...">
      </div>

      <button class="pill-btn ghost" id="btn-reset-filters">âŸ³ Filters</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>Due</th><th>No</th><th>PO</th>
        <th>Customer</th><th>Scope</th><th>Status</th><th>Amount</th><th></th>
      </tr>
    </thead>
    <tbody id="invoice-table-body"></tbody>
  </table>
</section>

<section id="report" class="card hidden">
  <table>
    <thead>
      <tr><th>No</th><th>PO</th><th>Date</th><th>Due</th><th>Status</th><th>Balance</th></tr>
    </thead>
    <tbody id="report-body"></tbody>
  </table>
</section>

<section id="editor" class="card hidden">
  <button id="btn-print">ğŸ–¨ Print / PDF</button>
</section>

<input type="file" id="json-file-input" style="display:none">

<script>
/* ================= SAFE HELPERS ================= */
const $ = id => document.getElementById(id);
const on = (id,e,fn)=>{ const el=$(id); if(el) el.addEventListener(e,fn); };

const STORAGE_KEY="naf_advanced_invoice_local";
let invoices=[],currentId=null;
let currentFilter="all",currentPoFilter="all",searchTerm="";
let dateFrom="",dateTo="",amountMin="",amountMax="";
let autoSaveTimer=null;

/* ================= CORE ================= */
function loadInvoices(){
  try{ invoices=JSON.parse(localStorage.getItem(STORAGE_KEY))||[]; }
  catch{ invoices=[]; }
}
function saveInvoices(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify(invoices));
  renderDashboard(); renderReport();
}

/* ================= FILTER ================= */
function matches(inv){
  if(currentPoFilter!=="all" && inv.contract!==currentPoFilter) return false;
  if(currentFilter!=="all" && inv.status!==currentFilter) return false;

  if(searchTerm){
    const h=(inv.number+inv.contract+inv.customerName+inv.scope+
      (inv.items||[]).map(i=>i.desc+i.location).join("")
    ).toLowerCase();
    if(!h.includes(searchTerm.toLowerCase())) return false;
  }

  if(dateFrom && new Date(inv.issueDate)<new Date(dateFrom)) return false;
  if(dateTo){
    const t=new Date(dateTo); t.setHours(23,59,59);
    if(new Date(inv.issueDate)>t) return false;
  }
  if(amountMin && inv.balance<Number(amountMin)) return false;
  if(amountMax && inv.balance>Number(amountMax)) return false;

  return true;
}

/* ================= RENDER ================= */
function renderDashboard(){
  const b=$("invoice-table-body"); if(!b) return;
  b.innerHTML="";
  invoices.filter(matches).forEach(inv=>{
    b.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${inv.issueDate||""}</td>
        <td>${inv.dueDate||""}</td>
        <td>${inv.number||""}</td>
        <td>${inv.contract||""}</td>
        <td>${inv.customerName||""}</td>
        <td>${inv.scope||""}</td>
        <td>${inv.status}</td>
        <td>${inv.balance||0}</td>
        <td><button onclick="editInvoice('${inv.id}')">Edit</button></td>
      </tr>
    `);
  });
}
function renderReport(){
  const b=$("report-body"); if(!b) return;
  b.innerHTML="";
  invoices.forEach(i=>{
    b.insertAdjacentHTML("beforeend",`
      <tr><td>${i.number}</td><td>${i.contract}</td><td>${i.issueDate}</td>
      <td>${i.dueDate}</td><td>${i.status}</td><td>${i.balance}</td></tr>
    `);
  });
}

/* ================= AUTOSAVE ================= */
function startAutoSave(){
  clearInterval(autoSaveTimer);
  autoSaveTimer=setInterval(()=>{
    if(!currentId) return;
    const inv=invoices.find(i=>i.id===currentId);
    if(inv) saveInvoices();
  },5000);
}

/* ================= EVENTS ================= */
function setupEvents(){
  on("btn-export","click",()=>window.print());
  on("search-input","input",e=>{searchTerm=e.target.value;renderDashboard();});
  on("date-from","change",e=>{dateFrom=e.target.value;renderDashboard();});
  on("date-to","change",e=>{dateTo=e.target.value;renderDashboard();});
  on("amount-min","input",e=>{amountMin=e.target.value;renderDashboard();});
  on("amount-max","input",e=>{amountMax=e.target.value;renderDashboard();});
  on("btn-reset-filters","click",()=>{
    dateFrom=dateTo=amountMin=amountMax=searchTerm="";
    ["date-from","date-to","amount-min","amount-max","search-input"]
      .forEach(id=>$(id).value="");
    renderDashboard();
  });
}

function init(){
  loadInvoices();
  setupEvents();
  renderDashboard();
  renderReport();
}

document.addEventListener("DOMContentLoaded",init);
</script>

</body>
</html>
