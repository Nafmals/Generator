<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Nafithat Al-Amal - Invoice System (Local)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{margin:0;background:linear-gradient(135deg,#0f172a 0,#111827 35%,#020617 100%);padding:14px;color:#111827;}
    a{text-decoration:none;color:inherit}
    button{font-family:inherit}

    .btn{border-radius:999px;border:1px solid #e5e7eb;padding:6px 12px;font-size:11px;background:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:4px;transition:background .15s,transform .12s,box-shadow .12s;}
    .btn:hover{background:#f9fafb;transform:translateY(-1px);box-shadow:0 4px 10px rgba(15,23,42,.15);}
    .btn-primary{background:#111827;color:#fff;border-color:#111827;}
    .btn-primary:hover{background:#020617;}
    .btn-danger{background:#fef2f2;border-color:#fecaca;color:#b91c1c;}
    .btn-sm{padding:3px 8px;font-size:10px;}

    .topbar-main{max-width:1180px;margin:0 auto 14px auto;padding:8px 12px;border-radius:16px;background:rgba(248,250,252,0.98);border:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(15,23,42,.25);backdrop-filter:blur(12px);}
    .brand{display:flex;align-items:center;gap:8px;font-size:11px;}
    .brand img{height:30px;border-radius:999px;}
    .brand-info{display:flex;flex-direction:column;gap:2px;}
    .brand-name{font-weight:bold;color:#f97316;font-size:15px;}
    .brand-sub{font-size:10px;color:#6b7280;}
    .top-actions{display:flex;gap:6px;flex-wrap:wrap;}

    #app{max-width:1180px;margin:0 auto;}
    section{background:#f3f4f6;border-radius:18px;padding:10px 12px 12px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(15,23,42,.25);}

    /* Ù„ÙˆØ­Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± */
    #dashboard{margin-top:8px;}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px;}
    .dashboard-title{font-size:16px;font-weight:bold;display:flex;align-items:center;gap:6px;}
    .dashboard-title span{font-size:11px;font-weight:normal;color:#6b7280;}
    .search-box{display:flex;align-items:center;gap:6px;background:#fff;border-radius:999px;border:1px solid #e5e7eb;padding:4px 10px;min-width:240px;}
    .search-box input{border:none;outline:none;font-size:11px;width:100%;background:transparent;}

    .filters-row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;}
    .status-filters{display:flex;gap:6px;flex-wrap:wrap;}
    .status-pill{padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;font-size:10px;cursor:pointer;background:#fff;}
    .status-pill.active{background:#111827;color:#fff;border-color:#111827;}
    .filters-right{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
    .po-filter{font-size:10px;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;}

    .summary-cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-bottom:10px;}
    .card{background:#fff;border-radius:12px;border:1px solid #e5e7eb;padding:8px 10px;font-size:11px;position:relative;overflow:hidden;cursor:pointer;transition:box-shadow .12s,border-color .12s,transform .12s;}
    .card:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(15,23,42,.2);}
    .card.card-active{border-color:#111827;box-shadow:0 0 0 1px #111827,0 8px 18px rgba(15,23,42,.18);}
    .card-label{color:#6b7280;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;gap:4px;}
    .card-label span{font-size:9px;color:#9ca3af;}
    .card-value{font-size:14px;font-weight:bold;}
    .card-sub{font-size:10px;color:#6b7280;}

    .table-wrap{background:#fff;border-radius:12px;border:1px solid #e5e7eb;overflow:auto;max-height:460px;}
    table{width:100%;border-collapse:collapse;font-size:11px;}
    thead{background:#f9fafb;position:sticky;top:0;z-index:1;}
    th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb;white-space:nowrap;text-align:right;}
    tr:hover td{background:#eef2ff;}

    .badge{display:inline-flex;align-items:center;padding:2px 6px;border-radius:999px;font-size:10px;border:1px solid transparent;}
    .badge-paid{background:#ecfdf5;color:#166534;border-color:#bbf7d0;}
    .badge-unpaid{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe;}
    .badge-draft{background:#f9fafb;color:#6b7280;border-color:#e5e7eb;}
    .badge-overdue{background:#fef2f2;color:#b91c1c;border-color:#fecaca;}

    /* Ø§Ù„Ù…Ø­Ø±Ø± */
    #editor{margin-top:8px;display:none;}
    .editor-topbar{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;}
    .editor-title{font-size:14px;font-weight:bold;}
    .editor-actions{display:flex;gap:6px;flex-wrap:wrap;}

    .invoice-page{background:#ffffff;border-radius:10px;border:1px solid #d1d5db;padding:18px 20px;position:relative;margin:0 auto 12px auto;}
    .invoice-header{display:flex;justify-content:space-between;gap:20px;margin-bottom:10px;}
    .company-block{font-size:11px;line-height:1.4;}
    .company-name{font-size:14px;font-weight:bold;color:#f97316;margin-bottom:4px;}
    .meta-block{font-size:10px;min-width:230px;}
    .meta-row{display:flex;align-items:center;gap:4px;margin-bottom:4px;}
    .meta-row span.label{min-width:80px;font-weight:bold;}
    .meta-row input{flex:1;border:1px solid #d1d5db;border-radius:4px;padding:2px 4px;font-size:10px;}

    .bill-row{display:flex;justify-content:space-between;gap:20px;margin-top:10px;margin-bottom:10px;}
    .bill-to{flex:1;font-size:10px;}
    .bill-to textarea{width:100%;min-height:70px;border-radius:6px;border:1px solid #d1d5db;padding:4px;font-size:10px;resize:vertical;}
    .bill-title{font-size:18px;color:#4b5563;align-self:flex-start;margin-top:12px;margin-inline-start:20px;}

    .items-table{width:100%;border-collapse:collapse;font-size:10px;margin-top:6px;}
    .items-table th,.items-table td{border:1px solid #d1d5db;padding:4px;vertical-align:top;text-align:right;}
    .items-table th{background:#f9fafb;}
    .items-table input,.items-table textarea{width:100%;border:none;outline:none;font-size:10px;background:transparent;resize:vertical;}
    .items-table .num-input{text-align:left;}

    .add-row-bar{margin-top:4px;font-size:10px;}

    .totals-wrap{display:flex;justify-content:flex-start;margin-top:10px;}
    .totals-table{border-collapse:collapse;font-size:10px;min-width:260px;}
    .totals-table td{border:1px solid #d1d5db;padding:4px;}
    .totals-table td:first-child{background:#f9fafb;font-weight:bold;min-width:120px;}
    .totals-table input{width:100%;border:none;outline:none;text-align:left;font-size:10px;}

    .note-block{margin-top:10px;font-size:10px;}
    .note-block textarea{width:100%;min-height:60px;border-radius:6px;border:1px solid #d1d5db;padding:4px;font-size:10px;resize:vertical;}

    .status-select{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb;}

    @media(max-width:900px){
      .summary-cards{grid-template-columns:repeat(2,minmax(0,1fr));}
      .invoice-header{flex-direction:column;}
      .bill-row{flex-direction:column;}
    }
  </style>
</head>
<body>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar-main">
    <div class="brand">
      <img src="logo-main.png" alt="Logo">
      <div class="brand-info">
        <div class="brand-name">Nafithat Al-Amal Co.</div>
        <div class="brand-sub">Advanced Invoice Management (Local)</div>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn btn-primary" id="btn-dashboard">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
      <button class="btn btn-primary" id="btn-new">+ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
  </div>

  <div id="app">
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± -->
    <section id="dashboard">
      <div class="dashboard-header">
        <div class="dashboard-title">
          Ø§Ù„ÙÙˆØ§ØªÙŠØ±
          <span>Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</span>
        </div>
        <div class="search-box">
          <span>ğŸ”</span>
          <input id="search-input" placeholder="Ø¨Ø­Ø« (Ø¹Ù…ÙŠÙ„ØŒ Ø±Ù‚Ù…ØŒ Ø¹Ù‚Ø¯ØŒ ÙˆØµÙ)...">
        </div>
      </div>

      <div class="filters-row">
        <div class="status-filters">
          <button class="status-pill active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
          <button class="status-pill" data-filter="paid">Ù…Ø¯ÙÙˆØ¹Ø©</button>
          <button class="status-pill" data-filter="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</button>
          <button class="status-pill" data-filter="draft">Ù…Ø³ÙˆØ¯Ø©</button>
        </div>
        <div class="filters-right">
          <select id="po-filter" class="po-filter">
            <option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯</option>
          </select>
          <div style="font-size:10px;color:#6b7280;">
            Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ ØµÙ Ø£Ùˆ Ø²Ø± <b>ØªØ¹Ø¯ÙŠÙ„</b> Ù„ÙØªØ­ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
          </div>
        </div>
      </div>

      <div class="summary-cards">
        <div class="card card-active" id="card-total">
          <div class="card-label">
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
            <span>Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>
          </div>
          <div class="card-value" id="card-total-amount">IQD 0</div>
          <div class="card-sub" id="card-total-count">0 ÙØ§ØªÙˆØ±Ø©</div>
        </div>
        <div class="card" id="card-paid">
          <div class="card-label">
            Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©
            <span>ØªÙ… ØªØ³ÙˆÙŠØªÙ‡Ø§</span>
          </div>
          <div class="card-value" id="card-paid-amount">IQD 0</div>
          <div class="card-sub" id="card-paid-count">0 ÙØ§ØªÙˆØ±Ø©</div>
        </div>
        <div class="card" id="card-unpaid">
          <div class="card-label">
            ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©
            <span>ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©</span>
          </div>
          <div class="card-value" id="card-unpaid-amount">IQD 0</div>
          <div class="card-sub" id="card-unpaid-count">0 ÙØ§ØªÙˆØ±Ø©</div>
        </div>
        <div class="card" id="card-draft">
          <div class="card-label">
            Ø§Ù„Ù…Ø³ÙˆØ¯Ø§Øª
            <span>ØºÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠØ©</span>
          </div>
          <div class="card-value" id="card-draft-amount">IQD 0</div>
          <div class="card-sub" id="card-draft-count">0 ÙØ§ØªÙˆØ±Ø©</div>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
              <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
              <th>Ø§Ù„Ø¹Ù‚Ø¯ (PO)</th>
              <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th>Ø§Ù„ÙˆØµÙ</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="invoice-table-body"></tbody>
        </table>
      </div>
    </section>

    <!-- Ù…Ø­Ø±Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
    <section id="editor">
      <div class="editor-topbar">
        <div class="editor-title">
          ğŸ”§ ØªØ­Ø±ÙŠØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø©
          <span id="editor-subtitle" style="font-size:11px;color:#6b7280;margin-inline-start:4px;"></span>
        </div>
        <div class="editor-actions">
          <select id="status-select" class="status-select">
            <option value="draft">Ù…Ø³ÙˆØ¯Ø©</option>
            <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</option>
            <option value="paid">Ù…Ø¯ÙÙˆØ¹Ø©</option>
          </select>
          <button class="btn" id="btn-back">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø©</button>
          <button class="btn btn-danger" id="btn-delete">ğŸ—‘ Ø­Ø°Ù</button>
          <button class="btn btn-primary" id="btn-save">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
        </div>
      </div>

      <div class="invoice-page">
        <div class="invoice-header">
          <div class="company-block">
            <div class="company-name">Nafithat Al-Amal Co.</div>
            <div>Baghdad - Al-Wahda District - Street 52</div>
            <div>Email: sales@nafmals.com</div>
            <div>Phone: 07723571779</div>
          </div>
          <div class="meta-block">
            <div class="meta-row">
              <span class="label">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</span>
              <input id="f-number">
            </div>
            <div class="meta-row">
              <span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</span>
              <input id="f-date" type="date">
            </div>
            <div class="meta-row">
              <span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚:</span>
              <input id="f-due" type="date">
            </div>
            <div class="meta-row">
              <span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ (PO):</span>
              <input id="f-contract">
            </div>
          </div>
        </div>

        <div class="bill-row">
          <div class="bill-to">
            <div style="font-weight:bold;margin-bottom:4px;">Ø¥Ù„Ù‰ (Ø§Ù„Ø¹Ù…ÙŠÙ„):</div>
            <textarea id="f-billto" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
          </div>
          <div class="bill-title">Invoice</div>
        </div>

        <table class="items-table">
          <thead>
            <tr>
              <th style="width:30px;">#</th>
              <th>Ø§Ù„ÙˆØµÙ</th>
              <th style="width:80px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th style="width:100px;">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th style="width:110px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            </tr>
          </thead>
          <tbody id="items-body"></tbody>
        </table>

        <div class="add-row-bar">
          <button type="button" class="btn-sm" id="add-row-btn">+ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
        </div>

        <div class="totals-wrap">
          <table class="totals-table">
            <tr>
              <td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</td>
              <td><input id="f-total" readonly></td>
            </tr>
          </table>
        </div>

        <div class="note-block">
          <div style="font-weight:bold;margin-bottom:3px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</div>
          <textarea id="f-note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© Ø£Ùˆ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©"></textarea>
        </div>
      </div>
    </section>
  </div>

  <script>
    const STORAGE_KEY = "nafithat_invoice_system_v3";

    let invoices = [];
    let currentId = null;
    let currentFilter = "all";
    let currentPoFilter = "all";

    const $ = id => document.getElementById(id);

    function todayStr(){
      return new Date().toISOString().slice(0,10);
    }

    function formatIQD(n){
      n = Number(n)||0;
      return "IQD " + n.toLocaleString("en-US");
    }

    function parseNumber(v){
      if(typeof v!=="string") v=String(v||"");
      return Number(v.replace(/[^\d.-]/g,"")) || 0;
    }

    function generateId(){
      if(window.crypto && window.crypto.randomUUID) return crypto.randomUUID();
      return Date.now().toString(36) + "-" + Math.random().toString(36).slice(2);
    }

    /* ====== ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ ====== */
    function loadInvoices(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const arr = JSON.parse(raw);
        if(Array.isArray(arr)) invoices = arr;
      }catch(e){
        console.error("load error",e);
      }
    }

    function saveInvoices(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
      renderPoFilterOptions();
      renderDashboard();
    }

    /* ====== Ø¹Ø±Ø¶ / Ø¥Ø®ÙØ§Ø¡ ====== */
    function showDashboard(){
      $("dashboard").style.display = "";
      $("editor").style.display = "none";
    }
    function showEditor(){
      $("dashboard").style.display = "none";
      $("editor").style.display = "";
    }

    /* ====== ÙÙˆØ±Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ====== */
    function clearForm(){
      $("f-number").value   = "";
      $("f-date").value     = todayStr();
      $("f-due").value      = "";
      $("f-contract").value = "";
      $("f-billto").value   = "";
      $("f-note").value     = "";
      $("status-select").value = "draft";
      $("items-body").innerHTML = "";
      addItemRow();
      recalcTotals();
      $("editor-subtitle").textContent = "(ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©)";
    }

    function addItemRow(data){
      data = data || {desc:"",qty:1,price:0};
      const tbody = $("items-body");
      const index = tbody.children.length + 1;
      const tr = document.createElement("tr");
      tr.className = "item-row";
      tr.innerHTML = `
        <td class="row-index">${index}</td>
        <td><textarea class="item-desc">${data.desc||""}</textarea></td>
        <td><input type="number" min="0" step="0.01" class="item-qty num-input" value="${data.qty!=null?data.qty:1}"></td>
        <td><input type="number" min="0" step="0.01" class="item-price num-input" value="${data.price!=null?data.price:0}"></td>
        <td><span class="item-total">IQD 0</span></td>
      `;
      tbody.appendChild(tr);
      tr.querySelector(".item-qty").addEventListener("input", recalcTotals);
      tr.querySelector(".item-price").addEventListener("input", recalcTotals);
      recalcTotals();
    }

    function recalcTotals(){
      const rows = document.querySelectorAll(".item-row");
      let total = 0;
      rows.forEach(row=>{
        const qty   = parseNumber(row.querySelector(".item-qty").value);
        const price = parseNumber(row.querySelector(".item-price").value);
        const rowTotal = qty*price;
        total += rowTotal;
        row.querySelector(".item-total").textContent = formatIQD(rowTotal);
      });
      $("f-total").value = formatIQD(total);
    }

    function readFormToInvoice(inv){
      inv.number    = $("f-number").value.trim();
      inv.issueDate = $("f-date").value || todayStr();
      inv.dueDate   = $("f-due").value.trim();
      inv.contract  = $("f-contract").value.trim();
      inv.billTo    = $("f-billto").value.trim();
      inv.note      = $("f-note").value.trim();
      inv.status    = $("status-select").value;
      const firstLine = (inv.billTo.split("\n")[0] || "").trim();
      inv.customer  = firstLine;

      const rows = document.querySelectorAll(".item-row");
      const items = [];
      let total = 0;
      rows.forEach(row=>{
        const desc  = row.querySelector(".item-desc").value.trim();
        const qty   = parseNumber(row.querySelector(".item-qty").value);
        const price = parseNumber(row.querySelector(".item-price").value);
        const rowTotal = qty*price;
        if(desc || qty || price){
          items.push({desc,qty,price});
        }
        total += rowTotal;
      });
      inv.items = items;
      inv.total = total;
      inv.updatedAt = new Date().toISOString();
    }

    function fillFormFromInvoice(inv){
      $("f-number").value   = inv.number || "";
      $("f-date").value     = inv.issueDate || todayStr();
      $("f-due").value      = inv.dueDate || "";
      $("f-contract").value = inv.contract || "";
      $("f-billto").value   = inv.billTo || "";
      $("f-note").value     = inv.note || "";
      $("status-select").value = inv.status || "draft";
      $("items-body").innerHTML = "";
      const items = (inv.items && inv.items.length)? inv.items : [{desc:"",qty:1,price:0}];
      items.forEach(it=>addItemRow(it));
      recalcTotals();
      $("editor-subtitle").textContent = inv.number ? `(${inv.number})` : "(Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…)";
    }

    /* ====== Ø¥Ù†Ø´Ø§Ø¡ / Ø­ÙØ¸ / Ø­Ø°Ù ====== */
    function onNewInvoice(){
      currentId = null;
      clearForm();
      showEditor();
    }

    function onSaveInvoice(){
      if(currentId){
        const inv = invoices.find(i=>i.id===currentId);
        if(!inv) return;
        readFormToInvoice(inv);
      }else{
        const inv = {
          id: generateId(),
          createdAt: new Date().toISOString()
        };
        readFormToInvoice(inv);
        invoices.push(inv);
        currentId = inv.id;
      }
      saveInvoices();
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© âœ…");
      showDashboard();
    }

    function onDeleteCurrent(){
      if(!currentId){
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø© Ù…Ø­Ø¯Ø¯Ø©.");
        return;
      }
      if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ")) return;
      invoices = invoices.filter(i=>i.id!==currentId);
      currentId = null;
      saveInvoices();
      showDashboard();
    }

    function openEditorFor(id){
      const inv = invoices.find(i=>i.id===id);
      if(!inv) return;
      currentId = id;
      fillFormFromInvoice(inv);
      showEditor();
    }

    /* ====== Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ====== */
    function renderPoFilterOptions(){
      const select = $("po-filter");
      const contracts = Array.from(new Set(invoices.map(i=>i.contract).filter(Boolean))).sort();
      select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯</option>' +
        contracts.map(c=>`<option value="${c}">${c}</option>`).join("");
      if(contracts.includes(currentPoFilter)) select.value = currentPoFilter;
      else { currentPoFilter="all"; select.value="all"; }
    }

    function matchesFilters(inv,search){
      if(currentPoFilter!=="all" && inv.contract!==currentPoFilter) return false;
      if(currentFilter==="paid" && inv.status!=="paid") return false;
      if(currentFilter==="unpaid" && inv.status!=="unpaid") return false;
      if(currentFilter==="draft" && inv.status!=="draft") return false;

      if(search){
        const hay = [
          inv.number,inv.customer,inv.contract,inv.billTo,inv.note
        ].join(" ").toLowerCase();
        if(hay.indexOf(search)===-1) return false;
      }
      return true;
    }

    function renderDashboard(){
      const tbody = $("invoice-table-body");
      tbody.innerHTML = "";

      const searchInput = $("search-input");
      const searchText = (searchInput.value || "").trim().toLowerCase();

      const filtered = invoices.filter(inv=>matchesFilters(inv,searchText));

      if(!filtered.length){
        tbody.innerHTML = '<tr><td colspan="9" style="font-size:11px;color:#6b7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© +" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ ÙØ§ØªÙˆØ±Ø©.</td></tr>';
      }else{
        filtered.sort((a,b)=> (b.issueDate||"").localeCompare(a.issueDate||""));
        filtered.forEach(inv=>{
          const tr = document.createElement("tr");
          const statusBadge = (function(){
            if(inv.status==="paid")   return '<span class="badge badge-paid">Ù…Ø¯ÙÙˆØ¹Ø©</span>';
            if(inv.status==="unpaid") return '<span class="badge badge-unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</span>';
            return '<span class="badge badge-draft">Ù…Ø³ÙˆØ¯Ø©</span>';
          })();
          const desc = inv.items && inv.items[0] ? inv.items[0].desc : "";
          tr.setAttribute("data-id",inv.id);
          tr.innerHTML = `
            <td>${inv.issueDate || ""}</td>
            <td>${inv.dueDate || ""}</td>
            <td>${inv.number || ""}</td>
            <td>${inv.contract || ""}</td>
            <td>${inv.customer || ""}</td>
            <td>${(desc||"").slice(0,40)}${desc && desc.length>40 ? "..." : ""}</td>
            <td>${statusBadge}</td>
            <td>${formatIQD(inv.total||0)}</td>
            <td>
              <button class="btn btn-sm edit-btn">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn btn-sm btn-danger delete-btn">Ø­Ø°Ù</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
      let total=0, paid=0, unpaid=0, draft=0;
      let cTotal=0,cPaid=0,cUnpaid=0,cDraft=0;
      invoices.forEach(inv=>{
        const t = inv.total || 0;
        total += t; cTotal++;
        if(inv.status==="paid"){paid+=t;cPaid++;}
        else if(inv.status==="unpaid"){unpaid+=t;cUnpaid++;}
        else {draft+=t;cDraft++;}
      });
      $("card-total-amount").textContent = formatIQD(total);
      $("card-total-count").textContent  = cTotal + " ÙØ§ØªÙˆØ±Ø©";
      $("card-paid-amount").textContent  = formatIQD(paid);
      $("card-paid-count").textContent   = cPaid + " ÙØ§ØªÙˆØ±Ø©";
      $("card-unpaid-amount").textContent= formatIQD(unpaid);
      $("card-unpaid-count").textContent = cUnpaid + " ÙØ§ØªÙˆØ±Ø©";
      $("card-draft-amount").textContent = formatIQD(draft);
      $("card-draft-count").textContent  = cDraft + " ÙØ§ØªÙˆØ±Ø©";
    }

    /* ====== Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ====== */
    function setupEvents(){
      $("btn-dashboard").addEventListener("click", showDashboard);
      $("btn-new").addEventListener("click", onNewInvoice);
      $("btn-back").addEventListener("click", showDashboard);
      $("btn-save").addEventListener("click", onSaveInvoice);
      $("btn-delete").addEventListener("click", onDeleteCurrent);
      $("add-row-btn").addEventListener("click", ()=>addItemRow());

      $("search-input").addEventListener("input", renderDashboard);

      $("po-filter").addEventListener("change", e=>{
        currentPoFilter = e.target.value || "all";
        renderDashboard();
      });

      const pills = document.querySelectorAll(".status-pill");
      pills.forEach(btn=>{
        btn.addEventListener("click", ()=>{
          pills.forEach(p=>p.classList.remove("active"));
          btn.classList.add("active");
          currentFilter = btn.getAttribute("data-filter") || "all";
          renderDashboard();
        });
      });

      // ØªÙÙˆÙŠØ¶ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Edit / Delete / click row)
      $("invoice-table-body").addEventListener("click", function(e){
        const tr = e.target.closest("tr[data-id]");
        if(!tr) return;
        const id = tr.getAttribute("data-id");
        if(e.target.classList.contains("edit-btn")){
          openEditorFor(id);
        }else if(e.target.classList.contains("delete-btn")){
          if(confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ")){
            invoices = invoices.filter(i=>i.id!==id);
            if(currentId===id) currentId=null;
            saveInvoices();
          }
        }else{
          // Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙŠÙØªØ­ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
          openEditorFor(id);
        }
      });

      $("status-select").addEventListener("change", ()=>{
        if(!currentId) return;
        const inv = invoices.find(i=>i.id===currentId);
        if(!inv) return;
        inv.status = $("status-select").value;
        saveInvoices();
      });
    }

    /* ====== Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ====== */
    window.addEventListener("DOMContentLoaded", function(){
      setupEvents();
      loadInvoices();
      renderPoFilterOptions();
      renderDashboard();
    });
  </script>
</body>
</html>
