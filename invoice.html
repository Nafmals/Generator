<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Nafithat Al-Amal - Invoice System (Local)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{margin:0;background:linear-gradient(135deg,#0f172a 0,#111827 35%,#020617 100%);padding:14px;color:#111827;}
    a{text-decoration:none;color:inherit}
    .btn{border-radius:999px;border:1px solid #e5e7eb;padding:6px 12px;font-size:11px;background:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:4px;transition:background .15s,transform .12s,box-shadow .12s;}
    .btn:hover{background:#f9fafb;transform:translateY(-1px);box-shadow:0 4px 10px rgba(15,23,42,.15);}
    .btn-primary{background:#111827;color:#fff;border-color:#111827;}
    .btn-primary:hover{background:#020617;}
    .btn-danger{background:#fef2f2;border-color:#fecaca;color:#b91c1c;}
    .btn-sm{padding:3px 8px;font-size:10px;}

    .topbar-main{max-width:1180px;margin:0 auto 14px auto;padding:8px 12px;border-radius:16px;background:rgba(248,250,252,0.98);border:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(15,23,42,.25);backdrop-filter:blur(12px);}
    .brand{display:flex;align-items:center;gap:8px;font-size:11px;}
    .brand img{height:30px;border-radius:999px;}
    .brand-info{display:flex;flex-direction:column;gap:2px;}
    .brand-name{font-weight:bold;color:#f97316;font-size:15px;}
    .brand-sub{font-size:10px;color:#6b7280;}
    .top-actions{display:flex;gap:6px;flex-wrap:wrap;}

    #app{max-width:1180px;margin:0 auto;}
    section{background:#f3f4f6;border-radius:18px;padding:10px 12px 12px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(15,23,42,.25);}

    #dashboard{margin-top:8px;}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px;}
    .dashboard-title{font-size:16px;font-weight:bold;display:flex;align-items:center;gap:6px;}
    .dashboard-title span{font-size:11px;font-weight:normal;color:#6b7280;}
    .search-box{display:flex;align-items:center;gap:6px;background:#fff;border-radius:999px;border:1px solid #e5e7eb;padding:4px 10px;min-width:240px;}
    .search-box input{border:none;outline:none;font-size:11px;width:100%;background:transparent;}

    .filters-row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;}
    .status-filters{display:flex;gap:6px;flex-wrap:wrap;}
    .status-pill{padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;font-size:10px;cursor:pointer;background:#fff;}
    .status-pill.active{background:#111827;color:#fff;border-color:#111827;}
    .filters-right{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
    .po-filter{font-size:10px;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;}

    .summary-cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-bottom:10px;}
    .card{background:#fff;border-radius:12px;border:1px solid #e5e7eb;padding:8px 10px;font-size:11px;position:relative;overflow:hidden;cursor:pointer;transition:box-shadow .12s,border-color .12s,transform .12s;}
    .card::after{content:"";position:absolute;inset:auto -40px -40px auto;width:80px;height:80px;border-radius:999px;background:radial-gradient(circle,#e5e7eb 0,transparent 60%);opacity:.8;}
    .card:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(15,23,42,.2);}
    .card.card-active{border-color:#111827;box-shadow:0 0 0 1px #111827,0 8px 18px rgba(15,23,42,.18);}
    .card-label{color:#6b7280;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;gap:4px;}
    .card-label span{font-size:9px;color:#9ca3af;}
    .card-value{font-size:14px;font-weight:bold;}
    .card-sub{font-size:10px;color:#6b7280;}

    .table-wrap{background:#fff;border-radius:12px;border:1px solid #e5e7eb;overflow:auto;max-height:460px;}
    table{width:100%;border-collapse:collapse;font-size:11px;}
    thead{background:#f9fafb;position:sticky;top:0;z-index:1;}
    th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb;white-space:nowrap;text-align:left;}
    tr:hover td{background:#eef2ff;}

    .badge{display:inline-flex;align-items:center;padding:2px 6px;border-radius:999px;font-size:10px;border:1px solid transparent;}
    .badge-paid{background:#ecfdf5;color:#166534;border-color:#bbf7d0;}
    .badge-unpaid{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe;}
    .badge-overdue{background:#fef2f2;color:#b91c1c;border-color:#fecaca;}
    .badge-draft{background:#f9fafb;color:#6b7280;border-color:#e5e7eb;}

    #editor{margin-top:8px;display:none;}

    .editor-topbar{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;}
    .editor-title{font-size:14px;font-weight:bold;}
    .editor-actions{display:flex;gap:6px;flex-wrap:wrap;}

    .invoice-page{width:800px;min-height:1120px;background:#ffffff;border-radius:6px;border:1px solid #d1d5db;padding:24px 28px;position:relative;overflow:hidden;margin:0 auto 20px auto;}
    .watermark{position:absolute;right:120px;bottom:120px;width:260px;opacity:0.06;filter:grayscale(1);pointer-events:none;z-index:0;}
    .invoice-inner{position:relative;z-index:1;font-size:11px;}

    .inv-header{display:flex;justify-content:space-between;align-items:flex-start;}
    .inv-company{max-width:320px;line-height:1.35;font-size:11px;}
    .inv-company-name{font-size:14px;font-weight:bold;color:#f97316;margin-bottom:2px;}
    .inv-company p{margin:0;font-size:10px;}
    .inv-right{text-align:right;font-size:10px;}
    .inv-logo-top img{height:60px;display:block;margin-left:auto;}
    .inv-logo-title{margin-top:4px;font-size:14px;color:#f97316;text-align:center;}
    .meta{margin-top:8px;font-size:10px;}
    .meta-row{display:flex;justify-content:flex-end;align-items:center;margin-bottom:2px;gap:4px;}
    .meta-row .label{font-weight:bold;min-width:90px;text-align:right;}
    .meta-row input{border:1px solid #000;padding:2px 4px;font-size:10px;min-width:170px;border-radius:0;}

    .bill-title-row{margin-top:12px;display:flex;justify-content:space-between;align-items:flex-end;font-size:11px;}
    .bill-to-label{font-weight:bold;margin-bottom:2px;}
    .bill-to-box{margin-top:4px;border-top:1px solid #000;padding-top:4px;font-size:10px;}
    .bill-to-textarea{width:100%;min-height:90px;border:none;padding:0;margin:0;resize:vertical;white-space:pre-wrap;font-size:10px;}
    .center-invoice-title{font-size:16px;color:#4b5563;margin-right:40px;}

    table.inv-table{border-collapse:collapse;width:100%;margin-top:10px;}
    table.inv-table th,table.inv-table td{border:1px solid #000;padding:3px 4px;font-size:10px;vertical-align:top;}
    table.inv-table thead tr:first-child th{border-bottom:none;background:#ffffff;}
    table.inv-table thead tr:nth-child(2) th{border-top:none;background:#f5f5f5;}
    .cell-input,.cell-textarea{width:100%;border:none;padding:0;margin:0;font-size:10px;background:transparent;}
    .cell-textarea{resize:vertical;min-height:26px;}
    .cell-input:focus,.cell-textarea:focus{outline:none;}

    .add-row-bar{margin-top:4px;font-size:10px;}
    .thankyou{font-size:9px;margin-top:6px;margin-bottom:6px;}

    .totals-wrap{display:flex;justify-content:flex-end;}
    .totals{width:260px;border-collapse:collapse;font-size:9px;}
    .totals td{padding:2px 4px;border:1px solid #000;}
    .totals td:first-child{width:60%;text-align:right;font-weight:bold;}
    .totals td:last-child{width:40%;text-align:right;min-width:100px;}
    .totals input{width:100%;border:none;background:transparent;font-size:9px;text-align:right;padding:0;margin:0;}
    .totals input:focus{outline:none;}
    .balance{font-weight:bold;}

    .bottom-row{margin-top:18px;display:flex;justify-content:space-between;gap:20px;font-size:9px;}
    .scope-col{width:55%;}
    .scope-label{font-weight:bold;margin-bottom:4px;}
    .scope-textarea{width:100%;min-height:70px;border:none;padding:0;margin:0;white-space:pre-wrap;font-size:9px;resize:vertical;}
    .bank-col{width:38%;}
    .bank-label{font-weight:bold;margin-bottom:4px;}
    .bank-table{width:100%;border-collapse:collapse;font-size:9px;}
    .bank-table td{border:none;padding:1px 0;vertical-align:top;}
    .bank-table td:first-child{width:40%;font-weight:bold;}

    .note-block{margin-top:12px;font-size:9px;}
    .note-block textarea{width:100%;min-height:60px;border:1px solid #d1d5db;border-radius:4px;padding:4px;font-size:9px;resize:vertical;}

    .sign-row{margin-top:32px;display:flex;justify-content:flex-start;font-size:9px;}
    .sign-name{border-top:1px solid #000;padding-top:3px;width:200px;}
    .sign-name span:first-child{font-weight:bold;}

    .status-select{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb;}

    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.3);display:none;align-items:center;justify-content:center;z-index:50;}
    .modal{background:#fff;border-radius:12px;border:1px solid #e5e7eb;padding:10px 12px 12px;width:720px;max-width:95vw;max-height:80vh;display:flex;flex-direction:column;font-size:11px;box-shadow:0 20px 45px rgba(15,23,42,.35);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
    .modal-header h3{margin:0;font-size:13px;}
    .modal-body{flex:1;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;}
    .report-table{width:100%;border-collapse:collapse;}
    .report-table th,.report-table td{padding:4px 6px;border-bottom:1px solid #e5e7eb;font-size:11px;white-space:nowrap;text-align:left;}
    .report-table th{background:#f9fafb;position:sticky;top:0;z-index:1;}
    .modal-footer{margin-top:4px;font-size:10px;color:#6b7280;text-align:right;}

    @media print{
      body{background:#fff;padding:0;}
      .topbar-main,#dashboard,.modal-backdrop,.editor-topbar{display:none !important;}
      #editor{display:block !important;}
      .invoice-page{width:210mm;min-height:297mm;border:none;border-radius:0;padding:15mm 15mm 18mm 15mm;margin:0;}
      .watermark{opacity:0.06;}
      @page{size:A4;margin:0;}
    }
    @media(max-width:900px){
      .summary-cards{grid-template-columns:repeat(2,minmax(0,1fr));}
      .invoice-page{width:100%;padding:18px 12px;}
    }
  </style>
</head>
<body>

  <div class="topbar-main">
    <div class="brand">
      <img src="logo-main.png" alt="Logo">
      <div class="brand-info">
        <div class="brand-name">Nafithat Al-Amal Co.</div>
        <div class="brand-sub">Advanced Invoice Management (Local)</div>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn btn-primary" id="btn-dashboard">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
      <button class="btn" id="btn-report">ğŸ“„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
      <button class="btn" id="btn-new">+ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      <button class="btn" id="btn-export">â¬‡ ØªÙ‚Ø±ÙŠØ± Excel (CSV)</button>
      <button class="btn" id="btn-save-json">ğŸ’¾ Ø­ÙØ¸ JSON</button>
      <button class="btn" id="btn-load-json">ğŸ“‚ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ JSON</button>
      <button class="btn btn-danger" id="btn-reset">ğŸ§¹ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
      <input type="file" id="json-file-input" accept="application/json" style="display:none">
    </div>
  </div>

  <div id="app">
    <section id="dashboard">
      <div class="dashboard-header">
        <div class="dashboard-title">
          Ø§Ù„ÙÙˆØ§ØªÙŠØ±
          <span>Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</span>
        </div>
        <div class="search-box">
          <span>ğŸ”</span>
          <input id="search-input" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ø¹Ù…ÙŠÙ„ØŒ Ø±Ù‚Ù…ØŒ Ø¹Ù‚Ø¯ØŒ ÙˆØµÙ)...">
        </div>
      </div>

      <!-- ÙÙ‚Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©: Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© -->
      <div style="margin:8px 0;font-size:11px;background:#fff;border-radius:10px;border:1px solid #e5e7eb;padding:6px 8px;">
        <b>Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</b>
        <a href="#" id="quick-new" style="margin-inline-start:8px;">
          + Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </a>
        |
        <a href="#" id="quick-edit" style="margin-inline-start:4px;">
          âœ ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
        </a>
        <span style="color:#6b7280;margin-inline-start:8px;">
          (Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©)
        </span>
      </div>

      <div class="filters-row">
        <div class="status-filters">
          <button class="status-pill active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
          <button class="status-pill" data-filter="paid">Ù…Ø¯ÙÙˆØ¹Ø©</button>
          <button class="status-pill" data-filter="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</button>
          <button class="status-pill" data-filter="draft">Ù…Ø³ÙˆØ¯Ø©</button>
        </div>
        <div class="filters-right">
          <select id="po-filter" class="po-filter">
            <option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯</option>
          </select>
          <div style="font-size:10px;color:#6b7280;">
            Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø·Ø± Ø£Ùˆ Ø²Ø± <b>ØªØ¹Ø¯ÙŠÙ„</b> Ù„ÙØªØ­ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
          </div>
        </div>
      </div>

      <div class="summary-cards">
        <div class="card" id="card-total" data-type="total">
          <div class="card-label">
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
            <span>Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>
          </div>
          <div class="card-value" id="card-total-amount">IQD 0</div>
          <div class="card-sub" id="card-total-count">0 ÙØ§ØªÙˆØ±Ø©</div>
        </div>
        <div class="card" id="card-soon" data-type="soon">
          <div class="card-label">
            ØªØ³ØªØ­Ù‚ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…
            <span>ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¨ÙƒØ±</span>
          </div>
          <div class="card-value" id="card-soon-amount">IQD 0</div>
          <div class="card-sub" id="card-soon-count">0 ÙØ§ØªÙˆØ±Ø©</div>
        </div>
        <div class="card" id="card-paid" data-type="paid">
          <div class="card-label">
            Ø§Ù„Ù…Ø¯ÙÙˆØ¹
            <span>ØªÙ… ØªØ³ÙˆÙŠØªÙ‡</span>
          </div>
          <div class="card-value" id="card-paid-amount">IQD 0</div>
          <div class="card-sub" id="card-paid-count">0 ÙØ§ØªÙˆØ±Ø©</div>
        </div>
        <div class="card" id="card-unpaid" data-type="unpaid">
          <div class="card-label">
            ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹
            <span>ÙŠØ´Ù…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</span>
          </div>
          <div class="card-value" id="card-unpaid-amount">IQD 0</div>
          <div class="card-sub" id="card-unpaid-count">0 ÙØ§ØªÙˆØ±Ø©</div>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
              <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
              <th>Ø§Ù„Ø¹Ù‚Ø¯ (PO)</th>
              <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th>Ø§Ù„ÙˆØµÙ Ø§Ù„Ù…Ø®ØªØµØ±</th>
              <th>ØªÙØ§ØµÙŠÙ„</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº (Balance)</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="invoice-table-body"></tbody>
        </table>
      </div>
    </section>

    <section id="editor">
      <div class="editor-topbar">
        <div class="editor-title">
          ğŸ”§ ØªØ­Ø±ÙŠØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø©
          <span id="editor-subtitle" style="font-size:11px;color:#6b7280;margin-inline-start:4px;"></span>
        </div>
        <div class="editor-actions">
          <select id="status-select" class="status-select">
            <option value="draft">Ù…Ø³ÙˆØ¯Ø©</option>
            <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</option>
            <option value="paid">Ù…Ø¯ÙÙˆØ¹Ø©</option>
          </select>
          <button class="btn" id="btn-back">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø©</button>
          <button class="btn" id="btn-duplicate">ğŸ“„ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
          <button class="btn btn-danger" id="btn-delete">ğŸ—‘ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
          <button class="btn btn-primary" id="btn-save">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
          <button class="btn" id="btn-print">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
        </div>
      </div>

      <div class="invoice-page">
        <img src="logo-watermark.png" class="watermark" alt="">
        <div class="invoice-inner">
          <div class="inv-header">
            <div class="inv-company">
              <div class="inv-company-name">Nafithat Al-Amal Co.</div>
              <p>Address: Baghdad - Al-Wahda District - Street 52</p>
              <p>&nbsp;</p>
              <p>Email: sales@nafmals.com</p>
              <p>www.nafmals.com</p>
              <p>Phone Number: 07723571779</p>
            </div>
            <div class="inv-right">
              <div class="inv-logo-top">
                <img src="logo-main.png" alt="Logo">
              </div>
              <div class="inv-logo-title">Invoice</div>
              <div class="meta">
                <div class="meta-row">
                  <span class="label">Invoice No:</span>
                  <input id="f-number">
                </div>
                <div class="meta-row">
                  <span class="label">Invoice Date:</span>
                  <input id="f-date">
                </div>
                <div class="meta-row">
                  <span class="label">Due Date:</span>
                  <input id="f-due">
                </div>
                <div class="meta-row">
                  <span class="label">Contract Number:</span>
                  <input id="f-contract">
                </div>
              </div>
            </div>
          </div>

          <div class="bill-title-row">
            <div style="flex:1;">
              <div class="bill-to-label">Bill To:</div>
              <div class="bill-to-box">
                <textarea id="f-billto" class="bill-to-textarea"></textarea>
              </div>
            </div>
            <div class="center-invoice-title">Invoice</div>
          </div>

          <table class="inv-table">
            <thead>
              <tr>
                <th colspan="7">Description of Services</th>
              </tr>
              <tr>
                <th style="width:24px;">No.</th>
                <th>DESCRIPTION</th>
                <th style="width:90px;">Location</th>
                <th style="width:80px;">DATE</th>
                <th style="width:55px;">UNIT</th>
                <th style="width:50px;">QTY</th>
                <th style="width:110px;">UNIT PRICE / TOTAL PRICE</th>
              </tr>
            </thead>
            <tbody id="items-body"></tbody>
          </table>

          <div class="add-row-bar">
            <button type="button" class="btn-sm" id="add-row-btn">+ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
          </div>

          <div class="thankyou">Thank you for your business!</div>

          <div class="totals-wrap">
            <table class="totals">
              <tr>
                <td>SUBTOTAL</td>
                <td><input id="f-subtotal" readonly></td>
              </tr>
              <tr>
                <td>DISCOUNT</td>
                <td><input id="f-discount" type="number" value="0"></td>
              </tr>
              <tr>
                <td>SUBTOTAL LESS DISCOUNT</td>
                <td><input id="f-sub-less" readonly></td>
              </tr>
              <tr>
                <td>TAX (%)</td>
                <td><input id="f-tax" type="number" value="0"></td>
              </tr>
              <tr>
                <td>SHIPPING/HANDLING</td>
                <td><input id="f-shipping" type="number" value="0"></td>
              </tr>
              <tr>
                <td class="balance">Balance Due</td>
                <td><input id="f-balance" class="balance" readonly></td>
              </tr>
            </table>
          </div>

          <div class="bottom-row">
            <div class="scope-col">
              <div class="scope-label">Scope of Work:</div>
              <textarea id="f-scope" class="scope-textarea"></textarea>
            </div>
            <div class="bank-col">
              <div class="bank-label">Bank Account details</div>
              <table class="bank-table">
                <tr><td>Account Name</td><td>Nafithat Al-Amal</td></tr>
                <tr><td>IBAN Code</td><td>IQ07NISB002000000314765</td></tr>
                <tr><td>Account Number</td><td>314765</td></tr>
                <tr><td>Bank</td><td>National Islamic Bank</td></tr>
                <tr><td>Currency</td><td>Iraqi Dinar</td></tr>
                <tr><td>Branch</td><td>Al-Kadhimiya Branch</td></tr>
              </table>
            </div>
          </div>

          <div class="note-block">
            <div style="font-weight:bold;margin-bottom:3px;">Invoice Notes (Internal):</div>
            <textarea id="f-note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ©ØŒ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©ØŒ Ù…Ø±Ø¬Ø¹ Ø¯ÙØ¹ØŒ Ø±Ù‚Ù… Ø´ÙŠÙƒ ..."></textarea>
          </div>

          <div class="sign-row">
            <div class="sign-name">
              <span>Ayad Kazem</span><br>
              <span>Signature</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
        <button class="btn btn-sm" id="close-modal-btn">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="modal-body">
        <table class="report-table">
          <thead>
            <tr>
              <th>Invoice No</th>
              <th>Date</th>
              <th>Contract</th>
              <th>Status</th>
              <th>Balance (IQD)</th>
            </tr>
          </thead>
          <tbody id="report-body"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø·Ø± Ù„ÙØªØ­ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.
      </div>
    </div>
  </div>

  <script>
    var STORAGE_KEY = "naf_invoice_system_advanced_main";
    var invoices = [];
    var currentId = null;
    var currentFilter = "all";
    var currentPoFilter = "all";
    var specialFilter = "none";

    function $(id){ return document.getElementById(id); }

    function todayStr(){
      return new Date().toISOString().slice(0,10);
    }
    function formatIQD(n){
      n = Number(n)||0;
      return "IQD " + n.toLocaleString("en-US");
    }
    function parseNumber(v){
      if(typeof v!=="string") v=String(v||"");
      return Number(v.replace(/[^\d.-]/g,"")) || 0;
    }

    function createItemRow(data){
      if(!data) data = {};
      var tr = document.createElement("tr");
      tr.className = "item-row";
      tr.innerHTML =
        '<td class="no-cell"></td>' +
        '<td><textarea class="cell-textarea cell-desc">' + (data.desc || "") + '</textarea></td>' +
        '<td><input class="cell-input cell-loc" value="' + (data.location || "") + '"></td>' +
        '<td><input class="cell-input cell-date" value="' + (data.date || "") + '"></td>' +
        '<td><input class="cell-input cell-unit" value="' + (data.unit || "") + '"></td>' +
        '<td><input class="cell-input cell-qty" type="number" min="0" value="' + (data.qty != null ? data.qty : 1) + '"></td>' +
        '<td>' +
          '<input class="cell-input cell-price" type="number" min="0" value="' + (data.price != null ? data.price : 0) + '">' +
          '<br>' +
          '<input class="cell-input cell-total" type="text" readonly>' +
        '</td>';
      var inputs = tr.querySelectorAll(".cell-qty,.cell-price");
      for(var i=0;i<inputs.length;i++){
        inputs[i].addEventListener("input", recalcTotals);
      }
      return tr;
    }

    function updateRowNumbers(){
      var cells = document.querySelectorAll(".item-row .no-cell");
      for(var i=0;i<cells.length;i++){
        cells[i].textContent = i+1;
      }
    }

    function recalcRow(tr){
      var qty   = parseNumber(tr.querySelector(".cell-qty").value);
      var price = parseNumber(tr.querySelector(".cell-price").value);
      var total = qty * price;
      tr.querySelector(".cell-total").value = formatIQD(total);
      return total;
    }

    function recalcTotals(){
      var rows = document.querySelectorAll("#items-body .item-row");
      var subtotal = 0;
      for(var i=0;i<rows.length;i++){
        subtotal += recalcRow(rows[i]);
      }
      var discount = parseNumber($("f-discount").value);
      var taxPerc  = parseNumber($("f-tax").value);
      var shipping = parseNumber($("f-shipping").value);
      var subLess  = subtotal - discount;
      var taxVal   = subLess * (taxPerc/100);
      var balance  = subLess + taxVal + shipping;
      $("f-subtotal").value = formatIQD(subtotal);
      $("f-sub-less").value = formatIQD(subLess);
      $("f-balance").value  = formatIQD(balance);
    }

    function readForm(inv){
      inv.number      = $("f-number").value.trim();
      inv.issueDate   = $("f-date").value.trim();
      inv.dueDate     = $("f-due").value.trim();
      inv.contract    = $("f-contract").value.trim();
      inv.billTo      = $("f-billto").value.trim();
      inv.scope       = $("f-scope").value.trim();
      inv.status      = $("status-select").value;
      inv.note        = $("f-note").value.trim();
      var firstLine   = inv.billTo.split("\n")[0] || "";
      inv.customerName = firstLine;

      var rows = document.querySelectorAll("#items-body .item-row");
      var items = [];
      for(var i=0;i<rows.length;i++){
        var tr = rows[i];
        items.push({
          desc:     tr.querySelector(".cell-desc").value.trim(),
          location: tr.querySelector(".cell-loc").value.trim(),
          date:     tr.querySelector(".cell-date").value.trim(),
          unit:     tr.querySelector(".cell-unit").value.trim(),
          qty:      parseNumber(tr.querySelector(".cell-qty").value),
          price:    parseNumber(tr.querySelector(".cell-price").value)
        });
      }
      inv.items    = items;
      inv.subtotal = parseNumber($("f-subtotal").value);
      inv.discount = parseNumber($("f-discount").value);
      inv.taxPerc  = parseNumber($("f-tax").value);
      inv.shipping = parseNumber($("f-shipping").value);
      inv.balance  = parseNumber($("f-balance").value);
      inv.updatedAt = new Date().toISOString();
    }

    function fillForm(inv){
      $("f-number").value   = inv.number      || "";
      $("f-date").value     = inv.issueDate   || todayStr();
      $("f-due").value      = inv.dueDate     || "";
      $("f-contract").value = inv.contract    || "";
      $("f-billto").value   = inv.billTo      || "";
      $("f-scope").value    = inv.scope       || "";
      $("f-note").value     = inv.note        || "";
      $("status-select").value = inv.status || "draft";

      var body = $("items-body");
      body.innerHTML = "";
      var items = (inv.items && inv.items.length) ? inv.items : [{},{},{},{}];
      for(var i=0;i<items.length;i++){
        body.appendChild(createItemRow(items[i]));
      }
      updateRowNumbers();

      $("f-discount").value = inv.discount != null ? inv.discount : 0;
      $("f-tax").value      = inv.taxPerc  != null ? inv.taxPerc  : 0;
      $("f-shipping").value = inv.shipping != null ? inv.shipping : 0;

      recalcTotals();
      $("editor-subtitle").textContent = inv.number ? "(" + inv.number + ")" : "";
    }

    function loadInvoices(){
      try{
        var raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        var arr = JSON.parse(raw);
        if(arr && arr.length) invoices = arr;
      }catch(e){
        console.error("Error loading invoices:", e);
      }
    }

    function saveInvoices(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
      renderPoFilterOptions();
      renderDashboard();
      renderReport();
    }

    function showDashboard(){
      $("dashboard").style.display = "";
      $("editor").style.display = "none";
    }
    function showEditor(){
      $("dashboard").style.display = "none";
      $("editor").style.display = "";
    }

    function openEditor(id){
      var inv = null;
      for(var i=0;i<invoices.length;i++){
        if(invoices[i].id === id){ inv = invoices[i]; break; }
      }
      if(!inv) return;
      currentId = id;
      fillForm(inv);
      showEditor();
    }

    function isOverdue(inv){
      if(inv.status==="paid") return false;
      if(!inv.dueDate) return false;
      var d = new Date(inv.dueDate);
      var today = new Date(todayStr());
      return d < today;
    }

    function isDueSoon(inv){
      if(inv.status==="paid") return false;
      if(!inv.dueDate) return false;
      var d = new Date(inv.dueDate);
      var today = new Date(todayStr());
      var diff = (d - today)/(1000*60*60*24);
      return diff>=0 && diff<=30;
    }

    function getStatusBadge(status,inv){
      var cls="badge-draft",txt="Ù…Ø³ÙˆØ¯Ø©";
      if(status==="paid"){cls="badge-paid";txt="Ù…Ø¯ÙÙˆØ¹Ø©";}
      else if(status==="unpaid"){
        cls = isOverdue(inv)?"badge-overdue":"badge-unpaid";
        txt = isOverdue(inv)?"Ù…ØªØ£Ø®Ø±Ø©":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©";
      }
      return '<span class="badge ' + cls + '">' + txt + '</span>';
    }

    function renderPoFilterOptions(){
      var select = $("po-filter");
      if(!select) return;
      var current = select.value || "all";
      var set = {};
      var contractsArr = [];
      for(var i=0;i<invoices.length;i++){
        var c = invoices[i].contract;
        if(c && c.trim().length && !set[c]){
          set[c] = true;
          contractsArr.push(c);
        }
      }
      contractsArr.sort();
      var html = '<option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯</option>';
      for(var j=0;j<contractsArr.length;j++){
        html += '<option value="' + contractsArr[j] + '">' + contractsArr[j] + '</option>';
      }
      select.innerHTML = html;
      if(contractsArr.indexOf(current) !== -1) select.value = current; else select.value = "all";
      currentPoFilter = select.value;
    }

    function matchesFilters(inv, searchText){
      if(currentPoFilter!=="all" && (inv.contract||"") !== currentPoFilter) return false;
      if(searchText){
        var hay = [
          inv.number,
          inv.customerName,
          inv.contract,
          inv.billTo,
          inv.scope,
          inv.note
        ].join(" ").toLowerCase();
        if(hay.indexOf(searchText) === -1) return false;
      }
      if(specialFilter === "soon"){
        return isDueSoon(inv);
      }
      if(currentFilter==="paid")   return inv.status==="paid";
      if(currentFilter==="draft")  return inv.status==="draft";
      if(currentFilter==="unpaid") return inv.status==="unpaid";
      return true;
    }

    function deleteInvoiceById(id, ask){
      if(ask && !confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")) return;
      var out = [];
      for(var i=0;i<invoices.length;i++){
        if(invoices[i].id !== id) out.push(invoices[i]);
      }
      invoices = out;
      if(currentId === id) currentId = null;
      saveInvoices();
      showDashboard();
    }

    function renderDashboard(){
      var tbody = $("invoice-table-body");
      if(!tbody) return;
      tbody.innerHTML = "";

      var searchInput = $("search-input");
      var searchText = "";
      if(searchInput && searchInput.value) searchText = searchInput.value.trim().toLowerCase();

      var filtered = [];
      for(var i=0;i<invoices.length;i++){
        if(matchesFilters(invoices[i], searchText)) filtered.push(invoices[i]);
      }

      var total=0,paid=0,unpaid=0,soonAmt=0;
      var countTotal=0,countPaid=0,countUnpaid=0,countSoon=0;

      for(var j=0;j<filtered.length;j++){
        var inv = filtered[j];
        total += inv.balance || 0; countTotal++;
        if(inv.status==="paid"){paid+=inv.balance||0;countPaid++;}
        else if(inv.status==="unpaid"){unpaid+=inv.balance||0;countUnpaid++;}
      }

      for(var k=0;k<invoices.length;k++){
        if(isDueSoon(invoices[k])){soonAmt+=invoices[k].balance||0;countSoon++;}
      }

      if($("card-total-amount")){
        $("card-total-amount").textContent   = formatIQD(total);
        $("card-total-count").textContent    = countTotal + " ÙØ§ØªÙˆØ±Ø©";
        $("card-paid-amount").textContent    = formatIQD(paid);
        $("card-paid-count").textContent     = countPaid + " ÙØ§ØªÙˆØ±Ø©";
        $("card-unpaid-amount").textContent  = formatIQD(unpaid);
        $("card-unpaid-count").textContent   = countUnpaid + " ÙØ§ØªÙˆØ±Ø©";
        $("card-soon-amount").textContent    = formatIQD(soonAmt);
        $("card-soon-count").textContent     = countSoon + " ÙØ§ØªÙˆØ±Ø©";
      }

      filtered.sort(function(a,b){
        return (b.issueDate||"").localeCompare(a.issueDate||"");
      });

      if(!filtered.length){
        tbody.innerHTML = '<tr><td colspan="10" style="font-size:11px;color:#6b7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø¨Ø¹Ø¯ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©" Ø£Ùˆ Ø§Ø³ØªØ±Ø¯ JSON.</td></tr>';
        return;
      }

      for(var m=0;m<filtered.length;m++){
        inv = filtered[m];
        var descSource = inv.scope || (inv.items && inv.items[0] && inv.items[0].desc) || "";
        var shortDesc  = descSource.slice(0,48) + (descSource.length>48?"...":"");
        var noteSnippet = (inv.note||"").slice(0,32) + ((inv.note||"").length>32?"...":"");

        var tr = document.createElement("tr");
        tr.setAttribute("data-id", inv.id);
        tr.innerHTML =
          '<td>' + (inv.issueDate || "") + '</td>' +
          '<td>' + (inv.dueDate || "") + '</td>' +
          '<td>' + (inv.number || "") + '</td>' +
          '<td>' + (inv.contract || "") + '</td>' +
          '<td>' + (inv.customerName || "") + '</td>' +
          '<td>' + shortDesc + '</td>' +
          '<td>' + (noteSnippet || "-") + '</td>' +
          '<td>' + getStatusBadge(inv.status,inv) + '</td>' +
          '<td style="text-align:right;">' + formatIQD(inv.balance || 0) + '</td>' +
          '<td>' +
            '<button class="btn btn-sm edit-btn" data-id="' + inv.id + '">ØªØ¹Ø¯ÙŠÙ„</button>' +
            '<button class="btn btn-sm btn-danger delete-btn" data-id="' + inv.id + '">Ø­Ø°Ù</button>' +
          '</td>';
        tbody.appendChild(tr);
      }
    }

    function renderReport(){
      var tbody = $("report-body");
      if(!tbody) return;
      tbody.innerHTML = "";
      if(!invoices.length){
        tbody.innerHTML = '<tr><td colspan="5" style="font-size:11px;color:#6b7280;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ø¨Ø¹Ø¯.</td></tr>';
        return;
      }
      var sorted = invoices.slice();
      sorted.sort(function(a,b){
        return (b.issueDate||"").localeCompare(a.issueDate||"");
      });
      for(var i=0;i<sorted.length;i++){
        var inv = sorted[i];
        var statusTxt = inv.status==="paid" ? "Ù…Ø¯ÙÙˆØ¹Ø©" :
                        inv.status==="unpaid" ? (isOverdue(inv)?"Ù…ØªØ£Ø®Ø±Ø©":"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©") :
                        "Ù…Ø³ÙˆØ¯Ø©";
        var tr = document.createElement("tr");
        tr.setAttribute("data-id", inv.id);
        tr.innerHTML =
          '<td>' + (inv.number || "") + '</td>' +
          '<td>' + (inv.issueDate || "") + '</td>' +
          '<td>' + (inv.contract || "") + '</td>' +
          '<td>' + statusTxt + '</td>' +
          '<td style="text-align:right;">' + (inv.balance != null ? inv.balance.toLocaleString("en-US") : "") + '</td>';
        tbody.appendChild(tr);
      }
    }

    function openInvoiceSelector(){
      var mb = $("modal-backdrop");
      if(mb) mb.style.display = "flex";
      renderReport();
    }

    function generateId(){
      if(window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
      return String(Date.now()) + "-" + String(Math.random()).slice(2);
    }

    function createNewInvoice(){
      var today = todayStr();
      var id = generateId();
      var inv = {
        id: id,
        number:"INV-"+today.replace(/-/g,""),
        issueDate:today,
        dueDate:today,
        contract: currentPoFilter !== "all" ? currentPoFilter : "",
        billTo:"",
        customerName:"",
        scope:"",
        note:"",
        items:[],
        subtotal:0,
        discount:0,
        taxPerc:0,
        shipping:0,
        balance:0,
        status:"draft",
        createdAt:new Date().toISOString(),
        updatedAt:new Date().toISOString()
      };
      invoices.push(inv);
      currentId = id;
      fillForm(inv);
      saveInvoices();
      showEditor();
    }

    function saveCurrentInvoice(){
      if(!currentId){
        createNewInvoice();
        return;
      }
      var inv = null;
      for(var i=0;i<invoices.length;i++){
        if(invoices[i].id===currentId){ inv = invoices[i]; break; }
      }
      if(!inv) return;
      recalcTotals();
      readForm(inv);
      saveInvoices();
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© âœ…");
    }

    function deleteCurrentInvoice(){
      if(!currentId){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø© Ù…Ø­Ø¯Ø¯Ø© Ù„Ø­Ø°ÙÙ‡Ø§."); return; }
      deleteInvoiceById(currentId, true);
      alert("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© âœ…");
    }

    function duplicateCurrentInvoice(){
      if(!currentId){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø© Ù…ÙØªÙˆØ­Ø© Ù„Ù†Ø³Ø®Ù‡Ø§."); return; }
      var original = null;
      for(var i=0;i<invoices.length;i++){
        if(invoices[i].id===currentId){ original = invoices[i]; break; }
      }
      if(!original) return;
      var id = generateId();
      var copy = JSON.parse(JSON.stringify(original));
      var today = todayStr();
      copy.id = id;
      copy.number = original.number ? original.number + "-COPY" : "INV-"+today.replace(/-/g,"");
      copy.issueDate = today;
      copy.dueDate = today;
      copy.status = "draft";
      copy.createdAt = new Date().toISOString();
      copy.updatedAt = new Date().toISOString();
      invoices.push(copy);
      currentId = id;
      fillForm(copy);
      saveInvoices();
      showEditor();
      alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© âœ…");
    }

    function exportCsv(){
      if(!invoices.length){
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");
        return;
      }
      var header = ["Invoice No","Issue Date","Due Date","Customer","Contract","Status","Balance (IQD)","Note"];
      var lines = [header.join(",")];
      for(var i=0;i<invoices.length;i++){
        var inv = invoices[i];
        var statusTxt = inv.status==="paid" ? "PAID" :
                        inv.status==="unpaid" ? (isOverdue(inv)?"OVERDUE":"UNPAID") :
                        "DRAFT";
        var row = [
          '"' + (inv.number||"").replace(/"/g,'""') + '"',
          '"' + (inv.issueDate||"").replace(/"/g,'""') + '"',
          '"' + (inv.dueDate||"").replace(/"/g,'""') + '"',
          '"' + (inv.customerName||"").replace(/"/g,'""') + '"',
          '"' + (inv.contract||"").replace(/"/g,'""') + '"',
          '"' + statusTxt + '"',
          (inv.balance != null ? inv.balance : 0),
          '"' + (inv.note||"").replace(/"/g,'""') + '"'
        ];
        lines.push(row.join(","));
      }
      var blob = new Blob(["\ufeff"+lines.join("\n")],{type:"text/csv;charset=utf-8"});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "invoices-report.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportJson(){
      var data = JSON.stringify(invoices,null,2);
      var blob = new Blob([data],{type:"application/json"});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "invoices-backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importJsonFromFile(file){
      var reader = new FileReader();
      reader.onload = function(e){
        try{
          var data = JSON.parse(e.target.result);
          if(!data || !data.length){ alert("Ù…Ù„Ù JSON ØºÙŠØ± ØµØ­ÙŠØ­."); return; }
          if(!confirm("Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„ÙØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
          for(var i=0;i<data.length;i++){
            if(!data[i].id) data[i].id = generateId();
          }
          invoices = data;
          currentId = null;
          saveInvoices();
          showDashboard();
          alert("ØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª JSON Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        }catch(err){
          console.error(err);
          alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù JSONØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡.");
        }
      };
      reader.readAsText(file,"utf-8");
    }

    function resetSystem(){
      if(!confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø®Ø²Ù‘Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
      localStorage.removeItem(STORAGE_KEY);
      invoices = [];
      currentId = null;
      saveInvoices();
      showDashboard();
      alert("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù… âœ…");
    }

    function highlightCard(type){
      var cards = document.querySelectorAll(".card[data-type]");
      for(var i=0;i<cards.length;i++){
        cards[i].classList.toggle("card-active", cards[i].getAttribute("data-type") === type);
      }
    }

    function updateActiveStatusPills(){
      var pills = document.querySelectorAll(".status-pill");
      for(var i=0;i<pills.length;i++){
        pills[i].classList.remove("active");
        if(currentFilter === pills[i].getAttribute("data-filter")){
          pills[i].classList.add("active");
        }
        if(currentFilter==="all" && pills[i].getAttribute("data-filter")==="all"){
          pills[i].classList.add("active");
        }
      }
    }

    function setFilterFromCard(type){
      specialFilter = "none";
      if(type === "total"){
        currentFilter = "all";
      }else if(type === "soon"){
        currentFilter = "all";
        specialFilter = "soon";
      }else if(type === "paid"){
        currentFilter = "paid";
      }else if(type === "unpaid"){
        currentFilter = "unpaid";
      }
      highlightCard(type);
      updateActiveStatusPills();
      renderDashboard();
    }

    function setupEvents(){
      var bDash = $("btn-dashboard");
      if(bDash) bDash.addEventListener("click", function(){ showDashboard();highlightCard("total"); });

      var bRep  = $("btn-report");
      if(bRep)  bRep.addEventListener("click", function(){
        var mb = $("modal-backdrop");
        if(mb) mb.style.display = "flex";
        renderReport();
      });

      var bNew = $("btn-new");
      if(bNew) bNew.addEventListener("click", function(e){ e.preventDefault(); createNewInvoice(); });

      var qNew = $("quick-new");
      if(qNew) qNew.addEventListener("click", function(e){ e.preventDefault(); createNewInvoice(); });

      var qEdit = $("quick-edit");
      if(qEdit) qEdit.addEventListener("click", function(e){ e.preventDefault(); openInvoiceSelector(); });

      var bBack = $("btn-back");
      if(bBack) bBack.addEventListener("click", showDashboard);

      var bPr   = $("btn-print");
      if(bPr)   bPr.addEventListener("click", function(){ window.print(); });

      var bSave = $("btn-save");
      if(bSave) bSave.addEventListener("click", saveCurrentInvoice);

      var bDel  = $("btn-delete");
      if(bDel)  bDel.addEventListener("click", deleteCurrentInvoice);

      var bDup  = $("btn-duplicate");
      if(bDup)  bDup.addEventListener("click", duplicateCurrentInvoice);

      var bExp  = $("btn-export");
      if(bExp)  bExp.addEventListener("click", exportCsv);

      var bSJ   = $("btn-save-json");
      if(bSJ)   bSJ.addEventListener("click", exportJson);

      var bLJ   = $("btn-load-json");
      if(bLJ)   bLJ.addEventListener("click", function(){
        var fi = $("json-file-input");
        if(fi) fi.click();
      });

      var bRes  = $("btn-reset");
      if(bRes)  bRes.addEventListener("click", resetSystem);

      var fileInput = $("json-file-input");
      if(fileInput) fileInput.addEventListener("change", function(e){
        var file = e.target.files[0];
        if(file) importJsonFromFile(file);
        e.target.value = "";
      });

      var cModal = $("close-modal-btn");
      if(cModal) cModal.addEventListener("click", function(){
        var mb = $("modal-backdrop");
        if(mb) mb.style.display="none";
      });

      document.addEventListener("keydown", function(e){
        if(e.key==="Escape"){
          var mb = $("modal-backdrop");
          if(mb) mb.style.display="none";
        }
      });

      // ØªÙÙˆÙŠØ¶ Ø£Ø­Ø¯Ø§Ø« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± (ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù / ÙØªØ­ Ù…Ù† Ø§Ù„ØµÙ)
      var tbody = $("invoice-table-body");
      if(tbody){
        tbody.addEventListener("click", function(e){
          var target = e.target;
          if(target.classList.contains("edit-btn")){
            e.stopPropagation();
            var id = target.getAttribute("data-id");
            openEditor(id);
          }else if(target.classList.contains("delete-btn")){
            e.stopPropagation();
            var id = target.getAttribute("data-id");
            deleteInvoiceById(id, true);
          }else{
            var tr = target.closest("tr[data-id]");
            if(tr){
              var idRow = tr.getAttribute("data-id");
              openEditor(idRow);
            }
          }
        });
      }

      // ØªÙÙˆÙŠØ¶ Ø£Ø­Ø¯Ø§Ø« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ Modal
      var reportBody = $("report-body");
      if(reportBody){
        reportBody.addEventListener("click", function(e){
          var tr = e.target.closest("tr[data-id]");
          if(!tr) return;
          var id = tr.getAttribute("data-id");
          var mb = $("modal-backdrop");
          if(mb) mb.style.display = "none";
          openEditor(id);
        });
      }

      var pills = document.querySelectorAll(".status-pill");
      for(var i=0;i<pills.length;i++){
        (function(btn){
          btn.addEventListener("click", function(){
            for(var j=0;j<pills.length;j++) pills[j].classList.remove("active");
            btn.classList.add("active");
            currentFilter = btn.getAttribute("data-filter");
            specialFilter = "none";
            highlightCard("total");
            renderDashboard();
          });
        })(pills[i]);
      }

      var sInput = $("search-input");
      if(sInput) sInput.addEventListener("input", renderDashboard);

      var sSel   = $("status-select");
      if(sSel) sSel.addEventListener("change", function(){
        if(!currentId) return;
        var inv = null;
        for(var i=0;i<invoices.length;i++){
          if(invoices[i].id===currentId){ inv = invoices[i]; break; }
        }
        if(!inv) return;
        inv.status = sSel.value;
        saveInvoices();
      });

      var ids = ["f-discount","f-tax","f-shipping"];
      for(var k=0;k<ids.length;k++){
        var el = $(ids[k]);
        if(el) el.addEventListener("input", recalcTotals);
      }

      var addRowBtn = $("add-row-btn");
      if(addRowBtn) addRowBtn.addEventListener("click", function(){
        $("items-body").appendChild(createItemRow({qty:1,price:0}));
        updateRowNumbers();
        recalcTotals();
      });

      var poFilter = $("po-filter");
      if(poFilter) poFilter.addEventListener("change", function(){
        currentPoFilter = poFilter.value;
        renderDashboard();
      });

      var cardsMap = [
        ["card-total","total"],
        ["card-soon","soon"],
        ["card-paid","paid"],
        ["card-unpaid","unpaid"]
      ];
      for(var c=0;c<cardsMap.length;c++){
        (function(mapItem){
          var el = $(mapItem[0]);
          var type = mapItem[1];
          if(el) el.addEventListener("click", function(){ setFilterFromCard(type); });
        })(cardsMap[c]);
      }
    }

    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¥ØªØ§Ø­Ø© Ø¨Ø¹Ø¶ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙÙŠ window â€“ Ù„ÙŠØ³ Ø¶Ø±ÙˆØ±ÙŠÙ‹Ø§ Ø§Ù„Ø¢Ù† Ù„ÙƒÙ† Ù„Ø§ ÙŠØ¶Ø±
    window.createNewInvoice   = createNewInvoice;
    window.openInvoiceSelector= openInvoiceSelector;

    window.addEventListener("DOMContentLoaded", function(){
      setupEvents();
      loadInvoices();
      renderPoFilterOptions();
      showDashboard();
      highlightCard("total");
      renderDashboard();
      renderReport();
    });
  </script>
</body>
</html>
