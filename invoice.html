<script>
/* ================== CONSTANTS ================== */
const STORAGE_KEY = "naf_advanced_invoice_local";
const THEME_KEY   = "naf_invoice_theme";

/* ================== STATE ================== */
let invoices = [];
let currentId = null;
let currentFilter = "all";
let currentPoFilter = "all";
let searchTerm = "";
let dateFrom = "";
let dateTo   = "";
let specialFilter = "none";
let sortField = "issueDate";
let sortDir   = "asc";

/* ================== HELPERS ================== */
function $(id){ return document.getElementById(id); }
function todayStr(){ return new Date().toISOString().slice(0,10); }
function generateId(){ return "inv-"+Math.random().toString(36).slice(2)+"-"+Date.now().toString(36); }
function formatIQD(n){ return "IQD "+(Number(n)||0).toLocaleString("en-US",{maximumFractionDigits:0}); }
function parseNumber(v){ return Number(String(v||"").replace(/[^\d.-]/g,""))||0; }

function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

function toDateOrNull(v){
  if(!v) return null;
  const d=new Date(v);
  return isNaN(d)?null:d;
}

/* ================== INVOICE CORE ================== */
function normalizeInvoice(inv){
  inv.id ||= generateId();
  inv.status = ["paid","unpaid","draft"].includes(inv.status) ? inv.status : "draft";
  inv.items ||= [];
  return inv;
}

/* ================== LOAD / SAVE ================== */
function loadInvoices(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    invoices = raw ? JSON.parse(raw).map(normalizeInvoice) : [];
  }catch{ invoices=[]; }
}

function saveInvoices(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify(invoices));
  renderPoFilterOptions();
  renderDashboard();
  renderReport();
}

/* ================== STATUS HELPERS ================== */
function isOverdue(inv){
  if(inv.status==="paid"||!inv.dueDate) return false;
  return new Date(inv.dueDate)<new Date(todayStr());
}
function isDueSoon(inv){
  if(inv.status==="paid"||!inv.dueDate) return false;
  const d=new Date(inv.dueDate);
  const diff=(d-new Date(todayStr()))/(86400000);
  return diff>=0&&diff<=30;
}
function badge(inv){
  if(inv.status==="paid") return `<span class="badge badge-paid">Paid</span>`;
  if(inv.status==="unpaid"&&isOverdue(inv)) return `<span class="badge badge-overdue">Overdue</span>`;
  if(inv.status==="unpaid") return `<span class="badge badge-unpaid">Unpaid</span>`;
  return `<span class="badge badge-draft">Draft</span>`;
}

/* ================== FILTER ================== */
function matches(inv){
  if(currentPoFilter!=="all" && inv.contract!==currentPoFilter) return false;
  if(currentFilter!=="all" && inv.status!==currentFilter) return false;
  if(specialFilter==="due-soon" && !isDueSoon(inv)) return false;

  if(searchTerm){
    const h=(inv.number+inv.contract+inv.customerName+inv.scope).toLowerCase();
    if(!h.includes(searchTerm)) return false;
  }

  if(dateFrom||dateTo){
    const d=toDateOrNull(inv.issueDate);
    if(!d) return false;
    if(dateFrom && d<toDateOrNull(dateFrom)) return false;
    if(dateTo){
      const t=toDateOrNull(dateTo); t.setHours(23,59,59,999);
      if(d>t) return false;
    }
  }
  return true;
}

/* ================== RENDER DASHBOARD ================== */
function renderDashboard(){
  const body=$("invoice-table-body");
  if(!body) return;
  body.innerHTML="";

  const list=invoices.filter(matches).sort((a,b)=>{
    return sortDir==="asc"
      ? (a[sortField]||"").localeCompare(b[sortField]||"")
      : (b[sortField]||"").localeCompare(a[sortField]||"");
  });

  let total=0,paid=0,unpaid=0,due=0;

  list.forEach(inv=>{
    const bal=inv.balance||0;
    total+=bal;
    if(inv.status==="paid") paid+=bal;
    if(inv.status==="unpaid") unpaid+=bal;
    if(isDueSoon(inv)) due+=bal;

    const scope=inv.scope||"-";
    body.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${escapeHtml(inv.issueDate||"")}</td>
        <td>${escapeHtml(inv.dueDate||"")}</td>
        <td>${escapeHtml(inv.number||"")}</td>
        <td>${escapeHtml(inv.contract||"")}</td>
        <td>${escapeHtml(inv.customerName||"")}</td>
        <td class="col-short" title="${escapeHtml(scope)}">
          ${escapeHtml(scope.length>120?scope.slice(0,120)+"â€¦":scope)}
        </td>
        <td>${badge(inv)}</td>
        <td>${formatIQD(bal)}</td>
        <td>
          <button class="table-btn edit" onclick="editInvoice('${inv.id}')">Edit</button>
          <button class="table-btn del" onclick="deleteInvoiceById('${inv.id}')">Delete</button>
        </td>
      </tr>
    `);
  });

  $("dash-total-amount").textContent=formatIQD(total);
  $("dash-paid-amount").textContent=formatIQD(paid);
  $("dash-unpaid-amount").textContent=formatIQD(unpaid);
  $("dash-due-amount").textContent=formatIQD(due);
}

/* ================== REPORT ================== */
function renderReport(){
  const body=$("report-body");
  if(!body) return;
  body.innerHTML="";
  invoices.forEach(i=>{
    body.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${escapeHtml(i.number||"")}</td>
        <td>${escapeHtml(i.contract||"")}</td>
        <td>${escapeHtml(i.issueDate||"")}</td>
        <td>${escapeHtml(i.dueDate||"")}</td>
        <td>${escapeHtml(i.status||"")}</td>
        <td>${formatIQD(i.balance||0)}</td>
      </tr>
    `);
  });
}

/* ================== EVENTS (SAFE) ================== */
function setupEvents(){
  const on=(id,ev,fn)=>{ const el=$(id); if(el) el.addEventListener(ev,fn); };

  on("search-input","input",e=>{searchTerm=e.target.value.toLowerCase();renderDashboard();});
  on("po-filter","change",e=>{currentPoFilter=e.target.value;renderDashboard();});
  on("date-from","change",e=>{dateFrom=e.target.value;renderDashboard();});
  on("date-to","change",e=>{dateTo=e.target.value;renderDashboard();});

  document.querySelectorAll(".status-pill").forEach(b=>{
    b.addEventListener("click",()=>{
      currentFilter=b.dataset.filter;
      specialFilter="none";
      renderDashboard();
    });
  });

  document.querySelectorAll(".stat-card").forEach(c=>{
    c.addEventListener("click",()=>{
      specialFilter=c.dataset.type==="due-soon"?"due-soon":"none";
      currentFilter=c.dataset.type==="paid"?"paid":c.dataset.type==="unpaid"?"unpaid":"all";
      renderDashboard();
    });
  });
}

/* ================== INIT ================== */
function init(){
  loadInvoices();
  setupEvents();
  renderDashboard();
  renderReport();
}

document.readyState==="loading"
  ? document.addEventListener("DOMContentLoaded",init)
  : init();
</script>
