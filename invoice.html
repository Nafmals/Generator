<script>
  const STORAGE_KEY = "naf_invoice_system_advanced_main";
  let invoices = [];
  let currentId = null;
  let currentFilter = "all";
  let currentPoFilter = "all";
  let specialFilter = "none";
  const $ = id => document.getElementById(id);

  function todayStr(){ return new Date().toISOString().slice(0,10); }
  function formatIQD(n){ n = Number(n)||0; return "IQD " + n.toLocaleString("en-US"); }
  function parseNumber(v){ if(typeof v!=="string") v=String(v||""); return Number(v.replace(/[^\d.-]/g,"")) || 0; }

  function createItemRow(data={}){
    const tr = document.createElement("tr");
    tr.className = "item-row";
    tr.innerHTML = `
      <td class="no-cell"></td>
      <td><textarea class="cell-textarea cell-desc">${data.desc || ""}</textarea></td>
      <td><input class="cell-input cell-loc" value="${data.location || ""}"></td>
      <td><input class="cell-input cell-date" value="${data.date || ""}"></td>
      <td><input class="cell-input cell-unit" value="${data.unit || ""}"></td>
      <td><input class="cell-input cell-qty" type="number" min="0" value="${data.qty != null ? data.qty : 1}"></td>
      <td>
        <input class="cell-input cell-price" type="number" min="0" value="${data.price != null ? data.price : 0}">
        <br>
        <input class="cell-input cell-total" type="text" readonly>
      </td>`;
    tr.querySelectorAll(".cell-qty,.cell-price").forEach(inp=>{
      inp.addEventListener("input", recalcTotals);
    });
    return tr;
  }

  function updateRowNumbers(){
    document.querySelectorAll(".item-row .no-cell").forEach((td,i)=>{ td.textContent = i+1; });
  }

  function recalcRow(tr){
    const qty = parseNumber(tr.querySelector(".cell-qty").value);
    const price = parseNumber(tr.querySelector(".cell-price").value);
    const total = qty * price;
    tr.querySelector(".cell-total").value = formatIQD(total);
    return total;
  }

  function recalcTotals(){
    const rows = document.querySelectorAll("#items-body .item-row");
    let subtotal = 0;
    rows.forEach(tr => subtotal += recalcRow(tr));
    const discount = parseNumber($("f-discount").value);
    const taxPerc  = parseNumber($("f-tax").value);
    const shipping = parseNumber($("f-shipping").value);
    const subLess = subtotal - discount;
    const taxVal  = subLess * (taxPerc/100);
    const balance = subLess + taxVal + shipping;
    $("f-subtotal").value = formatIQD(subtotal);
    $("f-sub-less").value = formatIQD(subLess);
    $("f-balance").value  = formatIQD(balance);
  }

  function readForm(inv){
    inv.number      = $("f-number").value.trim();
    inv.issueDate   = $("f-date").value.trim();
    inv.dueDate     = $("f-due").value.trim();
    inv.contract    = $("f-contract").value.trim();
    inv.billTo      = $("f-billto").value.trim();
    inv.scope       = $("f-scope").value.trim();
    inv.status      = $("status-select").value;
    inv.note        = $("f-note").value.trim();
    const firstLine = inv.billTo.split("\n")[0] || "";
    inv.customerName = firstLine;

    const rows = document.querySelectorAll("#items-body .item-row");
    inv.items = Array.from(rows).map(tr=>({
      desc:     tr.querySelector(".cell-desc").value.trim(),
      location: tr.querySelector(".cell-loc").value.trim(),
      date:     tr.querySelector(".cell-date").value.trim(),
      unit:     tr.querySelector(".cell-unit").value.trim(),
      qty:      parseNumber(tr.querySelector(".cell-qty").value),
      price:    parseNumber(tr.querySelector(".cell-price").value),
    }));

    inv.subtotal = parseNumber($("f-subtotal").value);
    inv.discount = parseNumber($("f-discount").value);
    inv.taxPerc  = parseNumber($("f-tax").value);
    inv.shipping = parseNumber($("f-shipping").value);
    inv.balance  = parseNumber($("f-balance").value);
    inv.updatedAt = new Date().toISOString();
  }

  function fillForm(inv){
    $("f-number").value   = inv.number      || "";
    $("f-date").value     = inv.issueDate   || todayStr();
    $("f-due").value      = inv.dueDate     || "";
    $("f-contract").value = inv.contract    || "";
    $("f-billto").value   = inv.billTo      || "";
    $("f-scope").value    = inv.scope       || "";
    $("f-note").value     = inv.note        || "";
    $("status-select").value = inv.status || "draft";

    $("items-body").innerHTML = "";
    const items = inv.items && inv.items.length ? inv.items : [{},{},{},{}];
    items.forEach(it => $("items-body").appendChild(createItemRow(it)));
    updateRowNumbers();

    $("f-discount").value = inv.discount != null ? inv.discount : 0;
    $("f-tax").value      = inv.taxPerc  != null ? inv.taxPerc  : 0;
    $("f-shipping").value = inv.shipping != null ? inv.shipping : 0;

    recalcTotals();
    $("editor-subtitle").textContent = inv.number ? `(${inv.number})` : "";
  }

  function loadInvoices(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const arr = JSON.parse(raw);
      if(Array.isArray(arr)) invoices = arr;
    }catch(e){ console.error("Error loading invoices:", e); }
  }

  function saveInvoices(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
    renderPoFilterOptions();
    renderDashboard();
    renderReport();
  }

  function showDashboard(){
    $("dashboard").style.display = "";
    $("editor").style.display = "none";
  }
  function showEditor(){
    $("dashboard").style.display = "none";
    $("editor").style.display = "";
  }

  function openEditor(id){
    const inv = invoices.find(i=>i.id===id);
    if(!inv) return;
    currentId = id;
    fillForm(inv);
    showEditor();
  }

  function isOverdue(inv){
    if(inv.status==="paid") return false;
    if(!inv.dueDate) return false;
    const d = new Date(inv.dueDate);
    const today = new Date(todayStr());
    return d < today;
  }

  function isDueSoon(inv){
    if(inv.status==="paid") return false;
    if(!inv.dueDate) return false;
    const d = new Date(inv.dueDate);
    const today = new Date(todayStr());
    const diff = (d - today)/(1000*60*60*24);
    return diff>=0 && diff<=30;
  }

  function getStatusBadge(status,inv){
    let cls="badge-draft",txt="مسودة";
    if(status==="paid"){cls="badge-paid";txt="مدفوعة";}
    else if(status==="unpaid"){
      cls = isOverdue(inv)?"badge-overdue":"badge-unpaid";
      txt = isOverdue(inv)?"متأخرة":"غير مدفوعة";
    }
    return `<span class="badge ${cls}">${txt}</span>`;
  }

  function renderPoFilterOptions(){
    const select = $("po-filter");
    if(!select) return;
    const current = select.value || "all";
    const contracts = Array.from(new Set(invoices
      .map(inv=>inv.contract)
      .filter(c=>c && c.trim().length)))
      .sort();
    select.innerHTML = `<option value="all">كل العقود</option>` +
      contracts.map(c=>`<option value="${c}">${c}</option>`).join("");
    if(contracts.includes(current)) select.value = current; else select.value = "all";
    currentPoFilter = select.value;
  }

  function matchesFilters(inv, searchText){
    if(currentPoFilter!=="all" && (inv.contract||"") !== currentPoFilter) return false;
    if(searchText){
      const hay = [inv.number,inv.customerName,inv.contract,inv.billTo,inv.scope,inv.note].join(" ").toLowerCase();
      if(!hay.includes(searchText)) return false;
    }
    if(specialFilter === "soon"){
      return isDueSoon(inv);
    }
    if(currentFilter==="paid")   return inv.status==="paid";
    if(currentFilter==="draft")  return inv.status==="draft";
    if(currentFilter==="unpaid") return inv.status==="unpaid";
    return true;
  }

  function editInvoice(id){ openEditor(id); }

  function deleteInvoiceById(id, ask){
    if(ask && !confirm("هل أنت متأكد من حذف هذه الفاتورة؟ لا يمكن التراجع.")) return;
    invoices = invoices.filter(inv => inv.id !== id);
    if(currentId === id) currentId = null;
    saveInvoices();
    showDashboard();
  }

  function renderDashboard(){
    const tbody = $("invoice-table-body");
    if(!tbody) return;
    tbody.innerHTML = "";
    const searchText = ($("search-input")?.value || "").trim().toLowerCase();
    const filtered = invoices.filter(inv => matchesFilters(inv, searchText));

    let total=0,paid=0,unpaid=0,soonAmt=0;
    let countTotal=0,countPaid=0,countUnpaid=0,countSoon=0;

    filtered.forEach(inv=>{
      total += inv.balance || 0; countTotal++;
      if(inv.status==="paid"){paid+=inv.balance||0;countPaid++;}
      else if(inv.status==="unpaid"){unpaid+=inv.balance||0;countUnpaid++;}
    });

    invoices.forEach(inv=>{
      if(isDueSoon(inv)){soonAmt+=inv.balance||0;countSoon++;}
    });

    if($("card-total-amount")){
      $("card-total-amount").textContent   = formatIQD(total);
      $("card-total-count").textContent    = countTotal + " فاتورة";
      $("card-paid-amount").textContent    = formatIQD(paid);
      $("card-paid-count").textContent     = countPaid + " فاتورة";
      $("card-unpaid-amount").textContent  = formatIQD(unpaid);
      $("card-unpaid-count").textContent   = countUnpaid + " فاتورة";
      $("card-soon-amount").textContent    = formatIQD(soonAmt);
      $("card-soon-count").textContent     = countSoon + " فاتورة";
    }

    const sorted = filtered.slice().sort((a,b)=>(b.issueDate||"").localeCompare(a.issueDate||""));
    if(!sorted.length){
      tbody.innerHTML = `<tr><td colspan="10" style="font-size:11px;color:#6b7280;">لا توجد فواتير بعد، اضغط على زر "فاتورة جديدة" أو استرد JSON.</td></tr>`;
      return;
    }

    sorted.forEach(inv=>{
      const descSource = inv.scope || (inv.items && inv.items[0] && inv.items[0].desc) || "";
      const shortDesc  = descSource.slice(0,48) + (descSource.length>48?"...":"");
      const noteSnippet = (inv.note||"").slice(0,32) + ((inv.note||"").length>32?"...":"");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${inv.issueDate || ""}</td>
        <td>${inv.dueDate || ""}</td>
        <td>${inv.number || ""}</td>
        <td>${inv.contract || ""}</td>
        <td>${inv.customerName || ""}</td>
        <td>${shortDesc}</td>
        <td>${noteSnippet || "-"}</td>
        <td>${getStatusBadge(inv.status,inv)}</td>
        <td style="text-align:right;">${formatIQD(inv.balance || 0)}</td>
        <td>
          <button class="btn btn-sm" onclick="event.stopPropagation(); editInvoice('${inv.id}')">تعديل</button>
          <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteInvoiceById('${inv.id}', true)">حذف</button>
        </td>`;
      tr.addEventListener("click", ()=>openEditor(inv.id));
      tbody.appendChild(tr);
    });
  }

  function renderReport(){
    const tbody = $("report-body");
    if(!tbody) return;
    tbody.innerHTML = "";
    if(!invoices.length){
      tbody.innerHTML = `<tr><td colspan="5" style="font-size:11px;color:#6b7280;">لا توجد فواتير بعد.</td></tr>`;
      return;
    }
    invoices.slice().sort((a,b)=>(b.issueDate||"").localeCompare(a.issueDate||""))
      .forEach(inv=>{
        const statusTxt = inv.status==="paid" ? "مدفوعة" :
                          inv.status==="unpaid" ? (isOverdue(inv)?"متأخرة":"غير مدفوعة") :
                          "مسودة";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${inv.number || ""}</td>
          <td>${inv.issueDate || ""}</td>
          <td>${inv.contract || ""}</td>
          <td>${statusTxt}</td>
          <td style="text-align:right;">${inv.balance != null ? inv.balance.toLocaleString("en-US") : ""}</td>`;
        tr.addEventListener("click", ()=>{
          if($("modal-backdrop")) $("modal-backdrop").style.display = "none";
          openEditor(inv.id);
        });
        tbody.appendChild(tr);
      });
  }

  function generateId(){
    if(window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return String(Date.now()) + "-" + String(Math.random()).slice(2);
  }

  function createNewInvoice(){
    const today = todayStr();
    const id = generateId();
    const inv = {
      id,
      number:"INV-"+today.replace(/-/g,""),
      issueDate:today,
      dueDate:today,
      contract: currentPoFilter !== "all" ? currentPoFilter : "",
      billTo:"",
      customerName:"",
      scope:"",
      note:"",
      items:[],
      subtotal:0,
      discount:0,
      taxPerc:0,
      shipping:0,
      balance:0,
      status:"draft",
      createdAt:new Date().toISOString(),
      updatedAt:new Date().toISOString()
    };
    invoices.push(inv);
    currentId = id;
    fillForm(inv);
    saveInvoices();
    showEditor();
  }

  function saveCurrentInvoice(){
    if(!currentId){
      createNewInvoice();
      return;
    }
    const inv = invoices.find(i=>i.id===currentId);
    if(!inv) return;
    recalcTotals();
    readForm(inv);
    saveInvoices();
    alert("تم حفظ الفاتورة ✅");
  }

  function deleteCurrentInvoice(){
    if(!currentId){ alert("لا توجد فاتورة محددة لحذفها."); return; }
    deleteInvoiceById(currentId, true);
    alert("تم حذف الفاتورة ✅");
  }

  function duplicateCurrentInvoice(){
    if(!currentId){ alert("لا توجد فاتورة مفتوحة لنسخها."); return; }
    const original = invoices.find(i=>i.id===currentId);
    if(!original) return;
    const id = generateId();
    const copy = JSON.parse(JSON.stringify(original));
    const today = todayStr();
    copy.id = id;
    copy.number = original.number ? original.number + "-COPY" : "INV-"+today.replace(/-/g,"");
    copy.issueDate = today;
    copy.dueDate = today;
    copy.status = "draft";
    copy.createdAt = new Date().toISOString();
    copy.updatedAt = new Date().toISOString();
    invoices.push(copy);
    currentId = id;
    fillForm(copy);
    saveInvoices();
    showEditor();
    alert("تم إنشاء نسخة من الفاتورة ✅");
  }

  function exportCsv(){
    if(!invoices.length){ alert("لا توجد فواتير لتصديرها."); return; }
    const header = ["Invoice No","Issue Date","Due Date","Customer","Contract","Status","Balance (IQD)","Note"];
    const lines = [header.join(",")];
    invoices.forEach(inv=>{
      const statusTxt = inv.status==="paid" ? "PAID" :
                        inv.status==="unpaid" ? (isOverdue(inv)?"OVERDUE":"UNPAID") :
                        "DRAFT";
      const row = [
        `"${(inv.number||"").replace(/"/g,'""')}"`,
        `"${(inv.issueDate||"").replace(/"/g,'""')}"`,
        `"${(inv.dueDate||"").replace(/"/g,'""')}"`,
        `"${(inv.customerName||"").replace(/"/g,'""')}"`,
        `"${(inv.contract||"").replace(/"/g,'""')}"`,
        `"${statusTxt}"`,
        inv.balance != null ? inv.balance : 0,
        `"${(inv.note||"").replace(/"/g,'""')}"`
      ];
      lines.push(row.join(","));
    });
    const blob = new Blob(["\ufeff"+lines.join("\n")],{type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "invoices-report.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function exportJson(){
    const data = JSON.stringify(invoices,null,2);
    const blob = new Blob([data],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "invoices-backup.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function importJsonFromFile(file){
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const data = JSON.parse(e.target.result);
        if(!Array.isArray(data)){ alert("ملف JSON غير صحيح."); return; }
        if(!confirm("سيتم استبدال جميع الفواتير الحالية بالبيانات من الملف، هل أنت متأكد؟")) return;
        data.forEach(inv=>{ if(!inv.id) inv.id = generateId(); });
        invoices = data;
        currentId = null;
        saveInvoices();
        showDashboard();
        alert("تم استرداد بيانات JSON بنجاح ✅");
      }catch(err){
        console.error(err);
        alert("تعذر قراءة ملف JSON، تأكد من صحته.");
      }
    };
    reader.readAsText(file,"utf-8");
  }

  function resetSystem(){
    if(!confirm("سيتم حذف كل الفواتير المخزّنة محليًا، هل أنت متأكد؟")) return;
    localStorage.removeItem(STORAGE_KEY);
    invoices = [];
    currentId = null;
    saveInvoices();
    showDashboard();
    alert("تمت إعادة ضبط النظام ✅");
  }

  function highlightCard(type){
    document.querySelectorAll(".card[data-type]").forEach(c=>{
      c.classList.toggle("card-active", c.dataset.type === type);
    });
  }

  function updateActiveStatusPills(){
    document.querySelectorAll(".status-pill").forEach(b=>{
      b.classList.remove("active");
      if(currentFilter === b.dataset.filter){
        b.classList.add("active");
      }
      if(currentFilter==="all" && b.dataset.filter==="all"){
        b.classList.add("active");
      }
    });
  }

  function setFilterFromCard(type){
    specialFilter = "none";
    if(type === "total"){
      currentFilter = "all";
    }else if(type === "soon"){
      currentFilter = "all";
      specialFilter = "soon";
    }else if(type === "paid"){
      currentFilter = "paid";
    }else if(type === "unpaid"){
      currentFilter = "unpaid";
    }
    highlightCard(type);
    updateActiveStatusPills();
    renderDashboard();
  }

  function setupEvents(){
    const bDash = $("btn-dashboard"); if(bDash) bDash.addEventListener("click", ()=>{showDashboard();highlightCard("total");});
    const bRep  = $("btn-report");    if(bRep)  bRep.addEventListener("click", ()=>{const mb=$("modal-backdrop");if(mb)mb.style.display="flex";renderReport();});
    const bBack = $("btn-back");      if(bBack) bBack.addEventListener("click", showDashboard);
    const bPr   = $("btn-print");     if(bPr)   bPr.addEventListener("click", ()=>window.print());
    const bSave = $("btn-save");      if(bSave) bSave.addEventListener("click", saveCurrentInvoice);
    const bDel  = $("btn-delete");    if(bDel)  bDel.addEventListener("click", deleteCurrentInvoice);
    const bDup  = $("btn-duplicate"); if(bDup)  bDup.addEventListener("click", duplicateCurrentInvoice);
    const bExp  = $("btn-export");    if(bExp)  bExp.addEventListener("click", exportCsv);
    const bSJ   = $("btn-save-json"); if(bSJ)   bSJ.addEventListener("click", exportJson);
    const bLJ   = $("btn-load-json"); if(bLJ)   bLJ.addEventListener("click", ()=>$("json-file-input")?.click());
    const bRes  = $("btn-reset");     if(bRes)  bRes.addEventListener("click", resetSystem);

    const fileInput = $("json-file-input");
    if(fileInput) fileInput.addEventListener("change", e=>{
      const file = e.target.files[0];
      if(file) importJsonFromFile(file);
      e.target.value = "";
    });

    const cModal = $("close-modal-btn");
    if(cModal) cModal.addEventListener("click", ()=>{const mb=$("modal-backdrop");if(mb)mb.style.display="none";});
    document.addEventListener("keydown", e=>{ if(e.key==="Escape"){const mb=$("modal-backdrop");if(mb)mb.style.display="none";} });

    document.querySelectorAll(".status-pill").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".status-pill").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.dataset.filter;
        specialFilter = "none";
        highlightCard("total");
        renderDashboard();
      });
    });

    const sInput = $("search-input"); if(sInput) sInput.addEventListener("input", renderDashboard);
    const sSel   = $("status-select"); if(sSel) sSel.addEventListener("change", ()=>{
      if(!currentId) return;
      const inv = invoices.find(i=>i.id===currentId);
      if(!inv) return;
      inv.status = sSel.value;
      saveInvoices();
    });

    ["f-discount","f-tax","f-shipping"].forEach(id=>{
      const el = $(id); if(el) el.addEventListener("input", recalcTotals);
    });

    const addRowBtn = $("add-row-btn");
    if(addRowBtn) addRowBtn.addEventListener("click", ()=>{
      $("items-body").appendChild(createItemRow({qty:1,price:0}));
      updateRowNumbers();
      recalcTotals();
    });

    const poFilter = $("po-filter");
    if(poFilter) poFilter.addEventListener("change", ()=>{ currentPoFilter = poFilter.value; renderDashboard(); });

    [["card-total","total"],["card-soon","soon"],["card-paid","paid"],["card-unpaid","unpaid"]]
      .forEach(([id,type])=>{
        const el = $(id);
        if(el) el.addEventListener("click", ()=>setFilterFromCard(type));
      });
  }

  // جعل الدوال متاحة للـ onclick حتى لو فشل أي شيء آخر
  window.createNewInvoice = createNewInvoice;
  window.editInvoice      = editInvoice;
  window.deleteInvoiceById= deleteInvoiceById;

  (function init(){
    setupEvents();
    loadInvoices();
    renderPoFilterOptions();
    showDashboard();
    highlightCard("total");
    renderDashboard();
    renderReport();
  })();
</script>
